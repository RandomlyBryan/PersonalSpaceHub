<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PersonalSpace - Team Project Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/dark.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-analytics-compat.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: { jokerPurple: "#3c096c", jokerGreen: "#39ff14" }
                }
            }
        }
    </script>

    <style>
        body { background: linear-gradient(135deg, #9d4edd, #70e000); min-height: 100vh; transition: background 0.5s ease; overflow: hidden; font-family: 'Inter', sans-serif; }
        .dark body { background: linear-gradient(135deg, #10002b, #004b23); }
        .glass-panel { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(12px); border: 1px solid rgba(157, 78, 221, 0.3); box-shadow: 0 8px 32px 0 rgba(60, 9, 108, 0.2); }
        .dark .glass-panel { background: rgba(20, 10, 40, 0.85); color: #e2e8f0; border: 1px solid rgba(57, 255, 20, 0.1); }
        .sidebar { background: rgba(36, 0, 70, 0.7); backdrop-filter: blur(20px); border-right: 1px solid rgba(255,255,255,0.1); }
        .dark .sidebar { background: rgba(10, 0, 20, 0.8); }
        .nav-item.active { background: rgba(255, 255, 255, 0.1); border-left: 4px solid #39ff14; color: #39ff14; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); border-top: 1px solid #e2e8f0; border-left: 1px solid #e2e8f0; }
        .calendar-day { min-height: 80px; max-height: 110px; overflow-y: auto; padding: 4px; border-right: 1px solid #e2e8f0; border-bottom: 1px solid #e2e8f0; background: rgba(255,255,255,0.4); cursor: pointer; transition: 0.2s; }
        .calendar-day:hover { background: rgba(57, 255, 20, 0.15); }
        .calendar-day.today { background: #3c096c; color: #39ff14; font-weight: bold; }
        .cal-event-item { font-size: 0.65rem; padding: 3px; border-radius: 3px; margin-top: 2px; border-left: 3px solid #ccc; background: rgba(255, 255, 255, 0.6); color: #334155; }
        .cal-urgency-low { border-left-color: #39ff14 !important; }
        .cal-urgency-medium { border-left-color: #9d4edd !important; }
        .cal-urgency-high { border-left-color: #ef4444 !important; }
        .avatar-container:hover .avatar-overlay { opacity: 1; }
        .admin-only.hidden-tool { display: none !important; }
        #login-overlay { background: #10002b; z-index: 200; }
    </style>
</head>
<body class="text-slate-800 antialiased flex flex-col h-screen w-screen overflow-hidden">

    <div id="login-overlay" class="fixed inset-0 flex items-center justify-center transition-opacity duration-500">
        <div class="glass-panel p-8 rounded-3xl w-full max-w-sm border-2 border-jokerPurple">
            <h1 class="text-3xl font-bold text-jokerGreen text-center mb-6">PersonalSpace</h1>
            <div class="space-y-4">
                <select id="login-username" class="w-full bg-white/10 border border-white/20 rounded-xl px-4 py-3 text-white outline-none appearance-none">
                    <option value="Admin">â˜… Admin</option>
                </select>
                <div class="relative">
                    <input type="password" id="login-password" placeholder="Password" class="w-full bg-white/10 border border-white/20 rounded-xl px-4 py-3 text-white outline-none">
                    <button type="button" onclick="togglePasswordVisibility()" class="absolute right-3 top-1/2 -translate-y-1/2 text-white/50"><i id="eye-icon" class="fas fa-eye"></i></button>
                </div>
                <button onclick="handleLogin()" class="w-full bg-jokerGreen text-black font-black py-3 rounded-xl transform active:scale-95">ACCESS SYSTEM</button>
                <p id="login-error" class="text-red-400 text-xs text-center hidden">Invalid Credentials</p>
            </div>
        </div>
    </div>

    <div class="flex flex-1 overflow-hidden relative">
        <aside class="sidebar w-64 flex flex-col justify-between h-full z-20">
            <div class="p-6 text-white">
                <h1 class="text-2xl font-bold text-jokerGreen">PersonalSpace</h1>
                <p class="text-xs opacity-60">Team Project Hub</p>
            </div>

            <div class="px-4 mb-4">
                <label class="text-[10px] text-green-400 font-bold block uppercase">User:</label>
                <div class="bg-purple-900/50 p-2 rounded flex justify-between items-center text-white">
                    <span id="current-user-name">Admin</span>
                    <button onclick="logout()" class="text-red-400"><i class="fas fa-sign-out-alt"></i></button>
                </div>
            </div>

            <nav class="flex-1 px-4 space-y-2">
                <button onclick="switchView('dashboard')" id="nav-dashboard" class="nav-item active w-full flex items-center gap-3 text-white px-4 py-3 rounded-lg">
                    <i class="fas fa-home"></i> Dashboard
                </button>
                <button onclick="switchView('kanban')" id="nav-kanban" class="nav-item w-full flex items-center gap-3 text-white px-4 py-3 rounded-lg">
                    <i class="fas fa-tasks"></i> Task Tracker
                </button>
            </nav>

            <div class="p-4 border-t border-purple-500/30">
                <div id="admin-tools-members" class="admin-only mb-3">
                    <div class="flex gap-2">
                        <input type="text" id="new-member-name" placeholder="Member..." class="w-full bg-white/10 rounded px-2 py-1 text-white text-sm">
                        <button onclick="addMember()" class="bg-jokerGreen px-2 rounded"><i class="fas fa-plus"></i></button>
                    </div>
                </div>
                <ul id="team-list" class="space-y-2 max-h-40 overflow-y-auto"></ul>
            </div>
        </aside>

        <main class="flex-1 flex flex-col bg-white/5 backdrop-blur-sm relative">
            <header class="p-6 flex justify-between items-center text-white">
                <div>
                    <h1 class="text-3xl font-bold text-jokerGreen" id="clock">00:00</h1>
                    <p id="date" class="text-sm opacity-90"></p>
                </div>
                <div class="flex items-center gap-4">
                    <p id="greeting" class="font-bold"></p>
                    <div id="header-avatar" class="w-14 h-14 rounded-full border-2 border-jokerGreen overflow-hidden relative cursor-pointer" onclick="triggerAvatarUpload(store.currentUser || 'Admin')">
                        <i class="fas fa-user text-white/50 text-2xl absolute inset-0 flex items-center justify-center"></i>
                    </div>
                </div>
            </header>

            <div id="view-dashboard" class="flex-1 p-6 flex flex-col gap-4 overflow-hidden">
                <div class="grid grid-cols-10 gap-4 flex-1">
                    <div class="col-span-3 flex flex-col gap-4">
                        <div class="glass-panel p-4 h-1/3 flex flex-col rounded-2xl">
                            <h2 class="text-sm font-bold mb-2 text-purple-700">Quick Notes</h2>
                            <textarea id="notepad" onchange="saveNotes(this.value)" class="flex-1 bg-transparent resize-none outline-none text-sm" placeholder="Private notes..."></textarea>
                        </div>
                        <div class="glass-panel p-4 flex-1 flex flex-col rounded-2xl overflow-hidden">
                            <h2 class="text-sm font-bold mb-2 text-jokerGreen">Quick Tasks</h2>
                            <ul id="quick-task-list" class="flex-1 overflow-y-auto space-y-2"></ul>
                        </div>
                    </div>
                    
                    <div class="col-span-7 glass-panel p-4 rounded-2xl flex flex-col">
                        <div class="flex justify-between items-center mb-2">
                            <h2 class="text-sm font-bold text-purple-700">Private Schedule</h2>
                            <div class="flex items-center gap-2">
                                <button onclick="changeMonth(-1)"><i class="fas fa-chevron-left"></i></button>
                                <span id="calendar-month-year" class="font-bold"></span>
                                <button onclick="changeMonth(1)"><i class="fas fa-chevron-right"></i></button>
                            </div>
                        </div>
                        <div class="grid grid-cols-7 text-[10px] font-bold text-center mb-1">
                            <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
                        </div>
                        <div id="calendar-body" class="calendar-grid flex-1 overflow-y-auto"></div>
                    </div>
                </div>
            </div>

            <div id="view-kanban" class="flex-1 p-6 hidden flex-col">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold text-jokerGreen">Task Tracker</h2>
                    <div class="flex gap-2">
                        <button onclick="exportSummaryReport()" class="bg-amber-600 px-4 py-2 rounded text-white text-sm font-bold">Export & Flush</button>
                        <button onclick="openTaskModal()" class="bg-jokerGreen px-4 py-2 rounded text-black font-bold text-sm">New Task</button>
                    </div>
                </div>
                <div class="grid grid-cols-3 gap-6 flex-1 overflow-hidden">
                    <div class="glass-panel rounded-xl flex flex-col border-t-4 border-slate-400">
                        <div class="p-3 font-bold border-b">To Do</div>
                        <div class="column-body p-3 flex-1 overflow-y-auto space-y-3" ondrop="drop(event, 'todo', 'status')" ondragover="allowDrop(event)"></div>
                    </div>
                    <div class="glass-panel rounded-xl flex flex-col border-t-4 border-purple-600">
                        <div class="p-3 font-bold border-b">In Progress</div>
                        <div class="column-body p-3 flex-1 overflow-y-auto space-y-3" ondrop="drop(event, 'inprogress', 'status')" ondragover="allowDrop(event)"></div>
                    </div>
                    <div class="glass-panel rounded-xl flex flex-col border-t-4 border-jokerGreen">
                        <div class="p-3 font-bold border-b">Executed</div>
                        <div class="column-body p-3 flex-1 overflow-y-auto space-y-3" ondrop="drop(event, 'done', 'status')" ondragover="allowDrop(event)"></div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="calendar-modal" class="fixed inset-0 bg-black/80 hidden flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl w-full max-w-sm p-6">
            <h2 id="cal-date-title" class="text-lg font-bold text-purple-700"></h2>
            <div id="day-events-list" class="my-4 space-y-2 max-h-40 overflow-y-auto"></div>
            <div class="space-y-2">
                <div class="flex gap-2">
                    <input type="date" id="evt-start-date" class="w-1/2 border p-1 text-xs">
                    <input type="date" id="evt-end-date" class="w-1/2 border p-1 text-xs">
                </div>
                <div class="flex gap-2">
                    <input type="time" id="new-event-start" class="w-1/2 border p-1 text-xs">
                    <input type="time" id="new-event-end" class="w-1/2 border p-1 text-xs">
                </div>
                <input type="text" id="new-event-input" placeholder="Event details..." class="w-full border p-2 text-sm">
                <select id="new-event-urgency" class="w-full border p-2 text-xs">
                    <option value="low">Low Urgency</option>
                    <option value="medium">Medium Urgency</option>
                    <option value="high">High Urgency</option>
                </select>
                <div class="flex justify-end gap-2 mt-4">
                    <button onclick="closeModal('calendar-modal')" class="text-slate-400">Cancel</button>
                    <button onclick="addEvent()" class="bg-jokerGreen px-4 py-2 rounded font-bold">Add Event</button>
                </div>
            </div>
        </div>
    </div>

    <input type="file" id="avatar-upload" class="hidden" accept="image/*" onchange="handleAvatarFile(this)">

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCvfwF-_by5hoUIVoEowKwbzzKF3YkJWy0",
            authDomain: "personalspacehub-3a44d.firebaseapp.com",
            projectId: "personalspacehub-3a44d",
            storageBucket: "personalspacehub-3a44d.firebasestorage.app",
            messagingSenderId: "605942768680",
            appId: "1:605942768680:web:74702b5d902dd462f1811d",
            measurementId: "G-E1YDD7Y7MX",
            databaseURL: "https://personalspacehub-3a44d-default-rtdb.firebaseio.com/"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        const store = {
            currentUser: null,
            users: [],
            kanbanTasks: [],
            avatars: {},
            notes: '',
            events: {},
            passwords: {},
            calendarMonth: new Date().getMonth(),
            calendarYear: new Date().getFullYear()
        };

        // --- CALENDAR LOGIC (CORRECTED DISTRIBUTION) ---
        function renderCalendar() {
            const months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
            document.getElementById('calendar-month-year').textContent = `${months[store.calendarMonth]} ${store.calendarYear}`;
            const firstDay = new Date(store.calendarYear, store.calendarMonth, 1).getDay();
            const daysInMonth = new Date(store.calendarYear, store.calendarMonth + 1, 0).getDate();
            const grid = document.getElementById('calendar-body');
            grid.innerHTML = '';

            for(let i=0; i<firstDay; i++) grid.innerHTML += `<div class="bg-white/5 border-r border-b"></div>`;

            for(let d=1; d<=daysInMonth; d++) {
                const dateKey = `${store.calendarYear}-${String(store.calendarMonth+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                const events = store.events[dateKey] || [];
                const el = document.createElement('div');
                el.className = `calendar-day ${new Date().getDate() === d && new Date().getMonth() === store.calendarMonth ? 'today' : ''}`;
                el.innerHTML = `<div class="text-[10px] font-bold">${d}</div>`;
                
                events.forEach(evt => {
                    const data = typeof evt === 'string' ? JSON.parse(evt) : evt;
                    el.innerHTML += `<div class="cal-event-item cal-urgency-${data.urgency}">${data.text}</div>`;
                });
                el.onclick = () => openCalendarModal(dateKey);
                grid.appendChild(el);
            }
        }

        function addEvent() {
            const text = document.getElementById('new-event-input').value.trim();
            const startStr = document.getElementById('evt-start-date').value;
            const endStr = document.getElementById('evt-end-date').value;
            const urgency = document.getElementById('new-event-urgency').value;

            if(!text || !startStr || !endStr) return alert("Please fill text and both dates.");

            // Standardize dates to avoid timezone/hour issues during distribution
            let current = new Date(startStr + "T00:00:00");
            let last = new Date(endStr + "T00:00:00");

            if(current > last) return alert("Start date must be before end date.");

            const eventObj = {
                text: text,
                urgency: urgency,
                time: document.getElementById('new-event-start').value || ''
            };

            while(current <= last) {
                const y = current.getFullYear();
                const m = String(current.getMonth() + 1).padStart(2, '0');
                const d = String(current.getDate()).padStart(2, '0');
                const key = `${y}-${m}-${d}`;

                if(!store.events[key]) store.events[key] = [];
                store.events[key].push(JSON.stringify(eventObj));
                
                current.setDate(current.getDate() + 1);
            }

            saveUserDataToCloud();
            closeModal('calendar-modal');
            renderCalendar();
        }

        // --- USER & AUTH ---
        function switchUser(name) {
            store.currentUser = name === "Admin" ? null : name;
            const userKey = (name || "Admin").replace(/[^a-zA-Z0-9]/g, '_');
            document.getElementById('current-user-name').textContent = name;
            
            db.ref(`projectData/userData/${userKey}`).once('value', snap => {
                const data = snap.val() || {};
                store.notes = data.notes || '';
                store.events = data.events || {};
                document.getElementById('notepad').value = store.notes;
                document.getElementById('greeting').textContent = `Hello, ${name}`;
                renderCalendar();
                updateUI();
            });
        }

        function handleLogin() {
            const u = document.getElementById('login-username').value;
            const p = document.getElementById('login-password').value;
            if(p === (store.passwords[u] || "1234")) {
                localStorage.setItem('ps_session_user', u);
                document.getElementById('login-overlay').classList.add('hidden');
                switchUser(u);
            } else alert("Wrong password");
        }

        function pushToCloud() {
            db.ref('projectData').update({
                users: store.users,
                kanbanTasks: store.kanbanTasks,
                avatars: store.avatars,
                passwords: store.passwords
            });
        }

        function saveUserDataToCloud() {
            const userKey = (store.currentUser || "Admin").replace(/[^a-zA-Z0-9]/g, '_');
            db.ref(`projectData/userData/${userKey}`).update({
                notes: store.notes,
                events: store.events
            });
        }

        // --- BOILERPLATE & UI ---
        function updateClock() {
            const n = new Date();
            document.getElementById('clock').textContent = n.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
            document.getElementById('date').textContent = n.toLocaleDateString(undefined, {weekday:'long', month:'long', day:'numeric'});
        }
        function togglePasswordVisibility() {
            const i = document.getElementById('login-password');
            i.type = i.type === "password" ? "text" : "password";
        }
        function updateUI() {
            const isAdmin = !store.currentUser;
            document.querySelectorAll('.admin-only').forEach(el => el.classList.toggle('hidden-tool', !isAdmin));
            const avatar = store.avatars[store.currentUser || 'Admin'];
            document.getElementById('header-avatar').innerHTML = avatar ? `<img src="${avatar}" class="w-full h-full object-cover">` : `<i class="fas fa-user text-white/50 text-2xl absolute inset-0 flex items-center justify-center"></i>`;
        }
        function triggerAvatarUpload(u) { uploadingUser = u; document.getElementById('avatar-upload').click(); }
        function handleAvatarFile(input) {
            const reader = new FileReader();
            reader.onload = e => { store.avatars[uploadingUser] = e.target.result; pushToCloud(); updateUI(); };
            reader.readAsDataURL(input.files[0]);
        }
        function saveNotes(v) { store.notes = v; saveUserDataToCloud(); }
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
        function openCalendarModal(k) { 
            document.getElementById('calendar-modal').classList.remove('hidden');
            document.getElementById('cal-date-title').textContent = k;
            document.getElementById('evt-start-date').value = k;
            document.getElementById('evt-end-date').value = k;
        }
        function logout() { localStorage.clear(); location.reload(); }
        function changeMonth(d) { store.calendarMonth += d; if(store.calendarMonth > 11) { store.calendarMonth=0; store.calendarYear++; } if(store.calendarMonth < 0) { store.calendarMonth=11; store.calendarYear--; } renderCalendar(); }
        function switchView(v) { 
            document.getElementById('view-dashboard').classList.toggle('hidden', v !== 'dashboard');
            document.getElementById('view-kanban').classList.toggle('hidden', v !== 'kanban');
            document.getElementById('nav-dashboard').classList.toggle('active', v === 'dashboard');
            document.getElementById('nav-kanban').classList.toggle('active', v === 'kanban');
        }

        // Final Sync
        db.ref('projectData').on('value', snap => {
            const data = snap.val() || {};
            store.users = data.users || [];
            store.passwords = data.passwords || {"Admin":"1234"};
            store.avatars = data.avatars || {};
            store.kanbanTasks = data.kanbanTasks || [];
            
            // Sync Team List
            const list = document.getElementById('team-list'); list.innerHTML = '';
            const select = document.getElementById('login-username'); select.innerHTML = '<option value="Admin">Admin</option>';
            store.users.forEach(u => {
                list.innerHTML += `<li class="text-white text-xs">${u}</li>`;
                select.innerHTML += `<option value="${u}">${u}</option>`;
            });

            if(!store.currentUser) renderCalendar();
            updateUI();
        });

        updateClock();
        setInterval(updateClock, 1000);
    </script>
</body>
</html>