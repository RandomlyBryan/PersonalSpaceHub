<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PersonalSpace - Team Project Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/dark.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-analytics-compat.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        jokerPurple: "#3c096c",
                        jokerGreen: "#39ff14"
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background: linear-gradient(135deg, #9d4edd, #70e000);
            min-height: 100vh;
            transition: background 0.5s ease;
            overflow: hidden; 
            font-family: 'Inter', sans-serif;
        }
        .dark body { background: linear-gradient(135deg, #10002b, #004b23); }

        /* Welcome Screen Overlay */
        #welcome-screen {
            position: fixed;
            inset: 0;
            background: linear-gradient(135deg, #240046, #10002b);
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: opacity 0.5s ease, visibility 0.5s;
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(157, 78, 221, 0.3);
            box-shadow: 0 8px 32px 0 rgba(60, 9, 108, 0.2);
        }
        .dark .glass-panel {
            background: rgba(20, 10, 40, 0.85);
            color: #e2e8f0;
            border: 1px solid rgba(57, 255, 20, 0.1);
        }
        
        .sidebar { background: rgba(36, 0, 70, 0.7); backdrop-filter: blur(20px); border-right: 1px solid rgba(255,255,255,0.1); }
        .nav-item.active { background: rgba(255, 255, 255, 0.1); border-left: 4px solid #39ff14; color: #39ff14; }
        .admin-only.hidden-tool { display: none !important; }
        
        .pin-input {
            letter-spacing: 1em;
            text-align: center;
            font-weight: bold;
        }
    </style>
</head>
<body class="text-slate-800 antialiased flex flex-col h-screen w-screen overflow-hidden">

    <div id="welcome-screen">
        <div class="glass-panel p-8 rounded-3xl w-full max-w-md text-center shadow-2xl border-2 border-green-400">
            <h1 class="text-4xl font-bold text-white mb-2 tracking-tighter">PersonalSpace</h1>
            <p class="text-green-400 uppercase text-[10px] font-bold tracking-widest mb-8">Secure Team Hub</p>
            
            <div id="login-step-1">
                <label class="block text-white/70 text-sm mb-2">Select your name to enter</label>
                <select id="login-user-select" class="w-full bg-purple-900/50 text-white border border-purple-500 rounded-lg p-3 mb-4 outline-none">
                    <option value="Admin">★ Admin</option>
                </select>
                <button onclick="proceedToPin()" class="w-full bg-green-500 hover:bg-green-400 text-black font-bold py-3 rounded-lg transition transform active:scale-95">Next <i class="fas fa-chevron-right ml-2"></i></button>
            </div>

            <div id="login-step-2" class="hidden">
                <p id="pin-prompt" class="text-white mb-4">Enter your 4-digit PIN</p>
                <input type="password" id="login-pin-input" maxlength="4" placeholder="••••" class="pin-input w-full bg-purple-900/50 text-white text-3xl border border-purple-500 rounded-lg p-3 mb-4 outline-none">
                <div class="flex gap-2">
                    <button onclick="backToLogin()" class="flex-1 text-white/50 hover:text-white text-sm">Back</button>
                    <button onclick="attemptLogin()" class="flex-[2] bg-green-500 hover:bg-green-400 text-black font-bold py-3 rounded-lg transition">Unlock Space</button>
                </div>
            </div>
        </div>
    </div>

    <div class="absolute top-0 left-1/2 transform -translate-x-1/2 bg-purple-900 text-white px-3 py-1 text-[10px] rounded-b-lg shadow-lg z-50 font-bold opacity-90 border border-green-400" id="connection-status">
        <i class="fas fa-circle-notch fa-spin mr-1 text-yellow-400"></i> Connecting...
    </div>

    <div class="flex flex-1 overflow-hidden relative">
        <aside class="sidebar w-64 flex-shrink-0 flex flex-col justify-between h-full z-20">
            <div class="p-6">
                <h1 class="text-2xl font-bold text-green-400">PersonalSpace</h1>
                <p id="view-mode-hint" class="text-[10px] text-white/50 italic mt-1 uppercase">Secure Hub</p>
            </div>

            <nav class="flex-1 px-4 space-y-2">
                <button onclick="switchView('dashboard')" id="nav-dashboard" class="nav-item w-full flex items-center gap-3 text-white px-4 py-3 rounded-r-lg transition active">
                    <i class="fas fa-home"></i> Dashboard
                </button>
                <button onclick="switchView('kanban')" id="nav-kanban" class="nav-item w-full flex items-center gap-3 text-white px-4 py-3 rounded-r-lg transition">
                    <i class="fas fa-tasks"></i> Tasks
                </button>
            </nav>

            <div class="p-4 border-t border-purple-500/30">
                <h3 class="text-xs font-bold text-green-400 uppercase mb-3 flex justify-between items-center">Team <span id="member-count" class="bg-purple-800 px-2 rounded-full text-white">0</span></h3>
                <div id="admin-tools-members" class="admin-only flex gap-2 mb-3">
                    <input type="text" id="new-member-name" placeholder="Name..." class="w-full bg-white/10 border border-white/20 rounded px-2 py-1 text-sm text-white">
                    <button onclick="addMember()" class="bg-green-600 text-black px-2 rounded">+</button>
                </div>
                <ul id="team-list" class="space-y-2 max-h-40 overflow-y-auto"></ul>
            </div>

            <div class="p-4 border-t border-purple-500/30">
                <div id="admin-tools-data" class="admin-only flex flex-col gap-2 mb-4">
                    <button onclick="backupData()" class="text-[10px] text-purple-300"><i class="fas fa-download"></i> Backup Cloud</button>
                    <button onclick="clearAllData()" class="text-[10px] text-red-400"><i class="fas fa-trash"></i> Nuke Cloud</button>
                </div>
                <button onclick="logout()" class="w-full bg-white/10 hover:bg-white/20 text-white text-xs py-2 rounded transition"><i class="fas fa-sign-out-alt mr-2"></i> Log Out</button>
            </div>
        </aside>

        <main class="flex-1 p-6 overflow-hidden flex flex-col">
            <div id="view-dashboard" class="flex-1 flex flex-col gap-4">
                <header class="flex justify-between items-center text-white">
                    <div>
                        <h1 class="text-3xl font-bold text-green-400" id="clock">00:00</h1>
                        <p id="date" class="text-sm opacity-70">Date</p>
                    </div>
                    <div class="flex items-center gap-3 text-right">
                        <div>
                            <p id="greeting" class="font-bold">Welcome</p>
                            <span id="dashboard-owner-badge" class="text-[10px] bg-green-500 text-black px-2 py-0.5 rounded-full uppercase font-bold">Workspace</span>
                        </div>
                        <div id="header-avatar" class="w-12 h-12 rounded-full bg-purple-900 border-2 border-green-400 overflow-hidden flex items-center justify-center">
                            <i class="fas fa-user text-white/50"></i>
                        </div>
                    </div>
                </header>

                <div class="grid grid-cols-10 gap-4 flex-1 overflow-hidden">
                    <div class="col-span-3 flex flex-col gap-4">
                        <div class="glass-panel p-4 rounded-2xl h-1/2 flex flex-col">
                            <h2 class="text-sm font-bold mb-2"><i class="fas fa-sticky-note mr-2"></i>Notes</h2>
                            <textarea id="notepad" class="flex-1 w-full bg-transparent border-none outline-none text-sm" placeholder="Your private notes..." onchange="saveNotes(this.value)"></textarea>
                        </div>
                        <div class="glass-panel p-4 rounded-2xl h-1/2 flex flex-col overflow-hidden">
                            <h2 class="text-sm font-bold mb-2"><i class="fas fa-check-circle mr-2 text-green-500"></i>Tasks</h2>
                            <ul id="quick-task-list" class="flex-1 overflow-y-auto space-y-2"></ul>
                        </div>
                    </div>
                    <div class="col-span-7 glass-panel p-4 rounded-2xl flex flex-col">
                        <div class="flex justify-between mb-2">
                            <h2 class="text-sm font-bold"><i class="fas fa-calendar-alt mr-2"></i>Schedule</h2>
                            <span id="calendar-month-year" class="text-xs font-bold">Month</span>
                        </div>
                        <div id="calendar-body" class="grid grid-cols-7 flex-1 border-t border-purple-100/10"></div>
                    </div>
                </div>
            </div>

            <div id="view-kanban" class="hidden flex-1 flex-col">
                <div class="flex justify-between mb-6">
                    <h2 class="text-2xl font-bold text-white">Task Tracker</h2>
                    <button onclick="openTaskModal()" class="bg-green-500 text-black px-4 py-2 rounded-lg font-bold shadow-lg">+ New Task</button>
                </div>
                <div class="grid grid-cols-3 gap-6 flex-1 overflow-hidden">
                    <div class="glass-panel p-3 rounded-xl flex flex-col border-t-4 border-slate-400">
                        <h3 class="font-bold mb-3">To Do</h3>
                        <div class="column-body flex-1 overflow-y-auto space-y-3" ondrop="drop(event, 'todo')" ondragover="allowDrop(event)"></div>
                    </div>
                    <div class="glass-panel p-3 rounded-xl flex flex-col border-t-4 border-purple-500">
                        <h3 class="font-bold mb-3">In Progress</h3>
                        <div class="column-body flex-1 overflow-y-auto space-y-3" ondrop="drop(event, 'inprogress')" ondragover="allowDrop(event)"></div>
                    </div>
                    <div class="glass-panel p-3 rounded-xl flex flex-col border-t-4 border-green-500">
                        <h3 class="font-bold mb-3">Executed</h3>
                        <div class="column-body flex-1 overflow-y-auto space-y-3" ondrop="drop(event, 'done')" ondragover="allowDrop(event)"></div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="task-modal" class="fixed inset-0 bg-black/80 hidden flex items-center justify-center z-50 p-4">
        <div class="bg-white dark:bg-slate-800 rounded-2xl w-full max-w-sm p-6">
            <h2 class="text-lg font-bold mb-4">Task Details</h2>
            <input type="text" id="task-title" placeholder="What needs to be done?" class="w-full bg-slate-100 p-3 rounded-lg mb-4 outline-none">
            <select id="task-assignee" class="w-full bg-slate-100 p-3 rounded-lg mb-4"></select>
            <div class="flex justify-end gap-2">
                <button onclick="closeModal('task-modal')" class="px-4 py-2">Cancel</button>
                <button onclick="saveTask()" class="bg-purple-600 text-white px-6 py-2 rounded-lg">Save</button>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCvfwF-_by5hoUIVoEowKwbzzKF3YkJWy0",
            authDomain: "personalspacehub-3a44d.firebaseapp.com",
            projectId: "personalspacehub-3a44d",
            storageBucket: "personalspacehub-3a44d.firebasestorage.app",
            messagingSenderId: "605942768680",
            appId: "1:605942768680:web:74702b5d902dd462f1811d",
            databaseURL: "https://personalspacehub-3a44d-default-rtdb.firebaseio.com/"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        const store = {
            currentUser: null,
            users: [],
            kanbanTasks: [],
            pins: {}, // Name: Pin mapping
            notes: '',
            avatars: {},
            events: {},
            calendarMonth: new Date().getMonth(),
            calendarYear: new Date().getFullYear()
        };

        let targetUser = "";

        function proceedToPin() {
            targetUser = document.getElementById('login-user-select').value;
            document.getElementById('login-step-1').classList.add('hidden');
            document.getElementById('login-step-2').classList.remove('hidden');
            
            const prompt = document.getElementById('pin-prompt');
            if (store.pins && store.pins[targetUser]) {
                prompt.textContent = `Enter PIN for ${targetUser}`;
            } else {
                prompt.textContent = `Create a 4-digit PIN for ${targetUser}`;
            }
            document.getElementById('login-pin-input').focus();
        }

        function backToLogin() {
            document.getElementById('login-step-2').classList.add('hidden');
            document.getElementById('login-step-1').classList.remove('hidden');
            document.getElementById('login-pin-input').value = "";
        }

        function attemptLogin() {
            const pin = document.getElementById('login-pin-input').value;
            if (pin.length < 4) return alert("PIN must be 4 digits");

            // Check if existing or new
            if (!store.pins[targetUser]) {
                // Register new PIN
                db.ref('projectData/pins/' + targetUser).set(pin);
                completeLogin(targetUser);
            } else if (store.pins[targetUser] === pin) {
                completeLogin(targetUser);
            } else {
                alert("Incorrect PIN");
                document.getElementById('login-pin-input').value = "";
            }
        }

        function completeLogin(name) {
            store.currentUser = (name === "Admin") ? null : name;
            document.getElementById('welcome-screen').style.opacity = "0";
            setTimeout(() => {
                document.getElementById('welcome-screen').style.visibility = "hidden";
                updateUIForUser();
                loadUserPrivateData();
            }, 500);
        }

        function logout() {
            location.reload();
        }

        function updateUIForUser() {
            const adminTools = document.querySelectorAll('.admin-only');
            const greeting = document.getElementById('greeting');
            const badge = document.getElementById('dashboard-owner-badge');

            if (store.currentUser) {
                greeting.textContent = `Hello, ${store.currentUser}.`;
                badge.textContent = `${store.currentUser}'s Space`;
                adminTools.forEach(el => el.classList.add('hidden-tool'));
            } else {
                greeting.textContent = `Admin Panel`;
                badge.textContent = `Main View`;
                adminTools.forEach(el => el.classList.remove('hidden-tool'));
            }
            renderKanbanBoard();
            renderTeamList();
        }

        function loadUserPrivateData() {
            const key = (store.currentUser || "Admin").replace(/[^a-zA-Z0-9]/g, '_');
            db.ref('projectData/userData/' + key).once('value', snap => {
                const data = snap.val() || {};
                store.notes = data.notes || '';
                document.getElementById('notepad').value = store.notes;
            });
        }

        function saveNotes(val) {
            const key = (store.currentUser || "Admin").replace(/[^a-zA-Z0-9]/g, '_');
            db.ref('projectData/userData/' + key).update({ notes: val });
        }

        // FIREBASE DATA SYNC
        db.ref('projectData').on('value', snap => {
            const data = snap.val() || {};
            store.users = data.users || [];
            store.kanbanTasks = data.kanbanTasks || [];
            store.pins = data.pins || {};
            store.events = data.events || {};
            store.avatars = data.avatars || {};
            
            updateLoginDropdown();
            renderTeamList();
            renderKanbanBoard();
            renderCalendar();
            document.getElementById('connection-status').innerHTML = '<i class="fas fa-check-circle mr-1 text-green-400"></i> Cloud Active';
        });

        function updateLoginDropdown() {
            const select = document.getElementById('login-user-select');
            const current = select.value;
            select.innerHTML = '<option value="Admin">★ Admin</option>';
            store.users.forEach(u => {
                const opt = document.createElement('option');
                opt.value = u; opt.textContent = u;
                select.appendChild(opt);
            });
            select.value = current;
        }

        function renderTeamList() {
            const list = document.getElementById('team-list');
            list.innerHTML = '';
            const dropdown = document.getElementById('task-assignee');
            dropdown.innerHTML = '<option value="">Unassigned</option>';

            store.users.forEach((u, i) => {
                const li = document.createElement('li');
                li.className = "flex justify-between items-center text-xs text-white/70 bg-white/5 p-2 rounded";
                li.innerHTML = `<span>${u}</span>`;
                if (!store.currentUser) {
                    li.innerHTML += `<button onclick="removeMember(${i})" class="text-red-400"><i class="fas fa-times"></i></button>`;
                }
                list.appendChild(li);

                const opt = document.createElement('option');
                opt.value = u; opt.textContent = u;
                dropdown.appendChild(opt);
            });
            document.getElementById('member-count').textContent = store.users.length;
        }

        function addMember() {
            const name = document.getElementById('new-member-name').value.trim();
            if (name && !store.users.includes(name)) {
                store.users.push(name);
                db.ref('projectData').update({ users: store.users });
                document.getElementById('new-member-name').value = '';
            }
        }
        
        function removeMember(idx) {
            if (confirm("Remove user and their PIN?")) {
                const name = store.users[idx];
                store.users.splice(idx, 1);
                db.ref('projectData').update({ users: store.users });
                db.ref('projectData/pins/' + name).remove();
            }
        }

        function renderKanbanBoard() {
            const cols = document.querySelectorAll('.column-body');
            cols.forEach(c => c.innerHTML = '');
            
            const filtered = store.kanbanTasks.filter(t => !store.currentUser || t.assignee === store.currentUser);
            
            filtered.forEach(t => {
                const card = document.createElement('div');
                card.className = "task-card bg-white dark:bg-slate-800 p-3 rounded-lg shadow-sm text-sm border-l-4 " + 
                    (t.status === 'done' ? 'border-green-500 opacity-60' : t.status === 'inprogress' ? 'border-purple-500' : 'border-slate-300');
                card.innerHTML = `<h4 class="font-bold">${t.title}</h4><p class="text-[10px] text-slate-400">${t.assignee || 'Unassigned'}</p>`;
                
                const colIdx = (t.status === 'inprogress') ? 1 : (t.status === 'done') ? 2 : 0;
                cols[colIdx].appendChild(card);
            });
            
            // Dashboard quick list
            const quickList = document.getElementById('quick-task-list');
            quickList.innerHTML = '';
            filtered.filter(t => t.status !== 'done').forEach(t => {
                const li = document.createElement('li');
                li.className = "bg-white/5 p-2 rounded text-xs flex justify-between";
                li.innerHTML = `<span>${t.title}</span><span class="opacity-50">${t.status}</span>`;
                quickList.appendChild(li);
            });
        }

        function saveTask() {
            const title = document.getElementById('task-title').value;
            const assignee = document.getElementById('task-assignee').value;
            if (!title) return;
            store.kanbanTasks.push({ id: Date.now(), title, assignee, status: 'todo' });
            db.ref('projectData').update({ kanbanTasks: store.kanbanTasks });
            closeModal('task-modal');
        }

        function openTaskModal() { document.getElementById('task-modal').classList.remove('hidden'); }
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
        function switchView(v) {
            document.getElementById('view-dashboard').classList.toggle('hidden', v !== 'dashboard');
            document.getElementById('view-kanban').classList.toggle('hidden', v !== 'kanban');
            document.getElementById('nav-dashboard').classList.toggle('active', v === 'dashboard');
            document.getElementById('nav-kanban').classList.toggle('active', v === 'kanban');
        }
        function updateClock() {
            const now = new Date();
            document.getElementById('clock').textContent = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hourCycle: 'h23' });
            document.getElementById('date').textContent = now.toDateString();
        }
        function renderCalendar() {
            const grid = document.getElementById('calendar-body');
            grid.innerHTML = '';
            const daysInMonth = new Date(store.calendarYear, store.calendarMonth + 1, 0).getDate();
            for(let i=1; i<=daysInMonth; i++) {
                const day = document.createElement('div');
                day.className = "h-12 border-b border-r border-purple-100/10 text-[10px] p-1 text-white/40";
                day.textContent = i;
                grid.appendChild(day);
            }
            document.getElementById('calendar-month-year').textContent = new Date(store.calendarYear, store.calendarMonth).toLocaleString('default', { month: 'long', year: 'numeric' });
        }
        
        function clearAllData() {
            if(confirm("NUKE EVERYTHING?")) db.ref('projectData').remove();
        }

        setInterval(updateClock, 1000);
        updateClock();
    </script>
</body>
</html>