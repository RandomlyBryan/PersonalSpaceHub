<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PersonalSpace - Team Project Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/dark.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-analytics-compat.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        glass: "rgba(255, 255, 255, 0.95)",
                        darkGlass: "rgba(30, 41, 59, 0.95)",
                        sidebar: "rgba(36, 0, 70, 0.85)",
                        jokerPurple: "#3c096c",
                        jokerGreen: "#39ff14"
                    }
                }
            }
        }
    </script>

    <style>
        body { background: linear-gradient(135deg, #9d4edd, #70e000); min-height: 100vh; transition: background 0.5s ease; overflow: hidden; font-family: 'Inter', sans-serif; }
        .dark body { background: linear-gradient(135deg, #10002b, #004b23); }
        .glass-panel { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(12px); border: 1px solid rgba(157, 78, 221, 0.3); box-shadow: 0 8px 32px 0 rgba(60, 9, 108, 0.2); }
        .dark .glass-panel { background: rgba(20, 10, 40, 0.85); color: #e2e8f0; border: 1px solid rgba(57, 255, 20, 0.1); }
        .sidebar { background: rgba(36, 0, 70, 0.7); backdrop-filter: blur(20px); border-right: 1px solid rgba(255,255,255,0.1); }
        .nav-item.active { background: rgba(255, 255, 255, 0.1); border-left: 4px solid #39ff14; color: #39ff14; }
        .column-body { min-height: 200px; transition: background-color 0.2s; }
        .column-body.drag-over { background-color: rgba(57, 255, 20, 0.15); border-radius: 0.5rem; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-thumb { background: rgba(157, 78, 221, 0.5); border-radius: 3px; }
        .task-card { cursor: grab; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); border-top: 1px solid #e2e8f0; border-left: 1px solid #e2e8f0; }
        .calendar-day { min-height: 80px; max-height: 110px; overflow-y: auto; padding: 4px; font-size: 0.85rem; border-right: 1px solid #e2e8f0; border-bottom: 1px solid #e2e8f0; background: rgba(255,255,255,0.4); transition: background 0.2s; }
        .calendar-day.today { background: #3c096c !important; color: #39ff14 !important; border: 1px solid #39ff14; }
        .cal-event-item { font-size: 0.65rem; padding: 4px 5px; border-radius: 3px; background: rgba(255, 255, 255, 0.6); margin-top: 2px; border-left: 3px solid #ccc; color: #334155; }
        .view-btn.active { background-color: rgba(57, 255, 20, 0.2); border: 1px solid #39ff14; color: #39ff14; }
        #login-overlay { background: #10002b; z-index: 200; }
    </style>
</head>
<body class="text-slate-800 antialiased flex flex-col h-screen w-screen overflow-hidden">

    <div id="login-overlay" class="fixed inset-0 flex items-center justify-center transition-opacity duration-500">
        <div class="glass-panel p-8 rounded-3xl w-full max-sm:w-[90%] max-w-sm border-2 border-jokerPurple">
            <div class="flex justify-center mb-6">
                <div class="w-20 h-20 bg-jokerPurple rounded-2xl flex items-center justify-center border-2 border-jokerGreen shadow-lg">
                    <i class="fas fa-user-astronaut text-jokerGreen text-4xl"></i>
                </div>
            </div>
            <div class="text-center mb-6">
                <h1 class="text-3xl font-bold text-jokerGreen tracking-tighter">PersonalSpace</h1>
                <p class="text-white/50 text-xs uppercase tracking-widest">Secure Entry</p>
            </div>
            <div class="space-y-4">
                <select id="login-username" class="w-full bg-white/10 border border-white/20 rounded-xl px-4 py-3 text-white outline-none focus:border-jokerGreen appearance-none cursor-pointer">
                    <option value="Admin">★ Admin</option>
                </select>
                <input type="password" id="login-password" placeholder="••••••••" class="w-full bg-white/10 border border-white/20 rounded-xl px-4 py-3 text-white outline-none focus:border-jokerGreen">
                <button onclick="handleLogin()" class="w-full bg-jokerGreen hover:bg-green-400 text-black font-black py-3 rounded-xl transition transform active:scale-95">ACCESS SYSTEM</button>
                <p id="login-error" class="text-red-400 text-[10px] text-center font-bold hidden uppercase">Invalid Credentials</p>
            </div>
        </div>
    </div>

    <div class="absolute top-0 left-1/2 transform -translate-x-1/2 bg-purple-900 text-white px-3 py-1 text-[10px] rounded-b-lg shadow-lg z-50 font-bold border border-green-400" id="connection-status">
        <i class="fas fa-circle-notch fa-spin mr-1"></i> Connecting...
    </div>

    <div class="flex flex-1 overflow-hidden relative">
        <aside class="sidebar w-64 flex-shrink-0 flex flex-col justify-between h-full z-20 transition-all transform md:translate-x-0 absolute md:relative" id="main-sidebar">
            <div class="p-6 text-white">
                <h1 class="text-xl font-bold tracking-wider text-green-400">PersonalSpace</h1>
                <p class="text-[9px] text-white/60 uppercase tracking-wider">Project Hub</p>
            </div>
            <nav class="flex-1 px-4 space-y-2">
                <button onclick="switchView('dashboard')" id="nav-dashboard" class="nav-item w-full flex items-center gap-3 text-white px-4 py-3 rounded-r-lg transition active">
                    <i class="fas fa-home w-5"></i> Dashboard
                </button>
                <button onclick="switchView('kanban')" id="nav-kanban" class="nav-item w-full flex items-center gap-3 text-white px-4 py-3 rounded-r-lg transition">
                    <i class="fas fa-tasks w-5"></i> Task Tracker
                </button>
            </nav>
            <div class="p-4 border-t border-purple-500/30">
                <h3 class="text-xs font-bold text-green-400 uppercase mb-3 flex justify-between items-center">Team Members <span id="member-count" class="bg-purple-800 px-2 rounded-full text-white">0</span></h3>
                <ul id="team-list" class="space-y-2 max-h-40 overflow-y-auto"></ul>
            </div>
            <div class="p-4 border-t border-purple-500/30">
                <button onclick="logout()" class="w-full text-red-400 text-xs text-left"><i class="fas fa-sign-out-alt mr-2"></i> Logout</button>
            </div>
        </aside>

        <main class="flex-1 relative h-full overflow-hidden flex flex-col bg-white/5 backdrop-blur-sm">
            
            <div id="view-dashboard" class="flex-1 overflow-hidden p-4 md:p-6 fade-in h-full flex flex-col">
                <header class="mb-4 text-white flex justify-between items-center">
                    <div>
                        <h1 class="text-3xl font-bold text-green-400" id="clock">00:00</h1>
                        <p class="text-sm font-bold" id="date">Date</p>
                    </div>
                    <div id="greeting" class="text-right font-bold">Hello.</div>
                </header>

                <div class="grid grid-cols-1 lg:grid-cols-10 gap-4 flex-1 min-h-0">
                    <div class="lg:col-span-3 flex flex-col gap-4 h-full min-h-0">
                        
                        <div class="glass-panel rounded-2xl p-4 flex flex-col border-t-4 border-jokerGreen shrink-0">
                            <h2 class="text-xs font-bold mb-2 flex items-center gap-2 text-green-600"><i class="fas fa-stopwatch"></i> SESSION TIMER</h2>
                            <div class="text-center py-2"><span id="work-timer-display" class="text-4xl font-mono font-bold">00:00:00</span></div>
                            <div class="flex justify-center gap-3 mt-3">
                                <button onclick="toggleWorkTimer()" id="timer-toggle-btn" class="w-10 h-10 rounded-full bg-jokerGreen text-black flex items-center justify-center"><i id="timer-toggle-icon" class="fas fa-play"></i></button>
                                <button onclick="stopWorkTimer()" class="w-10 h-10 rounded-full bg-slate-200 dark:bg-slate-700 flex items-center justify-center"><i class="fas fa-stop"></i></button>
                            </div>
                        </div>

                        <div class="glass-panel rounded-2xl p-4 flex-1 flex flex-col min-h-0">
                            <h2 class="text-xs font-bold mb-3 flex items-center gap-2 text-green-600 uppercase"><i class="fas fa-check-circle"></i> Tasks & Assignments</h2>
                            <div class="flex gap-2 mb-3 bg-purple-50 dark:bg-purple-900/20 p-2 rounded-xl shrink-0">
                                <input type="text" id="quick-task-input" placeholder="New task..." class="w-full bg-white dark:bg-slate-700/50 rounded px-2 py-1 text-sm outline-none">
                                <button onclick="addQuickTask()" class="bg-jokerGreen px-3 rounded text-xs font-bold">+</button>
                            </div>
                            <ul id="quick-task-list" class="flex-1 overflow-y-auto space-y-2 pr-1"></ul>
                        </div>
                    </div>

                    <div class="lg:col-span-7 glass-panel rounded-2xl p-4 flex flex-col h-full min-h-0">
                        <div class="flex justify-between items-center mb-2">
                            <h2 class="text-sm font-bold text-purple-700"><i class="fas fa-calendar-alt mr-2"></i>Schedule</h2>
                            <span id="calendar-month-year" class="text-xs font-bold">...</span>
                        </div>
                        <div id="calendar-body" class="calendar-grid flex-1 overflow-y-auto"></div>
                    </div>
                </div>
            </div>

            <div id="view-kanban" class="flex-1 overflow-hidden p-4 md:p-6 fade-in hidden flex-col h-full">
                <div class="flex justify-between items-center mb-6 text-white">
                    <h2 class="text-2xl font-bold text-green-400">Task Tracker</h2>
                    <div class="flex gap-2">
                        <input type="text" id="date-range-picker" placeholder="Select Range" class="bg-black/40 text-xs rounded px-3 py-2 text-white outline-none border border-purple-500/50">
                        <button onclick="exportSummaryReport()" class="bg-amber-600 px-4 py-2 rounded text-xs font-bold">EXPORT REPORT</button>
                    </div>
                </div>
                <div class="grid grid-cols-3 gap-6 h-full overflow-hidden">
                    <div class="glass-panel rounded-xl flex flex-col h-full"><div class="p-3 border-b font-bold">To Do</div><div id="todo-col" class="column-body p-3 overflow-y-auto space-y-3"></div></div>
                    <div class="glass-panel rounded-xl flex flex-col h-full"><div class="p-3 border-b font-bold">In Progress</div><div id="inprogress-col" class="column-body p-3 overflow-y-auto space-y-3"></div></div>
                    <div class="glass-panel rounded-xl flex flex-col h-full"><div class="p-3 border-b font-bold">Executed</div><div id="done-col" class="column-body p-3 overflow-y-auto space-y-3"></div></div>
                </div>
            </div>
        </main>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCvfwF-_by5hoUIVoEowKwbzzKF3YkJWy0",
            authDomain: "personalspacehub-3a44d.firebaseapp.com",
            projectId: "personalspacehub-3a44d",
            databaseURL: "https://personalspacehub-3a44d-default-rtdb.firebaseio.com/"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        const store = {
            currentUser: null,
            users: [],
            kanbanTasks: [],
            allUserStates: {}, // Stores everyone's timer/notes for Admin reports
            timer: { isRunning: false, startTime: 0, accumulatedTime: 0 }
        };

        let workTimerInterval;

        // AUTH
        function handleLogin() {
            const user = document.getElementById('login-username').value;
            store.currentUser = user === "Admin" ? "" : user;
            localStorage.setItem('ps_user', user);
            document.getElementById('login-overlay').classList.add('hidden');
            switchUser(store.currentUser);
        }

        function logout() { localStorage.removeItem('ps_user'); location.reload(); }

        // SYNC
        function switchUser(name) {
            const userKey = (name || "Admin").replace(/[^a-zA-Z0-9]/g, '_');
            document.getElementById('greeting').textContent = `Hello, ${name || "Admin"}`;
            
            db.ref('projectData').on('value', snap => {
                const data = snap.val() || {};
                store.users = data.users || [];
                store.kanbanTasks = data.kanbanTasks || [];
                store.allUserStates = data.userData || {};

                if (data.userData && data.userData[userKey]) {
                    store.timer = data.userData[userKey].timer || { isRunning: false, startTime: 0, accumulatedTime: 0 };
                    clearInterval(workTimerInterval);
                    if (store.timer.isRunning) workTimerInterval = setInterval(updateWorkTimerUI, 1000);
                    updateWorkTimerUI();
                }
                renderDashboard();
                renderKanban();
                updateLoginDropdown();
            });
        }

        function saveTimerToCloud() {
            const userKey = (store.currentUser || "Admin").replace(/[^a-zA-Z0-9]/g, '_');
            db.ref(`projectData/userData/${userKey}/timer`).set(store.timer);
        }

        // TIMER
        function updateWorkTimerUI() {
            let totalMs = store.timer.accumulatedTime || 0;
            if (store.timer.isRunning) totalMs += (Date.now() - store.timer.startTime);
            
            const s = Math.floor(totalMs / 1000);
            document.getElementById('work-timer-display').textContent = 
                `${Math.floor(s/3600).toString().padStart(2,'0')}:${Math.floor((s%3600)/60).toString().padStart(2,'0')}:${(s%60).toString().padStart(2,'0')}`;
            
            const icon = document.getElementById('timer-toggle-icon');
            icon.className = store.timer.isRunning ? "fas fa-pause" : "fas fa-play";
        }

        function toggleWorkTimer() {
            if (!store.timer.isRunning) {
                store.timer.isRunning = true;
                store.timer.startTime = Date.now();
                workTimerInterval = setInterval(updateWorkTimerUI, 1000);
            } else {
                store.timer.isRunning = false;
                store.timer.accumulatedTime += (Date.now() - store.timer.startTime);
                clearInterval(workTimerInterval);
            }
            saveTimerToCloud();
            updateWorkTimerUI();
        }

        function stopWorkTimer() {
            if (confirm("Reset Timer?")) {
                clearInterval(workTimerInterval);
                store.timer = { isRunning: false, startTime: 0, accumulatedTime: 0 };
                saveTimerToCloud();
                updateWorkTimerUI();
            }
        }

        // REPORTING (THE FIX)
        function formatReportTime(ms) {
            const s = Math.floor(ms / 1000);
            const h = Math.floor(s / 3600);
            const m = Math.floor((s % 3600) / 60);
            return `${h}h ${m}m`;
        }

        function exportSummaryReport() {
            const range = document.getElementById('date-range-picker').value;
            const [startStr, endStr] = range.split(' to ');
            
            let filteredTasks = store.kanbanTasks;
            // Members only see their own
            if (store.currentUser) {
                filteredTasks = filteredTasks.filter(t => t.assignee === store.currentUser);
            }

            // Filter by date if selected
            if (startStr && endStr) {
                filteredTasks = filteredTasks.filter(t => t.assignedDate >= startStr && t.assignedDate <= endStr);
            }

            let report = `PROJECT STATUS REPORT\nRange: ${range || 'All Time'}\nUser: ${store.currentUser || 'Admin (Teamwide)'}\n----------------------\n\n`;

            if (!store.currentUser) {
                report += "TEAM PRODUCTIVITY SUMMARY (SESSION TIMERS):\n";
                for (const key in store.allUserStates) {
                    const name = key.replace('_', ' ');
                    const time = store.allUserStates[key].timer ? store.allUserStates[key].timer.accumulatedTime : 0;
                    report += `- ${name}: ${formatReportTime(time)}\n`;
                }
                report += "\n----------------------\n";
            } else {
                report += `YOUR TOTAL LOGGED TIME: ${formatReportTime(store.timer.accumulatedTime)}\n\n`;
            }

            const categories = ['todo', 'inprogress', 'done'];
            categories.forEach(cat => {
                const tasks = filteredTasks.filter(t => t.status === cat);
                report += `[${cat.toUpperCase()}]\n`;
                tasks.forEach(t => report += `- ${t.title} (${t.assignee})\n`);
                report += `\n`;
            });

            const blob = new Blob([report], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Report_${store.currentUser || 'Admin'}.txt`;
            a.click();
        }

        // UI RENDERERS
        function renderDashboard() {
            const list = document.getElementById('quick-task-list');
            list.innerHTML = '';
            const myTasks = store.kanbanTasks.filter(t => !store.currentUser || t.assignee === store.currentUser);
            myTasks.forEach(t => {
                const li = document.createElement('li');
                li.className = "bg-white p-2 rounded border text-xs flex justify-between";
                li.innerHTML = `<span>${t.title}</span><span class="opacity-50">${t.status}</span>`;
                list.appendChild(li);
            });

            document.getElementById('member-count').textContent = store.users.length;
            const teamUl = document.getElementById('team-list');
            teamUl.innerHTML = '';
            store.users.forEach(u => teamUl.innerHTML += `<li class="text-xs text-white/70">${u}</li>`);
            
            updateCalendar();
        }

        function renderKanban() {
            const cols = ['todo', 'inprogress', 'done'];
            cols.forEach(c => {
                const div = document.getElementById(`${c}-col`);
                div.innerHTML = '';
                const tasks = store.kanbanTasks.filter(t => t.status === c && (!store.currentUser || t.assignee === store.currentUser));
                tasks.forEach(t => {
                    div.innerHTML += `<div class="bg-white p-3 rounded shadow-sm text-xs font-bold border-l-4 border-purple-500">${t.title}<br><span class="font-normal opacity-60">${t.assignee}</span></div>`;
                });
            });
        }

        function updateCalendar() {
            const grid = document.getElementById('calendar-body');
            grid.innerHTML = '';
            const days = new Date(2025, new Date().getMonth() + 1, 0).getDate();
            for (let i = 1; i <= days; i++) {
                const isToday = i === new Date().getDate();
                grid.innerHTML += `<div class="calendar-day ${isToday?'today':''}"><div class="font-bold">${i}</div></div>`;
            }
        }

        function updateLoginDropdown() {
            const sel = document.getElementById('login-username');
            sel.innerHTML = '<option value="Admin">★ Admin</option>';
            store.users.forEach(u => sel.innerHTML += `<option value="${u}">${u}</option>`);
        }

        function addQuickTask() {
            const val = document.getElementById('quick-task-input').value;
            if (!val) return;
            store.kanbanTasks.push({ id: Date.now(), title: val, status: 'todo', assignee: store.currentUser || 'Unassigned', assignedDate: new Date().toISOString().split('T')[0] });
            db.ref('projectData/kanbanTasks').set(store.kanbanTasks);
            document.getElementById('quick-task-input').value = '';
        }

        function switchView(v) {
            document.getElementById('view-dashboard').classList.toggle('hidden', v !== 'dashboard');
            document.getElementById('view-kanban').classList.toggle('hidden', v !== 'kanban');
            document.getElementById('nav-dashboard').classList.toggle('active', v === 'dashboard');
            document.getElementById('nav-kanban').classList.toggle('active', v === 'kanban');
        }

        function updateClock() {
            const n = new Date();
            document.getElementById('clock').textContent = n.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
            document.getElementById('date').textContent = n.toDateString();
        }

        // INIT FLAT PICKR
        flatpickr("#date-range-picker", { mode: "range", dateFormat: "Y-m-d", theme: "dark" });
        setInterval(updateClock, 1000);

        // Check for saved session
        const saved = localStorage.getItem('ps_user');
        if (saved) {
            document.getElementById('login-username').value = saved;
            handleLogin();
        }
    </script>
</body>
</html>