<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PersonalSpace - Team Project Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/dark.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-analytics-compat.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        glass: "rgba(255, 255, 255, 0.95)",
                        darkGlass: "rgba(30, 41, 59, 0.95)",
                        sidebar: "rgba(36, 0, 70, 0.85)",
                        jokerPurple: "#3c096c",
                        jokerGreen: "#39ff14"
                    }
                }
            }
        }
    </script>

    <style>
        body { background: linear-gradient(135deg, #9d4edd, #70e000); min-height: 100vh; transition: background 0.5s ease; overflow: hidden; font-family: 'Inter', sans-serif; }
        .dark body { background: linear-gradient(135deg, #10002b, #004b23); }
        .glass-panel { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(12px); border: 1px solid rgba(157, 78, 221, 0.3); box-shadow: 0 8px 32px 0 rgba(60, 9, 108, 0.2); }
        .dark .glass-panel { background: rgba(20, 10, 40, 0.85); color: #e2e8f0; border: 1px solid rgba(57, 255, 20, 0.1); }
        .sidebar { background: rgba(36, 0, 70, 0.7); backdrop-filter: blur(20px); border-right: 1px solid rgba(255,255,255,0.1); }
        .dark .sidebar { background: rgba(10, 0, 20, 0.8); }
        .nav-item.active { background: rgba(255, 255, 255, 0.1); border-left: 4px solid #39ff14; color: #39ff14; }
        .dark .nav-item.active { background: rgba(255, 255, 255, 0.05); border-left: 4px solid #9d4edd; color: #d8b4fe; } 
        .column-body { min-height: 200px; transition: background-color 0.2s; }
        .column-body.drag-over { background-color: rgba(57, 255, 20, 0.15); border-radius: 0.5rem; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: rgba(157, 78, 221, 0.5); border-radius: 3px; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); border-top: 1px solid #e2e8f0; border-left: 1px solid #e2e8f0; }
        .calendar-day { min-height: 80px; padding: 4px; font-size: 0.85rem; cursor: pointer; border-right: 1px solid #e2e8f0; border-bottom: 1px solid #e2e8f0; background: rgba(255,255,255,0.4); }
        .dark .calendar-day { border-color: #3c096c; background: rgba(30, 41, 59, 0.4); }
        .calendar-day.today { background: #3c096c; color: #39ff14; font-weight: bold; border: 2px solid #39ff14; }
        #welcome-screen { position: fixed; inset: 0; z-index: 1000; background: linear-gradient(135deg, #240046, #004b23); display: flex; align-items: center; justify-content: center; }
        #welcome-screen.hidden { display: none; }
        .cal-event-item { font-size: 0.65rem; padding: 2px 4px; border-radius: 3px; background: rgba(255,255,255,0.6); margin-top: 2px; border-left: 3px solid #39ff14; }
    </style>
</head>
<body class="text-slate-800 antialiased flex flex-col h-screen w-screen overflow-hidden">

    <div id="welcome-screen">
        <div class="glass-panel p-8 rounded-3xl w-full max-w-md border-2 border-green-400 shadow-2xl text-center">
            <h1 class="text-3xl font-black text-purple-800 dark:text-green-400 tracking-tighter mb-6">PERSONAL SPACE</h1>
            <div class="space-y-4 text-left">
                <div>
                    <label class="block text-[10px] font-bold uppercase mb-1">Select Identity</label>
                    <select id="login-user-select" class="w-full bg-slate-100 dark:bg-slate-800 rounded-xl px-4 py-3 text-sm font-bold outline-none border-2 border-transparent focus:border-green-400 dark:text-white">
                        <option value="">Choose name...</option>
                        <option value="admin">â˜… System Admin</option>
                    </select>
                </div>
                <div>
                    <label class="block text-[10px] font-bold uppercase mb-1" id="pass-label">Password</label>
                    <input type="password" id="login-password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" class="w-full bg-slate-100 dark:bg-slate-800 rounded-xl px-4 py-3 text-sm outline-none border-2 border-transparent focus:border-green-400 dark:text-white">
                    <p id="first-login-hint" class="text-[10px] text-green-500 mt-1 italic hidden">First login! Set your password above.</p>
                </div>
                <button onclick="attemptLogin()" class="w-full bg-green-500 hover:bg-green-400 text-black font-black py-4 rounded-xl transition uppercase tracking-widest">Enter Workspace</button>
            </div>
        </div>
    </div>

    <div class="absolute top-0 left-1/2 transform -translate-x-1/2 bg-purple-900 text-white px-3 py-1 text-[10px] rounded-b-lg z-50 font-bold border border-green-400" id="connection-status">
        Connecting...
    </div>

    <div class="flex flex-1 overflow-hidden relative">
        <aside class="sidebar w-64 flex-shrink-0 flex flex-col justify-between h-full z-20">
            <div class="p-6 text-white"><h1 class="text-2xl font-bold text-green-400">PersonalSpace</h1></div>

            <div class="px-4 mb-4">
                <div id="user-display-tag" class="w-full bg-purple-900/50 border border-purple-500/30 rounded px-2 py-2 text-sm text-white font-bold flex items-center justify-between">
                    <span id="active-user-name">Admin</span>
                    <button onclick="logout()" class="text-[9px] bg-red-500 text-white px-2 py-0.5 rounded">Logout</button>
                </div>
            </div>

            <nav class="flex-1 px-4 space-y-2">
                <button onclick="switchView('dashboard')" id="nav-dashboard" class="nav-item w-full flex items-center gap-3 text-white px-4 py-3 rounded-r-lg active"><i class="fas fa-home"></i> Dashboard</button>
                <button onclick="switchView('kanban')" id="nav-kanban" class="nav-item w-full flex items-center gap-3 text-white px-4 py-3 rounded-r-lg"><i class="fas fa-tasks"></i> Task Tracker</button>
            </nav>

            <div class="p-4 border-t border-purple-500/30">
                <h3 class="text-xs font-bold text-green-400 uppercase mb-3 flex justify-between">Team Members <span id="member-count">0</span></h3>
                <div id="admin-tools-members" class="admin-only flex gap-2 mb-3">
                    <input type="text" id="new-member-name" placeholder="Name..." class="w-full bg-white/10 border border-white/20 rounded px-2 py-1 text-sm text-white">
                    <button onclick="addMember()" class="bg-green-600 px-2 rounded text-black font-bold">+</button>
                </div>
                <ul id="team-list" class="space-y-2 max-h-40 overflow-y-auto"></ul>
            </div>
            
            <div class="p-4 flex justify-between border-t border-purple-500/30">
                <button onclick="toggleTheme()" class="text-green-400"><i class="fas fa-moon" id="theme-icon"></i></button>
                <button onclick="clearAllData()" class="admin-only text-red-400 text-[10px]">Clear Data</button>
            </div>
        </aside>

        <main class="flex-1 relative flex flex-col bg-white/5 backdrop-blur-sm p-6 overflow-hidden">
            <div id="view-dashboard" class="flex-1 flex flex-col gap-4 overflow-hidden">
                <header class="flex justify-between items-center text-white">
                    <div><h1 class="text-3xl font-bold text-green-400" id="clock">00:00</h1><p id="date" class="text-sm">Date</p></div>
                    <div id="greeting" class="text-xl font-bold">Hello!</div>
                </header>

                <div class="grid grid-cols-10 gap-4 flex-1 overflow-hidden">
                    <div class="col-span-3 flex flex-col gap-4 overflow-hidden">
                        <div class="glass-panel rounded-2xl p-4 h-1/3 flex flex-col">
                            <h2 class="text-sm font-bold mb-2">Quick Notes</h2>
                            <textarea id="notepad" onchange="saveNotes(this.value)" class="flex-1 bg-transparent outline-none text-sm resize-none"></textarea>
                        </div>
                        <div class="glass-panel rounded-2xl p-4 flex-1 flex flex-col overflow-hidden">
                            <h2 class="text-sm font-bold mb-2">Quick Tasks</h2>
                            <div class="flex gap-2 mb-2">
                                <input type="text" id="quick-task-input" class="flex-1 bg-white/10 rounded px-2 py-1 text-xs">
                                <button onclick="addQuickTask()" class="bg-green-500 px-2 rounded">+</button>
                            </div>
                            <ul id="quick-task-list" class="flex-1 overflow-y-auto space-y-2"></ul>
                        </div>
                    </div>
                    <div class="col-span-7 glass-panel rounded-2xl p-4 flex flex-col overflow-hidden">
                        <div class="flex justify-between mb-2">
                            <h2 class="font-bold">Master Schedule</h2>
                            <div class="flex gap-4">
                                <button onclick="changeMonth(-1)">&lt;</button>
                                <span id="calendar-month-year" class="font-bold">...</span>
                                <button onclick="changeMonth(1)">&gt;</button>
                            </div>
                        </div>
                        <div id="calendar-body" class="calendar-grid flex-1 overflow-y-auto"></div>
                    </div>
                </div>
            </div>

            <div id="view-kanban" class="hidden flex-1 flex-col gap-4">
                <div class="grid grid-cols-3 gap-6 h-full">
                    <div class="glass-panel p-4 rounded-xl flex flex-col">
                        <h3 class="font-bold mb-4 border-b pb-2">To Do</h3>
                        <div id="kanban-todo" class="column-body flex-1 space-y-3" ondrop="drop(event, 'todo', 'status')" ondragover="allowDrop(event)"></div>
                    </div>
                    <div class="glass-panel p-4 rounded-xl flex flex-col">
                        <h3 class="font-bold mb-4 border-b pb-2">Doing</h3>
                        <div id="kanban-inprogress" class="column-body flex-1 space-y-3" ondrop="drop(event, 'inprogress', 'status')" ondragover="allowDrop(event)"></div>
                    </div>
                    <div class="glass-panel p-4 rounded-xl flex flex-col">
                        <h3 class="font-bold mb-4 border-b pb-2">Done</h3>
                        <div id="kanban-done" class="column-body flex-1 space-y-3" ondrop="drop(event, 'done', 'status')" ondragover="allowDrop(event)"></div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="calendar-modal" class="fixed inset-0 bg-black/80 hidden flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-2xl w-full max-w-sm">
            <h2 id="cal-date-title" class="font-bold mb-4">Date</h2>
            <div id="day-events-list" class="mb-4 space-y-2"></div>
            <input type="text" id="new-event-input" placeholder="New event..." class="w-full border p-2 rounded mb-4">
            <div class="flex justify-end gap-2">
                <button onclick="closeModal('calendar-modal')">Cancel</button>
                <button onclick="addEvent()" class="bg-green-500 px-4 py-2 rounded">Add</button>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCvfwF-_by5hoUIVoEowKwbzzKF3YkJWy0",
            authDomain: "personalspacehub-3a44d.firebaseapp.com",
            projectId: "personalspacehub-3a44d",
            storageBucket: "personalspacehub-3a44d.firebasestorage.app",
            databaseURL: "https://personalspacehub-3a44d-default-rtdb.firebaseio.com/"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        const store = {
            currentUser: null,
            users: [],
            passwords: {},
            kanbanTasks: [],
            events: {},
            notes: '',
            calendarMonth: new Date().getMonth(),
            calendarYear: new Date().getFullYear()
        };

        // UI LISTENERS
        document.getElementById('login-user-select').addEventListener('change', function() {
            const u = this.value;
            document.getElementById('first-login-hint').classList.toggle('hidden', (u === 'admin' || (store.passwords && store.passwords[u])));
        });

        // CORE FUNCTIONS
        function attemptLogin() {
            const u = document.getElementById('login-user-select').value;
            const p = document.getElementById('login-password').value;
            if(!u || !p) return alert("Missing info");

            if(u === 'admin') {
                if(p === 'admin123') loginSuccess(null);
                else alert("Wrong Admin Pass");
            } else {
                if(!store.passwords || !store.passwords[u]) {
                    if(!store.passwords) store.passwords = {};
                    store.passwords[u] = p;
                    db.ref('projectData/passwords').set(store.passwords);
                    loginSuccess(u);
                } else if(store.passwords[u] === p) {
                    loginSuccess(u);
                } else {
                    alert("Wrong Password");
                }
            }
        }

        function loginSuccess(u) {
            store.currentUser = u;
            document.getElementById('active-user-name').textContent = u || "Admin";
            document.getElementById('welcome-screen').classList.add('hidden');
            updateUIForUser();
            renderCalendar();
            renderKanbanBoard();
        }

        function logout() { location.reload(); }

        function switchUser(u) { store.currentUser = u; updateUIForUser(); }

        function updateUIForUser() {
            const isAdmin = !store.currentUser;
            document.querySelectorAll('.admin-only').forEach(el => el.style.display = isAdmin ? 'flex' : 'none');
            document.getElementById('greeting').textContent = "Hello, " + (store.currentUser || "Admin");
        }

        // FIREBASE LISTENER
        db.ref('projectData').on('value', snap => {
            const d = snap.val() || {};
            store.users = d.users || [];
            store.passwords = d.passwords || {};
            store.kanbanTasks = d.kanbanTasks || [];
            store.events = d.events || {};
            
            updateLoginUserSelect();
            renderTeamList();
            renderKanbanBoard();
            renderCalendar();
            document.getElementById('connection-status').textContent = "Cloud Connected";
        });

        function addMember() {
            const n = document.getElementById('new-member-name').value.trim();
            if(n && !store.users.includes(n)) {
                store.users.push(n);
                db.ref('projectData/users').set(store.users);
                document.getElementById('new-member-name').value = '';
            }
        }

        function removeMember(idx) {
            const u = store.users[idx];
            store.users.splice(idx, 1);
            if(store.passwords && store.passwords[u]) delete store.passwords[u];
            db.ref('projectData/users').set(store.users);
            db.ref('projectData/passwords').set(store.passwords || {});
        }

        function renderTeamList() {
            const list = document.getElementById('team-list');
            list.innerHTML = '';
            document.getElementById('member-count').textContent = store.users.length;
            store.users.forEach((u, i) => {
                const li = document.createElement('li');
                li.className = "flex justify-between items-center bg-white/5 p-2 rounded text-white text-sm group";
                li.innerHTML = `<span>${u}</span>
                    <div class="opacity-0 group-hover:opacity-100 flex gap-2">
                        <button onclick="resetPass('${u}')" class="text-yellow-400">ðŸ”‘</button>
                        <button onclick="removeMember(${i})" class="text-red-400">Ã—</button>
                    </div>`;
                list.appendChild(li);
            });
        }

        function resetPass(u) {
            if(confirm("Reset pass for " + u + "?")) {
                delete store.passwords[u];
                db.ref('projectData/passwords').set(store.passwords);
            }
        }

        function updateLoginUserSelect() {
            const s = document.getElementById('login-user-select');
            const cur = s.value;
            s.innerHTML = '<option value="">Choose name...</option><option value="admin">â˜… System Admin</option>';
            store.users.forEach(u => {
                const o = document.createElement('option');
                o.value = u; o.textContent = u;
                s.appendChild(o);
            });
            s.value = cur;
        }

        // CALENDAR
        function renderCalendar() {
            const grid = document.getElementById('calendar-body');
            grid.innerHTML = '';
            const first = new Date(store.calendarYear, store.calendarMonth, 1).getDay();
            const days = new Date(store.calendarYear, store.calendarMonth + 1, 0).getDate();
            
            document.getElementById('calendar-month-year').textContent = new Date(store.calendarYear, store.calendarMonth).toLocaleString('default', { month: 'long', year: 'numeric' });

            for(let i=0; i<first; i++) grid.appendChild(document.createElement('div'));
            
            for(let d=1; d<=days; d++) {
                const dateKey = `${store.calendarYear}-${store.calendarMonth}-${d}`;
                const el = document.createElement('div');
                el.className = "calendar-day";
                const today = new Date();
                if(d === today.getDate() && store.calendarMonth === today.getMonth()) el.classList.add('today');
                
                el.innerHTML = `<div class="font-bold">${d}</div>`;
                const evs = store.events[dateKey] || [];
                evs.forEach(ev => {
                    const div = document.createElement('div');
                    div.className = "cal-event-item";
                    div.textContent = (typeof ev === 'string' ? JSON.parse(ev).text : ev.text);
                    el.appendChild(div);
                });
                el.onclick = () => openCalendar(dateKey);
                grid.appendChild(el);
            }
        }

        function openCalendar(key) {
            document.getElementById('calendar-modal').classList.remove('hidden');
            document.getElementById('cal-date-title').textContent = key;
            renderEvents(key);
        }

        function renderEvents(key) {
            const list = document.getElementById('day-events-list');
            list.innerHTML = '';
            const evs = store.events[key] || [];
            evs.forEach((ev, i) => {
                const text = (typeof ev === 'string' ? JSON.parse(ev).text : ev.text);
                const d = document.createElement('div');
                d.className = "flex justify-between text-sm p-1 border-b";
                d.innerHTML = `<span>${text}</span><button onclick="delEv('${key}', ${i})">Ã—</button>`;
                list.appendChild(d);
            });
        }

        function addEvent() {
            const k = document.getElementById('cal-date-title').textContent;
            const v = document.getElementById('new-event-input').value;
            if(!v) return;
            if(!store.events[k]) store.events[k] = [];
            store.events[k].push(JSON.stringify({text: v}));
            db.ref('projectData/events').set(store.events);
            document.getElementById('new-event-input').value = '';
            renderEvents(k);
        }

        function delEv(k, i) {
            store.events[k].splice(i,1);
            db.ref('projectData/events').set(store.events);
            renderEvents(k);
        }

        // TASKS
        function renderKanbanBoard() {
            ['todo', 'inprogress', 'done'].forEach(s => {
                const con = document.getElementById('kanban-' + s);
                con.innerHTML = '';
                const tasks = store.kanbanTasks.filter(t => t.status === s && (!store.currentUser || t.assignee === store.currentUser));
                tasks.forEach(t => {
                    const d = document.createElement('div');
                    d.className = "bg-white p-2 rounded shadow text-sm cursor-pointer";
                    d.draggable = true;
                    d.ondragstart = (e) => draggedItem = t.id;
                    d.innerHTML = `<b>${t.title}</b><br><small>${t.assignee}</small>`;
                    con.appendChild(d);
                });
            });
        }

        function addQuickTask() {
            const v = document.getElementById('quick-task-input').value;
            if(!v) return;
            store.kanbanTasks.push({id: Date.now().toString(), title: v, status: 'todo', assignee: store.currentUser || 'Unassigned'});
            db.ref('projectData/kanbanTasks').set(store.kanbanTasks);
            document.getElementById('quick-task-input').value = '';
        }

        // UTILS
        function switchView(v) {
            document.getElementById('view-dashboard').classList.toggle('hidden', v !== 'dashboard');
            document.getElementById('view-kanban').classList.toggle('hidden', v !== 'kanban');
            document.querySelectorAll('.nav-item').forEach(n => n.classList.toggle('active', n.id === 'nav-' + v));
        }

        function updateClock() { document.getElementById('clock').textContent = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}); }
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
        function changeMonth(n) { store.calendarMonth += n; renderCalendar(); }
        function allowDrop(e) { e.preventDefault(); }
        function drop(e, s) {
            const t = store.kanbanTasks.find(x => x.id === draggedItem);
            if(t) { t.status = s; db.ref('projectData/kanbanTasks').set(store.kanbanTasks); }
        }
        function clearAllData() { if(confirm("Clear everything?")) db.ref('projectData').remove(); }
        function toggleTheme() { document.body.classList.toggle('dark'); }
    </script>
</body>
</html>