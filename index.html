<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PersonalSpace - Project Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/dark.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-analytics-compat.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        glass: "rgba(255, 255, 255, 0.95)",
                        darkGlass: "rgba(30, 41, 59, 0.95)",
                        sidebar: "rgba(36, 0, 70, 0.85)",
                        jokerPurple: "#3c096c",
                        jokerGreen: "#39ff14"
                    }
                }
            }
        }
    </script>

    <style>
        body { background: linear-gradient(135deg, #9d4edd, #70e000); min-height: 100vh; transition: background 0.5s ease; overflow: hidden; font-family: 'Inter', sans-serif; }
        .dark body { background: linear-gradient(135deg, #10002b, #004b23); }
        .glass-panel { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(12px); border: 1px solid rgba(157, 78, 221, 0.3); box-shadow: 0 8px 32px 0 rgba(60, 9, 108, 0.2); }
        .dark .glass-panel { background: rgba(20, 10, 40, 0.85); color: #e2e8f0; border: 1px solid rgba(57, 255, 20, 0.1); }
        .sidebar { background: rgba(36, 0, 70, 0.7); backdrop-filter: blur(20px); border-right: 1px solid rgba(255,255,255,0.1); }
        .nav-item.active { background: rgba(255, 255, 255, 0.1); border-left: 4px solid #39ff14; color: #39ff14; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); border-top: 1px solid #e2e8f0; border-left: 1px solid #e2e8f0; }
        .calendar-day { min-height: 80px; max-height: 110px; overflow-y: auto; padding: 4px; font-size: 0.85rem; cursor: pointer; border-right: 1px solid #e2e8f0; border-bottom: 1px solid #e2e8f0; background: rgba(255,255,255,0.4); }
        .cal-event-item { font-size: 0.65rem; padding: 4px 5px; border-radius: 3px; background: rgba(255, 255, 255, 0.6); margin-top: 2px; border-left: 3px solid #ccc; display: flex; flex-direction: column; }
        .cal-urgency-high { border-left-color: #ef4444 !important; background: rgba(239, 68, 68, 0.1); }
        .cal-task-critical { border-left-color: #f97316 !important; background: rgba(249, 115, 22, 0.15) !important; border-style: dashed; }
        #login-overlay { background: #10002b; z-index: 200; }
    </style>
</head>
<body class="text-slate-800 antialiased flex flex-col h-screen w-screen overflow-hidden">

    <div id="login-overlay" class="fixed inset-0 flex items-center justify-center transition-opacity duration-500">
        <div class="glass-panel p-8 rounded-3xl w-full max-w-sm border-2 border-jokerPurple">
            <div class="text-center mb-6">
                <h1 class="text-3xl font-bold text-jokerGreen">PersonalSpace</h1>
                <p class="text-white/50 text-xs uppercase tracking-widest">Team Portal</p>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="text-[10px] text-purple-400 font-bold uppercase ml-1">Identity</label>
                    <select id="login-username" class="w-full bg-white/10 border border-white/20 rounded-xl px-4 py-3 text-white outline-none">
                        <option value="Team Lead">★ Team Lead</option>
                    </select>
                </div>
                <div>
                    <label class="text-[10px] text-purple-400 font-bold uppercase ml-1">Password</label>
                    <input type="password" id="login-password" placeholder="••••••••" class="w-full bg-white/10 border border-white/20 rounded-xl px-4 py-3 text-white outline-none">
                </div>
                <button onclick="handleLogin()" class="w-full bg-jokerGreen hover:bg-green-400 text-black font-black py-3 rounded-xl transition">ACCESS SYSTEM</button>
            </div>
        </div>
    </div>

    <div class="absolute top-0 left-1/2 -translate-x-1/2 bg-purple-900 text-white px-3 py-1 text-[10px] rounded-b-lg shadow-lg z-50 font-bold border border-green-400" id="connection-status">
        Connecting...
    </div>

    <input type="file" id="avatar-upload" class="hidden" accept="image/*" onchange="handleAvatarFile(this)">

    <div class="flex flex-1 overflow-hidden relative">
        <aside class="sidebar w-64 flex-shrink-0 flex flex-col justify-between h-full z-20">
            <div class="p-6 text-white">
                <h1 class="text-2xl font-bold tracking-wider text-green-400">PersonalSpace</h1>
                <p class="text-xs text-white/60 uppercase">Project Hub</p>
            </div>

            <div class="px-4 mb-4">
                <label class="text-[10px] text-green-400/80 uppercase font-bold block mb-1">Signed In As:</label>
                <div class="w-full bg-purple-900/50 border border-purple-500/30 rounded px-3 py-2 text-sm text-white flex justify-between items-center">
                    <span id="current-user-name">Team Lead</span>
                    <button onclick="logout()" class="text-red-400"><i class="fas fa-sign-out-alt"></i></button>
                </div>
            </div>

            <nav class="flex-1 px-4 space-y-2">
                <button onclick="switchView('dashboard')" id="nav-dashboard" class="nav-item w-full flex items-center gap-3 text-white px-4 py-3 rounded-r-lg active"><i class="fas fa-home w-5"></i> Dashboard</button>
                <button onclick="switchView('kanban')" id="nav-kanban" class="nav-item w-full flex items-center gap-3 text-white px-4 py-3 rounded-r-lg"><i class="fas fa-tasks w-5"></i> Task Tracker</button>
            </nav>

            <div class="p-4 border-t border-purple-500/30">
                <h3 class="text-xs font-bold text-green-400 uppercase mb-3 flex justify-between items-center">Team Members <span id="member-count" class="bg-purple-800 px-2 rounded-full text-[10px]">0</span></h3>
                <div id="admin-tools-members" class="admin-only flex gap-2 mb-3">
                    <input type="text" id="new-member-name" placeholder="Name..." class="w-full bg-white/10 rounded px-2 py-1 text-sm text-white">
                    <button onclick="addMember()" class="bg-green-600 px-2 rounded"><i class="fas fa-plus"></i></button>
                </div>
                <ul id="team-list" class="space-y-2 max-h-40 overflow-y-auto pr-1"></ul>
            </div>

            <div class="p-4 flex flex-col gap-3 border-t border-purple-500/30">
                <div class="flex justify-between items-center">
                    <button onclick="changeMyPassword()" class="text-[10px] text-amber-400"><i class="fas fa-lock"></i> Update Pass</button>
                    <button onclick="toggleTheme()" class="text-green-400 transition text-xs"><i class="fas fa-moon" id="theme-icon"></i></button>
                </div>
                <div class="admin-only flex gap-2">
                    <button onclick="backupData()" class="bg-purple-500/20 text-purple-200 text-[10px] py-1 px-2 rounded w-full">Backup</button>
                    <button onclick="clearAllData()" class="bg-red-500/20 text-red-200 text-[10px] py-1 px-2 rounded w-full">Nuke</button>
                </div>
            </div>
        </aside>

        <main class="flex-1 overflow-hidden flex flex-col bg-white/5">
            <div id="view-dashboard" class="flex-1 p-6 h-full flex flex-col overflow-y-auto">
                <header class="mb-4 flex justify-between items-center text-white">
                    <div>
                        <h1 class="text-3xl font-bold text-green-400" id="clock">00:00</h1>
                        <p class="text-sm font-bold" id="date">Date</p>
                    </div>
                    <div class="flex items-center gap-4">
                        <div class="text-right">
                            <p class="text-lg font-bold" id="greeting">Hello, Team Lead</p>
                            <span id="dashboard-owner-badge" class="bg-green-500 text-black px-2 py-0.5 rounded-full text-[10px] font-bold uppercase">Lead Workspace</span>
                        </div>
                        <div id="header-avatar" class="w-14 h-14 rounded-full bg-purple-900 border-2 border-green-400 flex items-center justify-center cursor-pointer" onclick="triggerAvatarUpload('Team Lead')">
                            <i class="fas fa-user-shield text-white/50 text-2xl"></i>
                        </div>
                    </div>
                </header>

                <div class="grid grid-cols-1 lg:grid-cols-10 gap-4 flex-1">
                    <div class="lg:col-span-3 flex flex-col gap-4">
                        <div class="glass-panel rounded-2xl p-4 h-64 flex flex-col">
                            <h2 class="text-sm font-bold mb-2 text-purple-700"><i class="fas fa-sticky-note"></i> Private Notes</h2>
                            <textarea id="notepad" class="flex-1 bg-transparent p-2 text-sm outline-none dark:text-slate-200" onchange="saveNotes(this.value)"></textarea>
                        </div>

                        <div class="glass-panel rounded-2xl p-4 h-64 flex flex-col">
                            <h2 id="comms-title" class="text-sm font-bold mb-2 text-amber-600"><i class="fas fa-user-shield"></i> Comms</h2>
                            <div id="member-note-view" class="flex-1 flex flex-col">
                                <textarea id="admin-note-input" class="flex-1 bg-amber-50/20 rounded-lg p-3 text-sm outline-none" placeholder="Note to Team Lead..." onchange="saveAdminNote(this.value)"></textarea>
                            </div>
                            <div id="admin-note-view" class="hidden flex-1 overflow-y-auto space-y-2">
                                <div id="admin-notes-list"></div>
                            </div>
                        </div>
                    </div>

                    <div class="lg:col-span-7 glass-panel rounded-2xl p-4 flex flex-col">
                        <div class="flex justify-between items-center mb-2">
                            <h2 class="text-sm font-bold text-purple-700"><i class="fas fa-calendar-alt"></i> Calendar</h2>
                            <div class="flex gap-2 text-xs">
                                <button onclick="changeMonth(-1)"><i class="fas fa-chevron-left"></i></button>
                                <span id="calendar-month-year" class="font-bold">Month</span>
                                <button onclick="changeMonth(1)"><i class="fas fa-chevron-right"></i></button>
                            </div>
                        </div>
                        <div id="calendar-body" class="calendar-grid flex-1"></div>
                    </div>
                </div>
            </div>

            <div id="view-kanban" class="flex-1 p-6 hidden flex-col h-full overflow-y-auto">
                 <div class="flex justify-between mb-6">
                    <h2 class="text-2xl font-bold text-green-400">Task Tracker</h2>
                    <button onclick="openTaskModal()" class="bg-green-500 text-black px-4 py-2 rounded-lg font-bold">New Task</button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 h-full">
                    <div class="glass-panel rounded-xl flex flex-col"><h3 class="p-3 font-bold border-b">To Do</h3><div class="column-body p-3 flex-1" ondrop="drop(event, 'todo')" ondragover="allowDrop(event)"></div></div>
                    <div class="glass-panel rounded-xl flex flex-col"><h3 class="p-3 font-bold border-b border-purple-500">Doing</h3><div class="column-body p-3 flex-1" ondrop="drop(event, 'inprogress')" ondragover="allowDrop(event)"></div></div>
                    <div class="glass-panel rounded-xl flex flex-col"><h3 class="p-3 font-bold border-b border-green-500">Executed</h3><div class="column-body p-3 flex-1" ondrop="drop(event, 'done')" ondragover="allowDrop(event)"></div></div>
                </div>
            </div>
        </main>
    </div>

    <div id="task-modal" class="fixed inset-0 bg-black/80 hidden flex items-center justify-center z-50 p-4">
        <div class="bg-white dark:bg-slate-800 rounded-2xl w-full max-w-md p-6 border-2 border-purple-500">
            <h2 class="text-xl font-bold mb-4">Task Details</h2>
            <input type="hidden" id="task-id">
            <input type="text" id="task-title" placeholder="Title" class="w-full bg-slate-100 dark:bg-slate-700 p-3 rounded-lg mb-3">
            <div class="grid grid-cols-2 gap-3 mb-3">
                <select id="task-assignee" class="bg-slate-100 dark:bg-slate-700 p-3 rounded-lg"></select>
                <input type="date" id="task-date" class="bg-slate-100 dark:bg-slate-700 p-3 rounded-lg">
            </div>
            <div class="mb-3">
                <label class="text-xs font-bold uppercase">Priority (1-5)</label>
                <input type="number" id="task-priority" value="1" min="1" max="5" class="w-full bg-slate-100 dark:bg-slate-700 p-3 rounded-lg">
            </div>
            <div class="flex justify-end gap-2">
                <button onclick="closeModal('task-modal')" class="px-4 py-2">Cancel</button>
                <button onclick="saveTask()" class="bg-purple-600 text-white px-6 py-2 rounded-lg">Save</button>
            </div>
        </div>
    </div>

    <div id="calendar-modal" class="fixed inset-0 bg-black/80 hidden flex items-center justify-center z-50 p-4">
        <div class="bg-white dark:bg-slate-800 rounded-2xl w-full max-w-sm p-6 border border-purple-500">
            <h2 class="text-lg font-bold" id="cal-date-title">Date</h2>
            <input type="hidden" id="cal-date-val">
            <div id="day-events-list" class="my-4 space-y-2 max-h-40 overflow-y-auto"></div>
            <input type="text" id="new-event-input" placeholder="Event details..." class="w-full bg-slate-100 dark:bg-slate-700 p-2 rounded-lg mb-2">
            <button onclick="addEvent()" class="bg-green-500 w-full p-2 rounded-lg font-bold">Add Event</button>
            <button onclick="closeModal('calendar-modal')" class="text-sm mt-4 w-full">Close</button>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCvfwF-_by5hoUIVoEowKwbzzKF3YkJWy0",
            authDomain: "personalspacehub-3a44d.firebaseapp.com",
            projectId: "personalspacehub-3a44d",
            storageBucket: "personalspacehub-3a44d.firebasestorage.app",
            messagingSenderId: "605942768680",
            appId: "1:605942768680:web:74702b5d902dd462f1811d",
            databaseURL: "https://personalspacehub-3a44d-default-rtdb.firebaseio.com/"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        const store = {
            theme: localStorage.getItem('nexus_theme') || 'light',
            currentUser: null,
            users: [],
            kanbanTasks: [],
            avatars: {}, 
            allUserData: {},
            passwords: {},
            calendarMonth: new Date().getMonth(),
            calendarYear: new Date().getFullYear(),
        };

        let draggedItem = null;

        document.addEventListener('DOMContentLoaded', () => {
            loadTheme(); updateClock(); setInterval(updateClock, 1000);
            db.ref('projectData').on('value', (snap) => {
                const data = snap.val();
                if(data) {
                    store.users = data.users || [];
                    store.kanbanTasks = data.kanbanTasks || [];
                    store.avatars = data.avatars || {};
                    store.passwords = data.passwords || { "Team Lead": "1234" };
                    store.allUserData = data.userData || {};
                    renderTeamList(); renderKanbanBoard(); renderCalendar();
                    updateDashboardUI(); updateUIForUser(); updateLoginDropdown();

                    const saved = localStorage.getItem('ps_session_user');
                    if (saved && !store.currentUser) {
                        switchUser(saved === "Team Lead" ? "" : saved);
                        document.getElementById('login-overlay').classList.add('hidden');
                    }
                }
            });
        });

        function handleLogin() {
            const user = document.getElementById('login-username').value;
            const pass = document.getElementById('login-password').value;
            if (pass === (store.passwords[user] || "1234")) {
                document.getElementById('login-overlay').classList.add('hidden');
                switchUser(user === "Team Lead" ? "" : user);
                localStorage.setItem('ps_session_user', user);
            }
        }

        function switchUser(name) {
            store.currentUser = name || null;
            const displayName = name || "Team Lead";
            document.getElementById('current-user-name').textContent = displayName;
            updateUIForUser(); updateDashboardUI(); renderCalendar(); renderKanbanBoard();
        }

        function updateUIForUser() {
            const isLead = !store.currentUser;
            const name = store.currentUser || "Team Lead";
            document.querySelectorAll('.admin-only').forEach(el => el.style.display = isLead ? '' : 'none');
            
            document.getElementById('member-note-view').style.display = isLead ? 'none' : 'flex';
            document.getElementById('admin-note-view').style.display = isLead ? 'flex' : 'none';
            document.getElementById('comms-title').innerHTML = isLead ? '<i class="fas fa-user-shield"></i> Member Feedback' : '<i class="fas fa-user-shield"></i> Note to Team Lead';

            document.getElementById('dashboard-owner-badge').textContent = isLead ? "Lead Workspace" : `${name}'s Workspace`;
            document.getElementById('greeting').textContent = `Hello, ${name}`;
            
            const avatarContainer = document.getElementById('header-avatar');
            if (store.avatars[name]) avatarContainer.innerHTML = `<img src="${store.avatars[name]}" class="w-full h-full object-cover rounded-full">`;
            else avatarContainer.innerHTML = `<i class="fas ${isLead ? 'fa-user-shield' : 'fa-user'} text-white/50 text-2xl"></i>`;
        }

        function updateDashboardUI() {
            const userKey = (store.currentUser || "Team Lead").replace(/[^a-zA-Z0-9]/g, '_');
            const userData = store.allUserData[userKey] || {};
            document.getElementById('notepad').value = userData.notes || '';
            document.getElementById('admin-note-input').value = userData.adminNote || '';
            
            if (!store.currentUser) {
                const list = document.getElementById('admin-notes-list');
                list.innerHTML = '';
                Object.keys(store.allUserData).forEach(key => {
                    const uData = store.allUserData[key];
                    if (uData.adminNote && key !== 'Team_Lead') {
                        list.innerHTML += `<div class="p-2 bg-amber-50 rounded border-l-2 border-amber-500 mb-2">
                            <span class="text-[10px] font-bold text-amber-600">${key.replace(/_/g, ' ')}</span>
                            <p class="text-xs text-slate-700">${uData.adminNote}</p>
                        </div>`;
                    }
                });
            }
        }

        function saveNotes(val) { updateUserDataCloud('notes', val); }
        function saveAdminNote(val) { updateUserDataCloud('adminNote', val); }

        function updateUserDataCloud(field, val) {
            const userKey = (store.currentUser || "Team Lead").replace(/[^a-zA-Z0-9]/g, '_');
            db.ref(`projectData/userData/${userKey}`).update({ [field]: val });
        }

        function pushToCloud() {
            db.ref('projectData').update({ users: store.users, kanbanTasks: store.kanbanTasks, avatars: store.avatars, passwords: store.passwords });
        }

        // Calendar
        function renderCalendar() {
            const months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
            document.getElementById('calendar-month-year').textContent = `${months[store.calendarMonth]} ${store.calendarYear}`;
            const firstDay = new Date(store.calendarYear, store.calendarMonth, 1).getDay();
            const daysInMonth = new Date(store.calendarYear, store.calendarMonth + 1, 0).getDate();
            const grid = document.getElementById('calendar-body');
            grid.innerHTML = '';

            for(let i=0; i<firstDay; i++) grid.innerHTML += `<div class="bg-slate-50/50 border-r border-b"></div>`;

            const userKey = (store.currentUser || "Team Lead").replace(/[^a-zA-Z0-9]/g, '_');
            const myEvents = (store.allUserData[userKey] || {}).events || {};

            for(let d=1; d<=daysInMonth; d++) {
                const dateKey = `${store.calendarYear}-${String(store.calendarMonth+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                const el = document.createElement('div');
                el.className = 'calendar-day';
                el.innerHTML = `<div>${d}</div>`;
                
                (myEvents[dateKey] || []).forEach(evt => {
                    const data = JSON.parse(evt);
                    el.innerHTML += `<div class="cal-event-item"><span>${data.text}</span></div>`;
                });

                store.kanbanTasks.filter(t => t.assignedDate === dateKey && t.priority >= 4 && t.status !== 'done' && (!store.currentUser || t.assignee === store.currentUser))
                .forEach(task => {
                    const label = store.currentUser ? "TASK" : `TASK (${task.assignee})`;
                    el.innerHTML += `<div class="cal-event-item cal-task-critical"><span class="text-orange-500 font-bold">${label}</span><span>${task.title}</span></div>`;
                });

                el.onclick = () => openCalendarModal(dateKey);
                grid.appendChild(el);
            }
        }

        function openCalendarModal(dateStr) {
            document.getElementById('calendar-modal').classList.remove('hidden');
            document.getElementById('cal-date-title').textContent = new Date(dateStr).toDateString();
            document.getElementById('cal-date-val').value = dateStr;
            renderDayEvents(dateStr);
        }

        function renderDayEvents(dateStr) {
            const list = document.getElementById('day-events-list');
            list.innerHTML = '';
            const userKey = (store.currentUser || "Team Lead").replace(/[^a-zA-Z0-9]/g, '_');
            const events = ((store.allUserData[userKey] || {}).events || {})[dateStr] || [];
            events.forEach((evt, idx) => {
                const data = JSON.parse(evt);
                list.innerHTML += `<div class="flex justify-between bg-slate-100 p-2 rounded text-xs mb-1">
                    <div>${data.text}</div>
                    <button onclick="deleteEvent('${dateStr}', ${idx})" class="text-red-400 ml-2"><i class="fas fa-trash"></i></button>
                </div>`;
            });
        }

        function addEvent() {
            const val = document.getElementById('new-event-input').value.trim();
            if (!val) return;
            const dateKey = document.getElementById('cal-date-val').value;
            const userKey = (store.currentUser || "Team Lead").replace(/[^a-zA-Z0-9]/g, '_');
            const events = (store.allUserData[userKey] || {}).events || {};
            if (!events[dateKey]) events[dateKey] = [];
            events[dateKey].push(JSON.stringify({ text: val }));
            db.ref(`projectData/userData/${userKey}/events`).set(events);
            document.getElementById('new-event-input').value = ''; renderDayEvents(dateKey); renderCalendar();
        }

        function deleteEvent(date, idx) {
            const userKey = (store.currentUser || "Team Lead").replace(/[^a-zA-Z0-9]/g, '_');
            const events = store.allUserData[userKey].events;
            events[date].splice(idx, 1);
            db.ref(`projectData/userData/${userKey}/events`).set(events);
            renderDayEvents(date); renderCalendar();
        }

        // Tasks
        function renderKanbanBoard() {
            ['todo', 'inprogress', 'done'].forEach(s => {
                const container = document.querySelector(`[ondrop="drop(event, '${s}')"]`);
                container.innerHTML = '';
                store.kanbanTasks.filter(t => t.status === s && (!store.currentUser || t.assignee === store.currentUser))
                .forEach(t => {
                    const el = document.createElement('div');
                    el.className = 'bg-white p-3 rounded shadow-sm border mb-2 cursor-grab';
                    el.draggable = true; el.ondragstart = () => draggedItem = t.id;
                    el.innerHTML = `<div class="flex justify-between font-bold text-sm"><span>${t.title}</span><button onclick="openTaskModal('${t.id}')"><i class="fas fa-pen text-[10px]"></i></button></div>
                        <div class="text-[10px] opacity-60">${t.assignee}</div>`;
                    container.appendChild(el);
                });
            });
        }

        function openTaskModal(id) {
            document.getElementById('task-modal').classList.remove('hidden');
            const t = store.kanbanTasks.find(x => x.id === id) || {title:'', assignee: (store.currentUser || 'Team Lead'), priority:1, assignedDate:''};
            document.getElementById('task-id').value = id || '';
            document.getElementById('task-title').value = t.title;
            document.getElementById('task-assignee').value = t.assignee;
            document.getElementById('task-date').value = t.assignedDate;
            document.getElementById('task-priority').value = t.priority;
        }

        function saveTask() {
            const id = document.getElementById('task-id').value;
            const data = { title: document.getElementById('task-title').value, assignee: document.getElementById('task-assignee').value, priority: parseInt(document.getElementById('task-priority').value), assignedDate: document.getElementById('task-date').value };
            if(id) Object.assign(store.kanbanTasks.find(x => x.id === id), data);
            else store.kanbanTasks.push({ id: Date.now().toString(), ...data, status: 'todo' });
            pushToCloud(); closeModal('task-modal');
        }

        // Utils
        function updateClock() { document.getElementById('clock').textContent = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', hourCycle:'h23'}); document.getElementById('date').textContent = new Date().toLocaleDateString(undefined, {weekday:'long', month:'long', day:'numeric'}); }
        function logout() { localStorage.removeItem('ps_session_user'); location.reload(); }
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
        function switchView(v) { ['dashboard', 'kanban'].forEach(x => { document.getElementById(`view-${x}`).classList.add('hidden'); document.getElementById(`nav-${x}`).classList.remove('active'); }); document.getElementById(`view-${v}`).classList.remove('hidden'); document.getElementById(`nav-${v}`).classList.add('active'); }
        function toggleTheme() { store.theme = store.theme === 'light' ? 'dark' : 'light'; localStorage.setItem('nexus_theme', store.theme); loadTheme(); }
        function loadTheme() { document.body.classList.toggle('dark', store.theme === 'dark'); }
        function updateLoginDropdown() { const s = document.getElementById('login-username'); s.innerHTML = '<option value="Team Lead">★ Team Lead</option>'; store.users.forEach(u => s.add(new Option(u, u))); }
        function renderTeamList() { 
            const list = document.getElementById('team-list'); list.innerHTML = ''; 
            document.getElementById('member-count').textContent = store.users.length;
            const dropdown = document.getElementById('task-assignee');
            dropdown.innerHTML = '<option value="Team Lead">Team Lead</option>';
            store.users.forEach(u => {
                list.innerHTML += `<li class="text-white/80 text-sm bg-white/5 p-2 rounded">${u}</li>`;
                dropdown.add(new Option(u, u));
            });
        }
        function changeMonth(d) { store.calendarMonth += d; if(store.calendarMonth > 11) { store.calendarMonth = 0; store.calendarYear++; } else if(store.calendarMonth < 0) { store.calendarMonth = 11; store.calendarYear--; } renderCalendar(); }
        function allowDrop(e) { e.preventDefault(); }
        function drop(e, s) { e.preventDefault(); if(draggedItem) { store.kanbanTasks.find(x => x.id === draggedItem).status = s; pushToCloud(); draggedItem = null; } }
        function addMember() { const n = document.getElementById('new-member-name').value.trim(); if(n && !store.users.includes(n)) { store.users.push(n); pushToCloud(); document.getElementById('new-member-name').value=''; } }
        function backupData() { const blob = new Blob([JSON.stringify(store)], {type:'application/json'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download='backup.json'; a.click(); }
        function clearAllData() { if(confirm('Clear all?')) { db.ref('projectData').remove(); location.reload(); } }
    </script>
</body>
</html>