<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PersonalSpace - Secure Team Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/dark.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: { jokerPurple: "#3c096c", jokerGreen: "#39ff14" }
                }
            }
        }
    </script>

    <style>
        body { background: linear-gradient(135deg, #9d4edd, #70e000); min-height: 100vh; transition: background 0.5s ease; overflow: hidden; }
        .dark body { background: linear-gradient(135deg, #10002b, #004b23); }

        #welcome-screen { position: fixed; inset: 0; background: linear-gradient(135deg, #240046, #10002b); z-index: 100; display: flex; align-items: center; justify-content: center; }
        .glass-panel { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(12px); border: 1px solid rgba(157, 78, 221, 0.3); }
        .dark .glass-panel { background: rgba(20, 10, 40, 0.85); color: #e2e8f0; border: 1px solid rgba(57, 255, 20, 0.1); }
        
        .sidebar { background: rgba(36, 0, 70, 0.7); backdrop-filter: blur(20px); border-right: 1px solid rgba(255,255,255,0.1); }
        .nav-item.active { background: rgba(255, 255, 255, 0.1); border-left: 4px solid #39ff14; color: #39ff14; }
        .admin-only.hidden-tool { display: none !important; }

        /* Calendar grid matches image_a39504.jpg style */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); border-top: 1px solid rgba(255,255,255,0.1); }
        .calendar-day { min-height: 80px; padding: 4px; border-right: 1px solid rgba(255,255,255,0.1); border-bottom: 1px solid rgba(255,255,255,0.1); }
    </style>
</head>
<body class="text-slate-800 antialiased flex flex-col h-screen w-screen overflow-hidden">

    <div id="welcome-screen">
        <div class="glass-panel p-8 rounded-3xl w-full max-w-md text-center shadow-2xl border-2 border-green-400">
            <h1 class="text-4xl font-bold text-white mb-8 tracking-tighter">PersonalSpace</h1>
            <div id="login-step-1">
                <select id="login-user-select" class="w-full bg-purple-900/50 text-white border border-purple-500 rounded-lg p-3 mb-4 outline-none"></select>
                <button onclick="proceedToPin()" class="w-full bg-green-500 hover:bg-green-400 text-black font-bold py-3 rounded-lg transition">Next</button>
            </div>
            <div id="login-step-2" class="hidden">
                <p id="pin-prompt" class="text-white mb-4">Enter PIN</p>
                <input type="password" id="login-pin-input" maxlength="4" class="w-full bg-purple-900/50 text-white text-3xl text-center border border-purple-500 rounded-lg p-3 mb-4 outline-none">
                <div class="flex gap-2">
                    <button onclick="backToLogin()" class="flex-1 text-white/50 text-sm">Back</button>
                    <button onclick="attemptLogin()" class="flex-[2] bg-green-500 text-black font-bold py-3 rounded-lg">Unlock</button>
                </div>
            </div>
        </div>
    </div>

    <div class="flex flex-1 overflow-hidden relative">
        <aside class="sidebar w-64 flex-shrink-0 flex flex-col justify-between h-full z-20">
            <div class="p-6">
                <h1 class="text-2xl font-bold text-green-400">PersonalSpace</h1>
            </div>

            <nav class="flex-1 px-4 space-y-2">
                <button onclick="switchView('dashboard')" id="nav-dashboard" class="nav-item active w-full flex items-center gap-3 text-white px-4 py-3 rounded-r-lg"><i class="fas fa-home"></i> Dashboard</button>
                <button onclick="switchView('kanban')" id="nav-kanban" class="nav-item w-full flex items-center gap-3 text-white px-4 py-3 rounded-r-lg"><i class="fas fa-tasks"></i> Tasks</button>
            </nav>

            <div class="p-4 border-t border-purple-500/30">
                <div id="admin-tools-members" class="admin-only flex gap-2 mb-3">
                    <input type="text" id="new-member-name" placeholder="New Name..." class="w-full bg-white/10 border border-white/20 rounded px-2 py-1 text-xs text-white">
                    <button onclick="addMember()" class="bg-green-600 text-black px-2 rounded">+</button>
                </div>
                <ul id="team-list" class="space-y-2 max-h-40 overflow-y-auto"></ul>
            </div>

            <div class="p-4 border-t border-purple-500/30 space-y-3">
                <div class="flex justify-between items-center">
                    <button onclick="toggleTheme()" class="text-green-400 hover:text-white transition text-sm"><i class="fas fa-moon mr-2"></i> Dark Mode</button>
                    <button onclick="logout()" class="text-white/50 hover:text-white text-xs">Log Out</button>
                </div>
                <div id="admin-tools-data" class="admin-only border-t border-white/10 pt-3 flex flex-col gap-2">
                    <button onclick="backupData()" class="text-[10px] text-purple-300 text-left"><i class="fas fa-download mr-1"></i> Backup Cloud</button>
                    <button onclick="clearAllData()" class="text-[10px] text-red-400 text-left"><i class="fas fa-trash mr-1"></i> Nuke Cloud</button>
                </div>
            </div>
        </aside>

        <main class="flex-1 p-6 overflow-hidden flex flex-col">
            <div id="view-dashboard" class="flex-1 flex flex-col gap-4">
                <header class="flex justify-between items-center text-white">
                    <div>
                        <h1 class="text-3xl font-bold text-green-400" id="clock">00:00</h1>
                        <p id="date" class="text-xs opacity-70">Date</p>
                    </div>
                    <div class="flex items-center gap-3">
                        <div class="text-right">
                            <p id="greeting" class="font-bold">Hello</p>
                            <span id="dashboard-owner-badge" class="text-[9px] bg-green-500 text-black px-2 py-0.5 rounded-full font-bold uppercase">Space</span>
                        </div>
                        <div id="header-avatar" class="w-10 h-10 rounded-full bg-purple-900 border border-green-400 overflow-hidden flex items-center justify-center"></div>
                    </div>
                </header>

                <div class="grid grid-cols-10 gap-4 flex-1 overflow-hidden">
                    <div class="col-span-3 flex flex-col gap-4">
                        <div class="glass-panel p-4 rounded-2xl h-1/2 flex flex-col">
                            <h2 class="text-xs font-bold mb-2"><i class="fas fa-sticky-note mr-2"></i>Notes</h2>
                            <textarea id="notepad" class="flex-1 w-full bg-transparent border-none outline-none text-sm resize-none" onchange="saveNotes(this.value)"></textarea>
                        </div>
                        <div class="glass-panel p-4 rounded-2xl h-1/2 flex flex-col">
                            <h2 class="text-xs font-bold mb-2 text-green-500"><i class="fas fa-check-circle mr-2"></i>Tasks</h2>
                            <ul id="quick-task-list" class="flex-1 overflow-y-auto space-y-2"></ul>
                        </div>
                    </div>
                    <div class="glass-panel col-span-7 p-4 rounded-2xl flex flex-col">
                        <div class="flex justify-between mb-2">
                            <h2 class="text-xs font-bold"><i class="fas fa-calendar-alt mr-2"></i>Master Schedule</h2>
                            <span id="calendar-month-year" class="text-xs font-bold">Month</span>
                        </div>
                        <div id="calendar-body" class="calendar-grid flex-1 overflow-y-auto"></div>
                    </div>
                </div>
            </div>

            <div id="view-kanban" class="hidden flex-1 flex-col">
                <div class="flex justify-between mb-4">
                    <h2 class="text-xl font-bold text-white">Task Tracker</h2>
                    <button onclick="openTaskModal()" class="bg-green-500 text-black px-4 py-2 rounded-lg text-sm font-bold">+ New Task</button>
                </div>
                <div class="grid grid-cols-3 gap-6 flex-1 overflow-hidden">
                    <div class="glass-panel p-3 rounded-xl flex flex-col border-t-4 border-slate-400">
                        <h3 class="font-bold text-sm mb-3">To Do</h3>
                        <div id="col-todo" class="flex-1 overflow-y-auto space-y-3"></div>
                    </div>
                    <div class="glass-panel p-3 rounded-xl flex flex-col border-t-4 border-purple-500">
                        <h3 class="font-bold text-sm mb-3">In Progress</h3>
                        <div id="col-inprogress" class="flex-1 overflow-y-auto space-y-3"></div>
                    </div>
                    <div class="glass-panel p-3 rounded-xl flex flex-col border-t-4 border-green-500">
                        <h3 class="font-bold text-sm mb-3">Executed</h3>
                        <div id="col-done" class="flex-1 overflow-y-auto space-y-3"></div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="task-modal" class="fixed inset-0 bg-black/80 hidden flex items-center justify-center z-50">
        <div class="glass-panel p-6 rounded-2xl w-full max-w-sm">
            <h2 class="font-bold mb-4">New Task</h2>
            <input type="text" id="task-title" placeholder="Task name..." class="w-full p-2 mb-4 bg-white/10 border border-white/20 rounded text-sm text-white">
            <select id="task-assignee" class="w-full p-2 mb-4 bg-white/10 border border-white/20 rounded text-sm text-white"></select>
            <div class="flex justify-end gap-2">
                <button onclick="closeModal('task-modal')" class="text-xs">Cancel</button>
                <button onclick="saveTask()" class="bg-purple-600 text-white px-4 py-2 rounded text-xs">Save</button>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCvfwF-_by5hoUIVoEowKwbzzKF3YkJWy0",
            authDomain: "personalspacehub-3a44d.firebaseapp.com",
            projectId: "personalspacehub-3a44d",
            databaseURL: "https://personalspacehub-3a44d-default-rtdb.firebaseio.com/"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        const store = { 
            currentUser: null, 
            users: [], 
            kanbanTasks: [], 
            pins: {}, 
            notes: '', 
            theme: localStorage.getItem('theme') || 'light' 
        };

        db.ref('projectData').on('value', snap => {
            const data = snap.val() || {};
            store.users = data.users || [];
            store.kanbanTasks = data.kanbanTasks || [];
            store.pins = data.pins || {};
            updateLoginDropdown();
            renderTeamList();
            renderKanbanBoard();
            renderCalendar();
        });

        function proceedToPin() {
            const user = document.getElementById('login-user-select').value;
            document.getElementById('pin-prompt').textContent = store.pins[user] ? `Enter PIN for ${user}` : `Create a PIN for ${user}`;
            document.getElementById('login-step-1').classList.add('hidden');
            document.getElementById('login-step-2').classList.remove('hidden');
        }

        function attemptLogin() {
            const user = document.getElementById('login-user-select').value;
            const pin = document.getElementById('login-pin-input').value;
            if (pin.length < 4) return alert("PIN must be 4 digits");

            if (!store.pins[user] || store.pins[user] === pin) {
                if (!store.pins[user]) db.ref('projectData/pins/' + user).set(pin);
                store.currentUser = (user === "Admin") ? null : user;
                document.getElementById('welcome-screen').classList.add('hidden');
                updateUIForUser();
            } else { alert("Wrong PIN"); }
        }

        function updateUIForUser() {
            const adminTools = document.querySelectorAll('.admin-only');
            if (store.currentUser) {
                document.getElementById('greeting').textContent = `Hello, ${store.currentUser}.`;
                document.getElementById('dashboard-owner-badge').textContent = `${store.currentUser}'s Space`;
                adminTools.forEach(el => el.classList.add('hidden-tool'));
            } else {
                document.getElementById('greeting').textContent = `Admin View`;
                document.getElementById('dashboard-owner-badge').textContent = `Full Hub`;
                adminTools.forEach(el => el.classList.remove('hidden-tool'));
            }
            loadUserNotes();
            renderKanbanBoard();
        }

        function loadUserNotes() {
            const key = (store.currentUser || "Admin").replace(/[^a-zA-Z0-9]/g, '_');
            db.ref(`projectData/userData/${key}/notes`).once('value', s => {
                document.getElementById('notepad').value = s.val() || '';
            });
        }

        function saveNotes(val) {
            const key = (store.currentUser || "Admin").replace(/[^a-zA-Z0-9]/g, '_');
            db.ref(`projectData/userData/${key}`).update({ notes: val });
        }

        function toggleTheme() {
            store.theme = store.theme === 'light' ? 'dark' : 'light';
            document.documentElement.classList.toggle('dark', store.theme === 'dark');
            localStorage.setItem('theme', store.theme);
        }

        function renderTeamList() {
            const list = document.getElementById('team-list');
            list.innerHTML = '';
            store.users.forEach((u, i) => {
                list.innerHTML += `<li class="flex justify-between items-center text-[10px] text-white/70 bg-white/5 p-2 rounded"><span>${u}</span>${!store.currentUser ? `<button onclick="removeMember(${i})" class="text-red-400">×</button>` : ''}</li>`;
            });
        }

        function addMember() {
            const name = document.getElementById('new-member-name').value.trim();
            if (name && !store.users.includes(name)) {
                store.users.push(name);
                db.ref('projectData').update({ users: store.users });
                document.getElementById('new-member-name').value = '';
            }
        }

        function renderKanbanBoard() {
            const filtered = store.kanbanTasks.filter(t => !store.currentUser || t.assignee === store.currentUser);
            ['todo', 'inprogress', 'done'].forEach(status => {
                const el = document.getElementById(`col-${status}`);
                el.innerHTML = '';
                filtered.filter(t => t.status === status).forEach(t => {
                    el.innerHTML += `<div class="bg-white dark:bg-slate-800 p-2 rounded text-xs shadow-sm">${t.title}<p class="text-[9px] opacity-50">${t.assignee}</p></div>`;
                });
            });
            
            const ql = document.getElementById('quick-task-list');
            ql.innerHTML = '';
            filtered.filter(t => t.status !== 'done').forEach(t => {
                ql.innerHTML += `<li class="text-[10px] bg-white/5 p-2 rounded flex justify-between text-white/80"><span>${t.title}</span><span class="opacity-40 uppercase">${t.status}</span></li>`;
            });
        }

        function saveTask() {
            const title = document.getElementById('task-title').value;
            const assignee = document.getElementById('task-assignee').value;
            if (!title) return;
            store.kanbanTasks.push({ id: Date.now(), title, assignee, status: 'todo' });
            db.ref('projectData').update({ kanbanTasks: store.kanbanTasks });
            closeModal('task-modal');
        }

        function renderCalendar() {
            const grid = document.getElementById('calendar-body');
            grid.innerHTML = '';
            const now = new Date();
            const daysInMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
            for(let i=1; i<=daysInMonth; i++) {
                grid.innerHTML += `<div class="calendar-day text-[9px] text-white/20">${i}</div>`;
            }
            document.getElementById('calendar-month-year').textContent = now.toLocaleString('default', { month: 'long', year: 'numeric' });
        }

        function updateLoginDropdown() {
            const sel = document.getElementById('login-user-select');
            sel.innerHTML = '<option value="Admin">★ Admin</option>';
            store.users.forEach(u => sel.innerHTML += `<option value="${u}">${u}</option>`);
            
            const asel = document.getElementById('task-assignee');
            asel.innerHTML = '<option value="">Unassigned</option>';
            store.users.forEach(u => asel.innerHTML += `<option value="${u}">${u}</option>`);
        }

        function switchView(v) {
            document.getElementById('view-dashboard').classList.toggle('hidden', v !== 'dashboard');
            document.getElementById('view-kanban').classList.toggle('hidden', v !== 'kanban');
            document.getElementById('nav-dashboard').classList.toggle('active', v === 'dashboard');
            document.getElementById('nav-kanban').classList.toggle('active', v === 'kanban');
        }

        function updateClock() {
            const n = new Date();
            document.getElementById('clock').textContent = n.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hourCycle: 'h23' });
            document.getElementById('date').textContent = n.toDateString();
        }

        function backToLogin() {
            document.getElementById('login-step-2').classList.add('hidden');
            document.getElementById('login-step-1').classList.remove('hidden');
        }

        function openTaskModal() { document.getElementById('task-modal').classList.remove('hidden'); }
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
        function logout() { location.reload(); }
        if (store.theme === 'dark') document.documentElement.classList.add('dark');
        setInterval(updateClock, 1000);
        updateClock();
    </script>
</body>
</html>