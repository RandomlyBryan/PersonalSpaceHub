<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PersonalSpace - Team Project Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/dark.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-analytics-compat.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { 
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        glass: "rgba(255, 255, 255, 0.95)",
                        darkGlass: "rgba(30, 41, 59, 0.95)",
                        sidebar: "rgba(36, 0, 70, 0.85)",
                        jokerPurple: "#3c096c",
                        jokerGreen: "#39ff14"
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background: linear-gradient(135deg, #9d4edd, #70e000);
            min-height: 100vh;
            transition: background 0.5s ease;
            overflow: hidden; 
            font-family: 'Inter', sans-serif;
        }
        .dark body {
             background: linear-gradient(135deg, #10002b, #004b23);
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(157, 78, 221, 0.3);
            box-shadow: 0 8px 32px 0 rgba(60, 9, 108, 0.2);
        }
        .dark .glass-panel {
            background: rgba(20, 10, 40, 0.85);
            color: #e2e8f0;
            border: 1px solid rgba(57, 255, 20, 0.1);
        }
        .sidebar {
            background: rgba(36, 0, 70, 0.7);
            backdrop-filter: blur(20px);
            border-right: 1px solid rgba(255,255,255,0.1);
        }
        .dark .sidebar { background: rgba(10, 0, 20, 0.8); }
        
        .nav-item.active { 
            background: rgba(255, 255, 255, 0.1); 
            border-left: 4px solid #39ff14; 
            color: #39ff14;
        }
        .dark .nav-item.active { 
            background: rgba(255, 255, 255, 0.05); 
            border-left: 4px solid #9d4edd; 
            color: #d8b4fe;
        } 

        .column-body { min-height: 200px; transition: background-color 0.2s; }
        .column-body.drag-over { background-color: rgba(57, 255, 20, 0.15); border-radius: 0.5rem; }
        
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(157, 78, 221, 0.5); border-radius: 3px; }

        .task-card { cursor: grab; }
        .task-card:active { cursor: grabbing; }
        .dragging { opacity: 0.5; transform: scale(0.98); }
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Calendar Styles */
        .calendar-grid { 
            display: grid; 
            grid-template-columns: repeat(7, 1fr); 
            border-top: 1px solid #e2e8f0; 
            border-left: 1px solid #e2e8f0;
        }
        .dark .calendar-grid {
            border-color: #3c096c;
        }
        
        .calendar-day { 
            min-height: 80px; 
            max-height: 110px; 
            overflow-y: auto;  
            overflow-x: hidden;
            display: flex; 
            flex-direction: column; 
            align-items: flex-start; 
            justify-content: flex-start;
            padding: 4px;
            font-size: 0.85rem; 
            cursor: pointer; 
            position: relative;
            transition: background 0.2s;
            border-right: 1px solid #e2e8f0;
            border-bottom: 1px solid #e2e8f0;
            background: rgba(255,255,255,0.4);
        }
        .calendar-day::-webkit-scrollbar { width: 2px; }
        .calendar-day::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.2); }

        .dark .calendar-day {
            border-color: #3c096c;
            background: rgba(30, 41, 59, 0.4);
        }

        .calendar-day:hover { background: rgba(57, 255, 20, 0.15); }
        .calendar-day.today { background: #3c096c; color: #39ff14; font-weight: bold; border: 1px solid #39ff14; }
        .dark .calendar-day.today { background: #240046; color: #39ff14; }

        .calendar-day-number { 
            margin-bottom: 2px; 
            position: sticky; 
            top: 0;
            z-index: 10;
            width: 100%;
            padding: 2px 4px;
            font-weight: bold;
            border-bottom: 1px solid rgba(0,0,0,0.05);
            background: rgba(255,255,255,0.85); 
            backdrop-filter: blur(4px);
        }
        .dark .calendar-day-number {
            background: rgba(30, 41, 59, 0.85);
            border-color: rgba(255,255,255,0.05);
        }

        .cal-event-item {
            font-size: 0.65rem;
            line-height: 1.2;
            padding: 4px 5px;
            border-radius: 3px;
            background: rgba(255, 255, 255, 0.6);
            margin-top: 2px;
            width: 100%;
            white-space: normal; 
            word-break: break-word;
            text-align: left; 
            border-left: 3px solid #ccc; 
            display: flex;
            flex-direction: column;
            gap: 2px;
            position: relative;
            color: #334155;
            padding-right: 2px;
        }
        .dark .cal-event-item {
            background: rgba(15, 23, 42, 0.6);
            color: #e2e8f0;
        }

        .cal-urgency-low { border-left-color: #39ff14 !important; background: rgba(57, 255, 20, 0.1); }
        .cal-urgency-medium { border-left-color: #9d4edd !important; background: rgba(157, 78, 221, 0.1); }
        .cal-urgency-high { border-left-color: #ef4444 !important; background: rgba(239, 68, 68, 0.1); }
        
        .cal-task-critical { 
            border-left-color: #f97316 !important; 
            background: rgba(249, 115, 22, 0.15) !important;
            border-style: dashed;
        }

        .cal-actions-container {
            position: absolute;
            top: 2px;
            right: 2px;
            display: flex;
            gap: 3px;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 20;
            padding: 2px 4px;
            border-radius: 4px;
            background: rgba(255, 255, 255, 0.95);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            border: 1px solid rgba(0,0,0,0.1);
        }
        .dark .cal-actions-container {
            background: rgba(30, 41, 59, 0.95);
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .cal-event-item:hover .cal-actions-container { opacity: 1; }

        .cal-action-btn {
            width: 16px;
            height: 16px;
            background: rgba(0,0,0, 0.05);
            color: #64748b;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 9px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .dark .cal-action-btn { background: rgba(255,255,255, 0.1); color: #94a3b8; }
        
        .cal-btn-del:hover { background: #ef4444 !important; color: white !important; transform: scale(1.1); }
        .cal-btn-check:hover { background: #39ff14 !important; color: black !important; transform: scale(1.1); }

        .cal-time { font-weight: 800; opacity: 0.9; font-size: 0.6rem; display: block; border-bottom: 1px solid rgba(0,0,0,0.05); padding-bottom:1px; margin-bottom:1px;}

        .flag-btn {
            cursor: pointer;
            transition: all 0.2s;
            color: #cbd5e1; 
        }
        .dark .flag-btn { color: #475569; }
        
        .flag-rating:hover .flag-btn { color: #9d4edd; } 
        .flag-btn:hover ~ .flag-btn { color: #cbd5e1; } 
        .dark .flag-rating:hover .flag-btn { color: #9d4edd; }
        .dark .flag-btn:hover ~ .flag-btn { color: #475569; }
        .flag-btn.active { color: #9d4edd; }
        
        .avatar-container:hover .avatar-overlay { opacity: 1; }
        
        .view-btn { transition: all 0.2s; }
        .view-btn.active { background-color: rgba(57, 255, 20, 0.2); font-weight: bold; border: 1px solid #39ff14; color: #39ff14; }

        .timer-active { animation: pulse-green 2s infinite; }
        @keyframes pulse-green {
            0% { text-shadow: 0 0 0 rgba(57, 255, 20, 0); }
            50% { text-shadow: 0 0 4px rgba(57, 255, 20, 0.5); }
            100% { text-shadow: 0 0 0 rgba(57, 255, 20, 0); }
        }
        
        .flatpickr-calendar {
            background: rgba(36, 0, 70, 0.95) !important; 
            border: 1px solid #39ff14 !important;
            backdrop-filter: blur(10px) !important;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5) !important;
            z-index: 9999 !important;
        }
        .flatpickr-day.selected {
            background: #39ff14 !important;
            border-color: #39ff14 !important;
            color: black !important;
            font-weight: bold;
        }
        
        .admin-only { transition: all 0.3s; }
        .admin-only.hidden-tool { display: none !important; }

        #login-overlay {
            background: #10002b;
            z-index: 200;
        }

        .logo-glow {
            animation: logo-pulse 3s infinite ease-in-out;
        }
        @keyframes logo-pulse {
            0%, 100% { filter: drop-shadow(0 0 5px rgba(57, 255, 20, 0.4)); }
            50% { filter: drop-shadow(0 0 15px rgba(57, 255, 20, 0.8)); }
        }
    </style>
</head>
<body class="text-slate-800 antialiased flex flex-col h-screen w-screen overflow-hidden">

    <div id="login-overlay" class="fixed inset-0 flex items-center justify-center transition-opacity duration-500">
        <div class="glass-panel p-8 rounded-3xl w-full max-sm:w-[90%] max-w-sm border-2 border-jokerPurple shadow-[0_0_50px_rgba(157,78,221,0.3)]">
            <div class="flex justify-center mb-6">
                <div class="w-20 h-20 bg-jokerPurple rounded-2xl flex items-center justify-center border-2 border-jokerGreen shadow-[0_0_20px_rgba(57,255,20,0.3)] logo-glow">
                    <i class="fas fa-user-astronaut text-jokerGreen text-4xl"></i>
                </div>
            </div>
            <div class="text-center mb-6">
                <h1 class="text-3xl font-bold text-jokerGreen tracking-tighter">PersonalSpace</h1>
                <p class="text-white/50 text-xs uppercase tracking-widest">Secure Entry</p>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="text-[10px] text-purple-400 font-bold uppercase ml-1">Identity</label>
                    <select id="login-username" class="w-full bg-white/10 border border-white/20 rounded-xl px-4 py-3 text-white outline-none focus:border-jokerGreen appearance-none cursor-pointer">
                        <option value="Admin" class="text-slate-900">★ Admin</option>
                    </select>
                </div>
                <div>
                    <label class="text-[10px] text-purple-400 font-bold uppercase ml-1">Password</label>
                    <div class="relative">
                        <input type="password" id="login-password" placeholder="••••••••" 
                            class="w-full bg-white/10 border border-white/20 rounded-xl px-4 py-3 text-white outline-none focus:border-jokerGreen placeholder-white/20">
                        <button type="button" onclick="togglePasswordVisibility()" class="absolute right-3 top-1/2 -translate-y-1/2 text-white/50 hover:text-jokerGreen transition">
                            <i id="eye-icon" class="fas fa-eye"></i>
                        </button>
                    </div>
                </div>
                <button onclick="handleLogin()" class="w-full bg-jokerGreen hover:bg-green-400 text-black font-black py-3 rounded-xl transition transform active:scale-95 shadow-lg">
                    ACCESS SYSTEM
                </button>
                <p id="login-error" class="text-red-400 text-[10px] text-center font-bold hidden uppercase animate-pulse">Invalid Credentials</p>
            </div>
        </div>
    </div>

    <div class="absolute top-0 left-1/2 transform -translate-x-1/2 bg-purple-900 text-white px-3 py-1 text-[10px] rounded-b-lg shadow-lg z-50 font-bold opacity-90 border border-t-0 border-green-400" id="connection-status">
        <i class="fas fa-circle-notch fa-spin mr-1 text-yellow-400"></i> Connecting...
    </div>

    <input type="file" id="avatar-upload" class="hidden" accept="image/*" onchange="handleAvatarFile(this)">
    <input type="file" id="restore-upload" class="hidden" accept=".json" onchange="handleRestore(this)">

    <div class="flex flex-1 overflow-hidden relative">
        <aside class="sidebar w-64 flex-shrink-0 flex flex-col justify-between h-full z-20 transition-all duration-300 transform -translate-x-full md:translate-x-0 absolute md:relative" id="main-sidebar">
            <div class="p-6 text-white flex items-center gap-3">
                <div class="w-10 h-10 bg-white/10 rounded-lg flex items-center justify-center border border-green-400/50">
                    <i class="fas fa-user-astronaut text-green-400 text-xl"></i>
                </div>
                <div>
                    <h1 class="text-xl font-bold tracking-wider text-green-400">PersonalSpace</h1>
                    <p class="text-[9px] text-white/60 uppercase tracking-wider -mt-1">Project Hub</p>
                </div>
            </div>

            <div class="px-4 mb-4">
                <label class="text-[10px] text-green-400/80 uppercase font-bold block mb-1">Signed In As:</label>
                <div id="active-user-display" class="w-full bg-purple-900/50 border border-purple-500/30 rounded px-3 py-2 text-sm text-white font-medium flex justify-between items-center">
                    <span id="current-user-name">Admin</span>
                    <button onclick="logout()" class="text-red-400 hover:text-red-300" title="Logout"><i class="fas fa-sign-out-alt"></i></button>
                </div>
            </div>

            <nav class="flex-1 px-4 space-y-2">
                <button onclick="switchView('dashboard')" id="nav-dashboard" class="nav-item w-full flex items-center gap-3 text-white px-4 py-3 rounded-r-lg transition hover:bg-white/10 active">
                    <i class="fas fa-home w-5"></i> Dashboard
                </button>
                <button onclick="switchView('kanban')" id="nav-kanban" class="nav-item w-full flex items-center gap-3 text-white px-4 py-3 rounded-r-lg transition hover:bg-white/10">
                    <i class="fas fa-tasks w-5"></i> Task Tracker
                </button>
            </nav>

            <div class="p-4 border-t border-purple-500/30">
                <h3 class="text-xs font-bold text-green-400 uppercase mb-3 flex justify-between items-center">Team Members <span id="member-count" class="bg-purple-800 px-2 rounded-full text-[10px] text-white">0</span></h3>
                <div id="admin-tools-members" class="admin-only flex gap-2 mb-3">
                    <input type="text" id="new-member-name" placeholder="Name..." class="w-full bg-white/10 border border-white/20 rounded px-2 py-1 text-sm text-white placeholder-white/50 focus:outline-none focus:bg-white/20 focus:border-green-400">
                    <button onclick="addMember()" class="bg-green-600 hover:bg-green-500 text-black font-bold px-2 rounded text-sm transition"><i class="fas fa-plus"></i></button>
                </div>
                <ul id="team-list" class="space-y-2 max-h-40 overflow-y-auto pr-1"></ul>
            </div>

            <div class="p-4 flex flex-col gap-3 border-t border-purple-500/30">
                <div class="flex justify-between items-center">
                    <button onclick="changeMyPassword()" class="text-[10px] text-amber-400 hover:text-amber-200 transition flex items-center gap-2"><i class="fas fa-lock"></i> Update Pass</button>
                    <button onclick="toggleTheme()" class="text-green-400 hover:text-white transition text-xs"><i class="fas fa-moon" id="theme-icon"></i></button>
                </div>
                <div id="admin-tools-data" class="admin-only flex flex-col gap-2">
                    <div class="grid grid-cols-2 gap-2">
                        <button onclick="backupData()" class="bg-purple-500/20 hover:bg-purple-500/40 text-purple-200 text-[10px] py-1 rounded transition border border-purple-500/30">Backup</button>
                        <button onclick="clearAllData()" class="bg-red-500/20 hover:bg-red-500/40 text-red-200 text-[10px] py-1 rounded transition border border-red-500/30">Nuke</button>
                    </div>
                </div>
                <div class="text-white/30 text-[10px] text-center mt-2">&copy; 2025 PersonalSpace</div>
            </div>
        </aside>

        <main class="flex-1 relative h-full overflow-hidden flex flex-col bg-white/5 backdrop-blur-sm">
            <button onclick="document.getElementById('main-sidebar').classList.toggle('-translate-x-full')" class="md:hidden absolute top-4 left-4 z-50 text-white bg-purple-600 p-2 rounded-lg shadow-lg"><i class="fas fa-bars"></i></button>

            <div id="view-dashboard" class="flex-1 overflow-hidden p-4 md:p-6 fade-in h-full flex flex-col">
                <header class="mb-4 text-white shrink-0">
                    <div class="flex justify-between items-center">
                        <div>
                            <h1 class="text-3xl font-bold tracking-tight text-green-400" id="clock">00:00</h1>
                            <p class="text-sm opacity-90 mt-1 font-bold" id="date">Loading...</p>
                        </div>
                        <div class="flex items-center gap-4">
                            <div class="text-right">
                                <p class="text-lg font-bold text-white leading-tight" id="greeting">Connecting...</p>
                                <span id="dashboard-owner-badge" class="bg-green-500 text-black px-2 py-0.5 rounded-full text-[10px] font-bold uppercase hidden">Workspace</span>
                            </div>
                            <div id="header-avatar" class="w-14 h-14 rounded-full bg-purple-900 border-2 border-green-400 shadow-lg flex items-center justify-center overflow-hidden shrink-0 cursor-pointer avatar-container relative" onclick="triggerAvatarUpload('Admin')">
                                <i class="fas fa-user text-white/50 text-2xl"></i>
                            </div>
                        </div>
                    </div>
                </header>

                <div class="flex flex-col gap-4 flex-1 min-h-0 overflow-y-auto">
                    <div class="grid grid-cols-1 lg:grid-cols-4 gap-4 shrink-0">
                        <div class="lg:col-span-4 glass-panel rounded-2xl p-4 border-l-4 border-jokerGreen flex flex-col md:flex-row items-center justify-between gap-4">
                            <div class="flex items-center gap-4 flex-1 w-full">
                                <div class="w-12 h-12 bg-jokerGreen/20 rounded-xl flex items-center justify-center">
                                    <i class="fas fa-stopwatch text-jokerGreen text-2xl" id="global-timer-icon"></i>
                                </div>
                                <div class="flex-1">
                                    <h2 class="text-xs font-black uppercase tracking-widest text-jokerGreen">Live Work Session</h2>
                                    <select id="timer-task-select" class="w-full bg-transparent border-none text-slate-700 dark:text-white font-bold text-lg p-0 outline-none cursor-pointer">
                                        <option value="">General Work (No Task Selected)</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="flex items-center gap-6">
                                <div class="text-center">
                                    <p class="text-[10px] font-bold text-slate-400 uppercase">Elapsed Time</p>
                                    <h3 class="text-3xl font-mono font-black text-slate-800 dark:text-white" id="global-timer-display">00:00:00</h3>
                                </div>
                                <button id="global-timer-btn" onclick="toggleGlobalTimer()" class="w-14 h-14 rounded-full bg-jokerGreen text-black flex items-center justify-center shadow-lg transform active:scale-90 transition-all">
                                    <i class="fas fa-play text-xl" id="global-timer-btn-icon"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-10 gap-4 flex-1 min-h-0">
                        <div class="lg:col-span-3 flex flex-col gap-4 h-full min-h-0">
                            <div class="glass-panel rounded-2xl p-4 h-1/3 flex flex-col min-h-[180px]">
                                <h2 class="text-sm font-bold mb-2 flex items-center gap-2 text-purple-700 dark:text-purple-300"><i class="fas fa-sticky-note"></i> Quick Notes</h2>
                                <textarea id="notepad" class="flex-1 w-full bg-purple-50 dark:bg-slate-900/50 border-none rounded-lg p-3 resize-none focus:ring-2 focus:ring-green-400 outline-none text-sm" placeholder="Private notes..." onchange="saveNotes(this.value)"></textarea>
                                <div class="text-[10px] text-right mt-1 text-slate-400" id="notes-status">Saved</div>
                            </div>

                            <div class="glass-panel rounded-2xl p-4 flex-1 flex flex-col min-h-0 border-t-4 border-amber-500">
                                <h2 class="text-sm font-bold mb-2 flex items-center gap-2 text-amber-600 dark:text-amber-400"><i class="fas fa-user-shield"></i> Communication</h2>
                                <div id="admin-message-viewer" class="hidden flex-1 overflow-y-auto space-y-2 mb-2 pr-1"></div>
                                <div id="member-message-sender" class="flex flex-col gap-2 flex-1">
                                    <textarea id="admin-msg-input" class="flex-1 w-full bg-amber-50 dark:bg-slate-900/50 border border-amber-200 rounded-lg p-2 resize-none text-xs" placeholder="Message to Admin..."></textarea>
                                    <button onclick="sendAdminMessage()" class="w-full bg-amber-500 text-white font-bold py-1.5 rounded-lg text-[10px]">SEND</button>
                                </div>
                            </div>
                        </div>

                        <div class="lg:col-span-7 glass-panel rounded-2xl p-4 flex flex-col h-full min-h-[400px]">
                            <div class="flex justify-between items-center mb-2">
                                <h2 class="text-sm font-bold flex items-center gap-2 text-purple-700 dark:text-purple-400"><i class="fas fa-calendar-alt"></i> Private Schedule</h2>
                                <div class="flex gap-2 text-xs">
                                    <button onclick="changeMonth(-1)" class="w-6 h-6 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-full flex items-center justify-center"><i class="fas fa-chevron-left"></i></button>
                                    <span id="calendar-month-year" class="font-bold w-24 text-center">...</span>
                                    <button onclick="changeMonth(1)" class="w-6 h-6 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-full flex items-center justify-center"><i class="fas fa-chevron-right"></i></button>
                                </div>
                            </div>
                            <div class="grid grid-cols-7 text-center text-[10px] font-bold text-slate-500 uppercase border-b py-1">
                                <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
                            </div>
                            <div id="calendar-body" class="calendar-grid flex-1 overflow-y-auto"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="view-kanban" class="flex-1 overflow-hidden p-4 md:p-6 fade-in hidden flex-col h-full">
                <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4 text-white">
                    <div class="flex-1">
                        <h2 class="text-2xl font-bold flex items-center gap-2 text-green-400">Task Tracker</h2>
                        <p class="text-sm opacity-80" id="tracker-subtitle">Organize & Execute</p>
                    </div>

                    <div id="kanban-filter-container" class="flex items-center gap-2 bg-black/40 p-1 rounded-lg border border-purple-500/50">
                            <i class="fas fa-filter text-green-400 text-xs ml-2"></i>
                            <input type="text" id="date-range-picker" placeholder="Select Period for Report..." class="bg-transparent border-none text-white text-xs rounded px-2 py-1 outline-none w-48 cursor-pointer">
                            <button onclick="clearFilters()" class="text-xs text-white/50 hover:text-white px-2"><i class="fas fa-times"></i></button>
                    </div>

                    <div class="flex gap-2">
                        <button onclick="exportSummaryReport()" class="bg-amber-600 text-white px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2"><i class="fas fa-file-export"></i> Detailed Time Report</button>
                        <button onclick="openTaskModal()" class="bg-green-500 text-black font-bold px-4 py-2 rounded-lg text-sm flex items-center gap-2"><i class="fas fa-plus"></i> New Task</button>
                    </div>
                </div>

                <div id="kanban-status-view" class="flex-1 overflow-x-auto overflow-y-hidden pb-2 h-full">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 h-full min-w-[800px] md:min-w-0">
                        <div class="glass-panel rounded-xl flex flex-col h-full border-t-4 border-slate-400">
                            <div class="p-3 border-b flex justify-between items-center bg-white/50 dark:bg-slate-800/50">
                                <h3 class="font-bold">To Do</h3><span id="count-todo" class="text-xs px-2 py-1 rounded-full bg-slate-200">0</span>
                            </div>
                            <div class="column-body p-3 flex-1 overflow-y-auto space-y-3" ondrop="drop(event, 'todo', 'status')" ondragover="allowDrop(event)"></div>
                        </div>
                        <div class="glass-panel rounded-xl flex flex-col h-full border-t-4 border-purple-600">
                            <div class="p-3 border-b flex justify-between items-center bg-white/50 dark:bg-slate-800/50">
                                <h3 class="font-bold">In Progress</h3><span id="count-inprogress" class="text-xs px-2 py-1 rounded-full bg-purple-100">0</span>
                            </div>
                            <div class="column-body p-3 flex-1 overflow-y-auto space-y-3" ondrop="drop(event, 'inprogress', 'status')" ondragover="allowDrop(event)"></div>
                        </div>
                        <div class="glass-panel rounded-xl flex flex-col h-full border-t-4 border-green-500">
                            <div class="p-3 border-b flex justify-between items-center bg-white/50 dark:bg-slate-800/50">
                                <h3 class="font-bold">Executed</h3><span id="count-done" class="text-xs px-2 py-1 rounded-full bg-green-100">0</span>
                            </div>
                            <div class="column-body p-3 flex-1 overflow-y-auto space-y-3" ondrop="drop(event, 'done', 'status')" ondragover="allowDrop(event)"></div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="task-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm hidden flex items-center justify-center z-50 p-4">
        <div class="bg-white dark:bg-slate-800 rounded-2xl w-full max-w-md p-6 border-2 border-purple-500">
            <h2 class="text-xl font-bold mb-4" id="modal-title">Task Details</h2>
            <input type="hidden" id="task-id">
            <div class="mb-3">
                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Title</label>
                <input type="text" id="task-title" class="w-full bg-slate-100 dark:bg-slate-700 rounded-lg p-3 outline-none dark:text-white">
            </div>
            <div class="grid grid-cols-2 gap-3 mb-3">
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Assign To</label>
                    <select id="task-assignee" class="w-full bg-slate-100 dark:bg-slate-700 rounded-lg p-3 outline-none dark:text-white"></select>
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Scheduled Date</label>
                    <input type="date" id="task-date" class="w-full bg-slate-100 dark:bg-slate-700 rounded-lg p-3 outline-none dark:text-white text-sm">
                </div>
            </div>
            <div class="mb-6">
                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Description</label>
                <textarea id="task-desc" rows="3" class="w-full bg-slate-100 dark:bg-slate-700 rounded-lg p-3 outline-none dark:text-white"></textarea>
            </div>
            <div class="flex justify-between">
                <button onclick="deleteCurrentTask()" id="btn-delete" class="text-red-500 text-sm hidden">Delete Task</button>
                <div class="flex gap-2 ml-auto">
                    <button onclick="closeModal('task-modal')" class="px-4 py-2 text-slate-500">Cancel</button>
                    <button onclick="saveTask()" class="bg-purple-600 text-white px-6 py-2 rounded-lg">Save</button>
                </div>
            </div>
        </div>
    </div>

    <div id="calendar-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm hidden flex items-center justify-center z-50 p-4">
        <div class="bg-white dark:bg-slate-800 rounded-2xl w-full max-w-sm p-6 border border-purple-500">
            <h2 class="text-lg font-bold mb-4" id="cal-date-title">Date</h2>
            <div id="day-events-list" class="mb-4 space-y-2 max-h-40 overflow-y-auto p-2 bg-slate-50 dark:bg-slate-700 rounded-lg"></div>
            <div class="flex flex-col gap-2">
                <input type="text" id="new-event-input" placeholder="New Schedule Entry..." class="bg-slate-100 dark:bg-slate-700 rounded-lg p-2 text-sm outline-none dark:text-white">
                <button onclick="addEvent()" class="bg-green-500 text-black font-bold py-2 rounded-lg">Add to Calendar</button>
            </div>
            <div class="mt-4 text-right"><button onclick="closeModal('calendar-modal')" class="text-sm text-slate-500">Close</button></div>
        </div>
    </div>

    <script>
        // --- FIREBASE CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyCvfwF-_by5hoUIVoEowKwbzzKF3YkJWy0",
            authDomain: "personalspacehub-3a44d.firebaseapp.com",
            projectId: "personalspacehub-3a44d",
            storageBucket: "personalspacehub-3a44d.firebasestorage.app",
            messagingSenderId: "605942768680",
            appId: "1:605942768680:web:74702b5d902dd462f1811d",
            measurementId: "G-E1YDD7Y7MX",
            databaseURL: "https://personalspacehub-3a44d-default-rtdb.firebaseio.com/"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // --- GLOBAL STATE ---
        const store = {
            theme: localStorage.getItem('nexus_theme') || 'light',
            currentUser: null,
            users: [],
            kanbanTasks: [],
            avatars: {}, 
            notes: '',
            adminMessages: {},
            events: {}, 
            passwords: {},
            timeEntries: [], // NEW: Persistent log of all time tracked
            activeTimer: null, // NEW: Current running timer state { startTime, taskId, user }
            calendarMonth: new Date().getMonth(),
            calendarYear: new Date().getFullYear()
        };
        
        let draggedItem = null;
        let uploadingUser = null;
        let globalTimerInterval = null;

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', () => {
            loadTheme();
            updateClock();
            setInterval(updateClock, 1000);

            const statusDiv = document.getElementById('connection-status');
            
            db.ref('projectData').on('value', (snapshot) => {
                const data = snapshot.val();
                if(data) {
                    store.users = data.users || [];
                    store.kanbanTasks = data.kanbanTasks || [];
                    store.avatars = data.avatars || {};
                    store.passwords = data.passwords || { "Admin": "1234" };
                    store.adminMessages = data.adminMessages || {};
                    store.timeEntries = data.timeEntries || [];
                    
                    const savedUser = localStorage.getItem('ps_session_user');
                    if (savedUser && !store.currentUser) {
                        loginAs(savedUser);
                    }
                    
                    renderTeamList();
                    renderKanbanBoard(); 
                    renderCalendar();
                    syncActiveTimer(data.activeTimers || {});
                }
                statusDiv.innerHTML = '<i class="fas fa-wifi mr-1 text-green-400"></i> Cloud Connected';
            });

            flatpickr("#date-range-picker", { mode: "range", dateFormat: "Y-m-d", theme: "dark" });
        });

        // --- TIMER LOGIC (HUBSTAFF STYLE) ---
        function syncActiveTimer(allActiveTimers) {
            const userKey = (store.currentUser || "Admin").replace(/[^a-zA-Z0-9]/g, '_');
            const myTimer = allActiveTimers[userKey];
            
            if (myTimer) {
                store.activeTimer = myTimer;
                document.getElementById('global-timer-btn-icon').className = "fas fa-pause";
                document.getElementById('global-timer-btn').classList.replace('bg-jokerGreen', 'bg-red-500');
                document.getElementById('global-timer-icon').classList.add('timer-active');
                if (!globalTimerInterval) {
                    globalTimerInterval = setInterval(updateTimerDisplay, 1000);
                }
                // Lock dropdown
                document.getElementById('timer-task-select').value = myTimer.taskId || "";
                document.getElementById('timer-task-select').disabled = true;
            } else {
                stopLocalTimer();
            }
        }

        function toggleGlobalTimer() {
            const btn = document.getElementById('global-timer-btn');
            const taskId = document.getElementById('timer-task-select').value;
            const userKey = (store.currentUser || "Admin").replace(/[^a-zA-Z0-9]/g, '_');

            if (!store.activeTimer) {
                // START TIMER
                const newTimer = {
                    startTime: Date.now(),
                    taskId: taskId,
                    user: store.currentUser || "Admin",
                    taskName: taskId ? store.kanbanTasks.find(t => t.id === taskId)?.title : "General"
                };
                db.ref(`projectData/activeTimers/${userKey}`).set(newTimer);
            } else {
                // STOP TIMER
                const sessionEnd = Date.now();
                const duration = Math.floor((sessionEnd - store.activeTimer.startTime) / 1000);
                
                if (duration > 1) { // Only log sessions longer than 1 sec
                    const newEntry = {
                        user: store.activeTimer.user,
                        taskId: store.activeTimer.taskId,
                        taskName: store.activeTimer.taskName,
                        duration: duration,
                        timestamp: sessionEnd,
                        date: new Date().toISOString().split('T')[0]
                    };
                    store.timeEntries.push(newEntry);
                    db.ref('projectData/timeEntries').set(store.timeEntries);
                }
                db.ref(`projectData/activeTimers/${userKey}`).remove();
            }
        }

        function stopLocalTimer() {
            clearInterval(globalTimerInterval);
            globalTimerInterval = null;
            store.activeTimer = null;
            document.getElementById('global-timer-display').textContent = "00:00:00";
            document.getElementById('global-timer-btn-icon').className = "fas fa-play";
            document.getElementById('global-timer-btn').classList.replace('bg-red-500', 'bg-jokerGreen');
            document.getElementById('global-timer-icon').classList.remove('timer-active');
            document.getElementById('timer-task-select').disabled = false;
        }

        function updateTimerDisplay() {
            if (!store.activeTimer) return;
            const elapsed = Math.floor((Date.now() - store.activeTimer.startTime) / 1000);
            const h = Math.floor(elapsed / 3600).toString().padStart(2, '0');
            const m = Math.floor((elapsed % 3600) / 60).toString().padStart(2, '0');
            const s = (elapsed % 60).toString().padStart(2, '0');
            document.getElementById('global-timer-display').textContent = `${h}:${m}:${s}`;
        }

        // --- REPORTING (TIME DOCTOR STYLE) ---
        function exportSummaryReport() {
            const rangeInput = document.getElementById('date-range-picker').value;
            if (!rangeInput || !rangeInput.includes('to')) {
                alert("Please select a valid date range in the filter first.");
                return;
            }

            const dates = rangeInput.split(' to ');
            const startDate = new Date(dates[0]).getTime();
            const endDate = new Date(dates[1]).setHours(23, 59, 59);

            // Filter Entries
            const relevantEntries = store.timeEntries.filter(e => e.timestamp >= startDate && e.timestamp <= endDate);
            
            let content = "PERSONAL SPACE - TEAM UTILIZATION REPORT\n";
            content += `Period: ${dates[0]} to ${dates[1]}\n`;
            content += "==============================================\n\n";

            const userStats = {};
            store.users.concat(["Admin"]).forEach(u => userStats[u] = { totalSec: 0, tasks: {} });

            relevantEntries.forEach(e => {
                if (userStats[e.user]) {
                    userStats[e.user].totalSec += e.duration;
                    userStats[e.user].tasks[e.taskName] = (userStats[e.user].tasks[e.taskName] || 0) + e.duration;
                }
            });

            for (const user in userStats) {
                const stat = userStats[user];
                content += `MEMBER: ${user.toUpperCase()}\n`;
                content += `Total Time Tracked: ${formatTime(stat.totalSec)}\n`;
                content += `Task Breakdown:\n`;
                for (const tName in stat.tasks) {
                    content += ` - ${tName}: ${formatTime(stat.tasks[tName])}\n`;
                }
                content += `----------------------------------------------\n`;
            }

            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `PersonalSpace_Time_Report_${dates[0]}.txt`;
            a.click();
        }

        // --- EXISTING REFACTORED CORE FUNCTIONS ---
        function loginAs(user) {
            store.currentUser = user === "Admin" ? null : user;
            document.getElementById('current-user-name').textContent = user;
            document.getElementById('login-overlay').classList.add('hidden');
            
            const userKey = (store.currentUser || "Admin").replace(/[^a-zA-Z0-9]/g, '_');
            db.ref(`projectData/userData/${userKey}`).once('value', snap => {
                const uData = snap.val() || {};
                store.notes = uData.notes || "";
                store.events = uData.events || {};
                updateDashboardUI();
                updateUIForUser();
            });
        }

        function handleLogin() {
            const user = document.getElementById('login-username').value;
            const pass = document.getElementById('login-password').value;
            if (pass === (store.passwords[user] || "1234")) {
                localStorage.setItem('ps_session_user', user);
                loginAs(user);
            } else {
                document.getElementById('login-error').classList.remove('hidden');
            }
        }

        function logout() { localStorage.removeItem('ps_session_user'); location.reload(); }

        function updateUIForUser() {
            const name = store.currentUser || "Admin";
            document.getElementById('greeting').textContent = `Hello, ${name}.`;
            const isAdmin = !store.currentUser;
            document.querySelectorAll('.admin-only').forEach(el => el.classList.toggle('hidden-tool', !isAdmin));
            
            if (!isAdmin) {
                document.getElementById('admin-message-viewer').classList.add('hidden');
                document.getElementById('member-message-sender').classList.remove('hidden');
            } else {
                document.getElementById('admin-message-viewer').classList.remove('hidden');
                document.getElementById('member-message-sender').classList.add('hidden');
                renderAdminMailbox();
            }

            // Sync Header Avatar
            const avatarContainer = document.getElementById('header-avatar');
            if (store.avatars[name]) avatarContainer.innerHTML = `<img src="${store.avatars[name]}" class="w-full h-full object-cover">`;
        }

        function renderKanbanBoard() {
            const timerSelect = document.getElementById('timer-task-select');
            const currentSelected = timerSelect.value;
            timerSelect.innerHTML = '<option value="">General Work (No Task Selected)</option>';

            ['todo', 'inprogress', 'done'].forEach(s => {
                const container = document.querySelector(`[ondrop="drop(event, '${s}', 'status')"]`);
                const tasks = store.kanbanTasks.filter(t => t.status === s && (!store.currentUser || t.assignee === store.currentUser));
                document.getElementById(`count-${s}`).textContent = tasks.length;
                container.innerHTML = '';
                tasks.forEach(t => {
                    const el = document.createElement('div');
                    el.className = 'task-card bg-white dark:bg-slate-800 p-3 rounded-lg border hover:shadow-md transition';
                    el.draggable = true; el.ondragstart = (e) => { draggedItem = t.id; e.target.classList.add('dragging'); };
                    el.innerHTML = `<h4 class="font-bold text-sm">${t.title}</h4><p class="text-[10px] text-slate-400 mt-1">${t.assignee || 'Unassigned'}</p>`;
                    el.onclick = () => openTaskModal(t.id);
                    container.appendChild(el);
                    
                    if (t.status !== 'done') {
                        const opt = new Option(t.title, t.id);
                        timerSelect.add(opt);
                    }
                });
            });
            timerSelect.value = currentSelected;
        }

        function renderTeamList() {
            const list = document.getElementById('team-list');
            const loginSel = document.getElementById('login-username');
            const taskAssign = document.getElementById('task-assignee');
            
            loginSel.innerHTML = '<option value="Admin">★ Admin</option>';
            taskAssign.innerHTML = '<option value="">Unassigned</option>';
            list.innerHTML = '';
            
            store.users.forEach((u, i) => {
                loginSel.add(new Option(u, u));
                taskAssign.add(new Option(u, u));
                const li = document.createElement('li');
                li.className = 'flex justify-between items-center text-xs text-white/70 bg-white/5 p-2 rounded';
                li.innerHTML = `<span>${u}</span> ${!store.currentUser ? `<button onclick="removeMember(${i})" class="text-red-400"><i class="fas fa-times"></i></button>` : ''}`;
                list.appendChild(li);
            });
            document.getElementById('member-count').textContent = store.users.length;
        }

        // --- DASHBOARD CORE ---
        function updateDashboardUI() { document.getElementById('notepad').value = store.notes; }
        function saveNotes(v) { store.notes = v; saveUserDataToCloud(); }
        function saveUserDataToCloud() {
            const userKey = (store.currentUser || "Admin").replace(/[^a-zA-Z0-9]/g, '_');
            db.ref(`projectData/userData/${userKey}`).update({ notes: store.notes, events: store.events });
        }

        function renderCalendar() {
            const grid = document.getElementById('calendar-body');
            const daysInMonth = new Date(store.calendarYear, store.calendarMonth + 1, 0).getDate();
            const firstDay = new Date(store.calendarYear, store.calendarMonth, 1).getDay();
            document.getElementById('calendar-month-year').textContent = new Date(store.calendarYear, store.calendarMonth).toLocaleDateString(undefined, {month:'long', year:'numeric'});
            grid.innerHTML = '';
            for(let i=0; i<firstDay; i++) grid.innerHTML += `<div class="bg-slate-50/50 dark:bg-slate-800/20"></div>`;
            for(let d=1; d<=daysInMonth; d++) {
                const dateKey = `${store.calendarYear}-${(store.calendarMonth+1).toString().padStart(2,'0')}-${d.toString().padStart(2,'0')}`;
                const el = document.createElement('div');
                el.className = `calendar-day ${new Date().getDate() === d && new Date().getMonth() === store.calendarMonth ? 'today' : ''}`;
                el.innerHTML = `<div class="calendar-day-number">${d}</div>`;
                (store.events[dateKey] || []).forEach(evt => {
                    el.innerHTML += `<div class="cal-event-item cal-urgency-low"><span>${evt}</span></div>`;
                });
                el.onclick = () => openCalendarModal(dateKey);
                grid.appendChild(el);
            }
        }

        function openCalendarModal(d) {
            document.getElementById('calendar-modal').classList.remove('hidden');
            document.getElementById('cal-date-title').textContent = d;
            const list = document.getElementById('day-events-list');
            list.innerHTML = (store.events[d] || []).map(e => `<div class="p-1 border-b text-xs">${e}</div>`).join('') || "No events.";
        }

        function addEvent() {
            const date = document.getElementById('cal-date-title').textContent;
            const val = document.getElementById('new-event-input').value.trim();
            if(val) {
                if(!store.events[date]) store.events[date] = [];
                store.events[date].push(val);
                saveUserDataToCloud();
                renderCalendar();
                openCalendarModal(date);
                document.getElementById('new-event-input').value = '';
            }
        }

        // --- TASK CORE ---
        function openTaskModal(id) {
            const t = store.kanbanTasks.find(x => x.id === id) || {title:'', description:'', assignee:'', assignedDate:''};
            document.getElementById('task-id').value = id || '';
            document.getElementById('task-title').value = t.title;
            document.getElementById('task-desc').value = t.description;
            document.getElementById('task-assignee').value = t.assignee;
            document.getElementById('task-date').value = t.assignedDate;
            document.getElementById('btn-delete').classList.toggle('hidden', !id);
            document.getElementById('task-modal').classList.remove('hidden');
        }

        function saveTask() {
            const id = document.getElementById('task-id').value;
            const payload = {
                title: document.getElementById('task-title').value,
                description: document.getElementById('task-desc').value,
                assignee: document.getElementById('task-assignee').value,
                assignedDate: document.getElementById('task-date').value
            };
            if(id) Object.assign(store.kanbanTasks.find(x => x.id === id), payload);
            else store.kanbanTasks.push({ id: Date.now().toString(), ...payload, status: 'todo' });
            pushToCloud();
            closeModal('task-modal');
        }

        function deleteCurrentTask() {
            const id = document.getElementById('task-id').value;
            store.kanbanTasks = store.kanbanTasks.filter(t => t.id !== id);
            pushToCloud();
            closeModal('task-modal');
        }

        // --- HELPERS ---
        function formatTime(s) { 
            const h = Math.floor(s/3600); 
            const m = Math.floor((s%3600)/60); 
            return h > 0 ? `${h}h ${m}m ${s%60}s` : `${m}m ${s%60}s`; 
        }
        function pushToCloud() { db.ref('projectData').update({ users: store.users, kanbanTasks: store.kanbanTasks, avatars: store.avatars, timeEntries: store.timeEntries }); }
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
        function updateClock() { const n = new Date(); document.getElementById('clock').textContent = n.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', hourCycle:'h23'}); document.getElementById('date').textContent = n.toLocaleDateString(undefined, {weekday:'long', month:'long', day:'numeric'}); }
        function toggleTheme() { store.theme = store.theme === 'light' ? 'dark' : 'light'; localStorage.setItem('nexus_theme', store.theme); loadTheme(); }
        function loadTheme() { document.body.classList.toggle('dark', store.theme === 'dark'); document.getElementById('theme-icon').className = store.theme === 'dark' ? 'fas fa-sun' : 'fas fa-moon'; }
        function switchView(v) { document.getElementById('view-dashboard').classList.toggle('hidden', v !== 'dashboard'); document.getElementById('view-kanban').classList.toggle('hidden', v !== 'kanban'); document.getElementById('nav-dashboard').classList.toggle('active', v === 'dashboard'); document.getElementById('nav-kanban').classList.toggle('active', v === 'kanban'); }
        function changeMonth(d) { store.calendarMonth += d; if(store.calendarMonth > 11) { store.calendarMonth = 0; store.calendarYear++; } else if(store.calendarMonth < 0) { store.calendarMonth = 11; store.calendarYear--; } renderCalendar(); }
        function addMember() { const n = document.getElementById('new-member-name').value.trim(); if(n && !store.users.includes(n)) { store.users.push(n); pushToCloud(); document.getElementById('new-member-name').value=''; } }
        function removeMember(i) { store.users.splice(i, 1); pushToCloud(); }
        function togglePasswordVisibility() { const p = document.getElementById('login-password'); p.type = p.type === 'password' ? 'text' : 'password'; }
        function changeMonth(d) { store.calendarMonth += d; if(store.calendarMonth > 11) { store.calendarMonth = 0; store.calendarYear++; } else if(store.calendarMonth < 0) { store.calendarMonth = 11; store.calendarYear--; } renderCalendar(); }
        
        // Drag & Drop
        window.allowDrop = (e) => e.preventDefault();
        window.drop = (e, val, type) => {
            e.preventDefault();
            const task = store.kanbanTasks.find(t => t.id === draggedItem);
            if(task && task.status !== val) {
                task.status = val;
                pushToCloud();
                renderKanbanBoard();
            }
        };

        function sendAdminMessage() {
            const val = document.getElementById('admin-msg-input').value.trim();
            if (val && store.currentUser) {
                store.adminMessages[store.currentUser] = { msg: val, timestamp: Date.now() };
                db.ref('projectData/adminMessages').set(store.adminMessages);
                alert("Message sent to Admin.");
                document.getElementById('admin-msg-input').value = '';
            }
        }

        function renderAdminMailbox() {
            const viewer = document.getElementById('admin-message-viewer');
            viewer.innerHTML = '';
            for (let user in store.adminMessages) {
                const div = document.createElement('div');
                div.className = "bg-white p-2 rounded mb-2 text-xs border-l-2 border-amber-500";
                div.innerHTML = `<b>${user}:</b> ${store.adminMessages[user].msg}`;
                viewer.appendChild(div);
            }
        }

        function clearAllData() { if(confirm("Nuke everything?")) { db.ref('projectData').remove(); location.reload(); } }
        function backupData() { const blob = new Blob([JSON.stringify(store)], {type:'application/json'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download='backup.json'; a.click(); }
        function changeMyPassword() { const p = prompt("New Password:"); if(p) { store.passwords[store.currentUser || "Admin"] = p; db.ref('projectData/passwords').set(store.passwords); } }
        function triggerAvatarUpload(u) { uploadingUser = u; document.getElementById('avatar-upload').click(); }
        function handleAvatarFile(input) {
            const reader = new FileReader();
            reader.onload = (e) => {
                if(e.target.result.length > 500000) return alert("File too big.");
                store.avatars[uploadingUser] = e.target.result;
                pushToCloud();
            };
            reader.readAsDataURL(input.files[0]);
        }
    </script>
</body>
</html>