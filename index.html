<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PersonalSpace - Team Project Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/dark.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-analytics-compat.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { 
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        glass: "rgba(255, 255, 255, 0.95)",
                        darkGlass: "rgba(30, 41, 59, 0.95)",
                        sidebar: "rgba(36, 0, 70, 0.85)",
                        jokerPurple: "#3c096c",
                        jokerGreen: "#39ff14"
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background: linear-gradient(135deg, #9d4edd, #70e000);
            min-height: 100vh;
            transition: background 0.5s ease;
            overflow: hidden; 
            font-family: 'Inter', sans-serif;
        }
        .dark body {
             background: linear-gradient(135deg, #10002b, #004b23);
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(157, 78, 221, 0.3);
            box-shadow: 0 8px 32px 0 rgba(60, 9, 108, 0.2);
        }
        .dark .glass-panel {
            background: rgba(20, 10, 40, 0.85);
            color: #e2e8f0;
            border: 1px solid rgba(57, 255, 20, 0.1);
        }
        .sidebar {
            background: rgba(36, 0, 70, 0.7);
            backdrop-filter: blur(20px);
            border-right: 1px solid rgba(255,255,255,0.1);
        }
        .dark .sidebar { background: rgba(10, 0, 20, 0.8); }
        
        .nav-item.active { 
            background: rgba(255, 255, 255, 0.1); 
            border-left: 4px solid #39ff14; 
            color: #39ff14;
        }
        .dark .nav-item.active { 
            background: rgba(255, 255, 255, 0.05); 
            border-left: 4px solid #9d4edd; 
            color: #d8b4fe;
        } 

        .column-body { min-height: 200px; transition: background-color 0.2s; }
        .column-body.drag-over { background-color: rgba(57, 255, 20, 0.15); border-radius: 0.5rem; }
        
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(157, 78, 221, 0.5); border-radius: 3px; }

        .task-card { cursor: grab; }
        .task-card:active { cursor: grabbing; }
        .dragging { opacity: 0.5; transform: scale(0.98); }
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Calendar Styles */
        .calendar-grid { 
            display: grid; 
            grid-template-columns: repeat(7, 1fr); 
            border-top: 1px solid #e2e8f0; 
            border-left: 1px solid #e2e8f0;
        }
        .dark .calendar-grid {
            border-color: #3c096c;
        }
        
        .calendar-day { 
            min-height: 80px; 
            max-height: 110px; 
            overflow-y: auto;  
            overflow-x: hidden;
            display: flex; 
            flex-direction: column; 
            align-items: flex-start; 
            justify-content: flex-start;
            padding: 4px;
            font-size: 0.85rem; 
            cursor: pointer; 
            position: relative;
            transition: background 0.2s;
            border-right: 1px solid #e2e8f0;
            border-bottom: 1px solid #e2e8f0;
            background: rgba(255,255,255,0.4);
        }
        .calendar-day::-webkit-scrollbar { width: 2px; }
        .calendar-day::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.2); }

        .dark .calendar-day {
            border-color: #3c096c;
            background: rgba(30, 41, 59, 0.4);
        }

        .calendar-day:hover { background: rgba(57, 255, 20, 0.15); }
        .calendar-day.today { background: #3c096c; color: #39ff14; font-weight: bold; border: 1px solid #39ff14; }
        .dark .calendar-day.today { background: #240046; color: #39ff14; }

        .calendar-day-number { 
            margin-bottom: 2px; 
            position: sticky; 
            top: 0;
            z-index: 10;
            width: 100%;
            padding: 2px 4px;
            font-weight: bold;
            border-bottom: 1px solid rgba(0,0,0,0.05);
            background: rgba(255,255,255,0.85); 
            backdrop-filter: blur(4px);
        }
        .dark .calendar-day-number {
            background: rgba(30, 41, 59, 0.85);
            border-color: rgba(255,255,255,0.05);
        }

        .cal-event-item {
            font-size: 0.65rem;
            line-height: 1.2;
            padding: 4px 5px;
            border-radius: 3px;
            background: rgba(255, 255, 255, 0.6);
            margin-top: 2px;
            width: 100%;
            white-space: normal; 
            word-break: break-word;
            text-align: left; 
            border-left: 3px solid #ccc; 
            display: flex;
            flex-direction: column;
            gap: 2px;
            position: relative;
            color: #334155;
            padding-right: 2px;
        }
        .dark .cal-event-item {
            background: rgba(15, 23, 42, 0.6);
            color: #e2e8f0;
        }

        /* Urgency Colors */
        .cal-urgency-low { border-left-color: #39ff14 !important; background: rgba(57, 255, 20, 0.1); }
        .cal-urgency-medium { border-left-color: #9d4edd !important; background: rgba(157, 78, 221, 0.1); }
        .cal-urgency-high { border-left-color: #ef4444 !important; background: rgba(239, 68, 68, 0.1); }
        
        /* Special Critical Task Style for Calendar */
        .cal-task-critical { 
            border-left-color: #f97316 !important; 
            background: rgba(249, 115, 22, 0.15) !important;
            border-style: dashed;
        }

        .cal-actions-container {
            position: absolute;
            top: 2px;
            right: 2px;
            display: flex;
            gap: 3px;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 20;
            padding: 2px 4px;
            border-radius: 4px;
            background: rgba(255, 255, 255, 0.95);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            border: 1px solid rgba(0,0,0,0.1);
        }
        .dark .cal-actions-container {
            background: rgba(30, 41, 59, 0.95);
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .cal-event-item:hover .cal-actions-container { opacity: 1; }

        .cal-action-btn {
            width: 16px;
            height: 16px;
            background: rgba(0,0,0, 0.05);
            color: #64748b;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 9px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .dark .cal-action-btn { background: rgba(255,255,255, 0.1); color: #94a3b8; }
        
        .cal-btn-del:hover { background: #ef4444 !important; color: white !important; transform: scale(1.1); }
        .cal-btn-check:hover { background: #39ff14 !important; color: black !important; transform: scale(1.1); }

        .cal-time { font-weight: 800; opacity: 0.9; font-size: 0.6rem; display: block; border-bottom: 1px solid rgba(0,0,0,0.05); padding-bottom:1px; margin-bottom:1px;}

        .flag-btn {
            cursor: pointer;
            transition: all 0.2s;
            color: #cbd5e1; 
        }
        .dark .flag-btn { color: #475569; }
        
        .flag-rating:hover .flag-btn { color: #9d4edd; } 
        .flag-btn:hover ~ .flag-btn { color: #cbd5e1; } 
        .dark .flag-rating:hover .flag-btn { color: #9d4edd; }
        .dark .flag-btn:hover ~ .flag-btn { color: #475569; }
        .flag-btn.active { color: #9d4edd; }
        
        .avatar-container:hover .avatar-overlay { opacity: 1; }
        
        .view-btn { transition: all 0.2s; }
        .view-btn.active { background-color: rgba(57, 255, 20, 0.2); font-weight: bold; border: 1px solid #39ff14; color: #39ff14; }

        .timer-active { animation: pulse-green 2s infinite; }
        @keyframes pulse-green {
            0% { text-shadow: 0 0 0 rgba(57, 255, 20, 0); }
            50% { text-shadow: 0 0 4px rgba(57, 255, 20, 0.5); }
            100% { text-shadow: 0 0 0 rgba(57, 255, 20, 0); }
        }
        
        .flatpickr-calendar {
            background: rgba(36, 0, 70, 0.95) !important; 
            border: 1px solid #39ff14 !important;
            backdrop-filter: blur(10px) !important;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5) !important;
            z-index: 9999 !important;
        }
        .flatpickr-day.selected {
            background: #39ff14 !important;
            border-color: #39ff14 !important;
            color: black !important;
            font-weight: bold;
        }
        
        /* Helper to hide admin tools */
        .admin-only { transition: all 0.3s; }
        .admin-only.hidden-tool { display: none !important; }

        /* Login Screen Styles */
        #login-overlay {
            background: #10002b;
            z-index: 200;
        }
    </style>
</head>
<body class="text-slate-800 antialiased flex flex-col h-screen w-screen overflow-hidden">

    <div id="login-overlay" class="fixed inset-0 flex items-center justify-center transition-opacity duration-500">
        <div class="glass-panel p-8 rounded-3xl w-full max-sm:w-[90%] max-w-sm border-2 border-jokerPurple shadow-[0_0_50px_rgba(157,78,221,0.3)]">
            <div class="text-center mb-6">
                <h1 class="text-3xl font-bold text-jokerGreen tracking-tighter">PersonalSpace</h1>
                <p class="text-white/50 text-xs uppercase tracking-widest">Secure Entry</p>
            </div>

            <div class="space-y-4">
                <div>
                    <label class="text-[10px] text-purple-400 font-bold uppercase ml-1">Identity</label>
                    <select id="login-username" class="w-full bg-white/10 border border-white/20 rounded-xl px-4 py-3 text-white outline-none focus:border-jokerGreen appearance-none cursor-pointer">
                        <option value="Admin" class="text-slate-900">★ Admin</option>
                    </select>
                </div>

                <div>
                    <label class="text-[10px] text-purple-400 font-bold uppercase ml-1">Password</label>
                    <div class="relative">
                        <input type="password" id="login-password" placeholder="••••••••" 
                            class="w-full bg-white/10 border border-white/20 rounded-xl px-4 py-3 text-white outline-none focus:border-jokerGreen placeholder-white/20">
                        <button type="button" onclick="togglePasswordVisibility()" class="absolute right-3 top-1/2 -translate-y-1/2 text-white/50 hover:text-jokerGreen transition">
                            <i id="eye-icon" class="fas fa-eye"></i>
                        </button>
                    </div>
                </div>

                <button onclick="handleLogin()" class="w-full bg-jokerGreen hover:bg-green-400 text-black font-black py-3 rounded-xl transition transform active:scale-95 shadow-lg">
                    ACCESS SYSTEM
                </button>
                <p id="login-error" class="text-red-400 text-[10px] text-center font-bold hidden uppercase animate-pulse">Invalid Credentials</p>
                <p class="text-white/30 text-[9px] text-center font-bold tracking-widest uppercase mt-2">Welcome to PersonalSpaceHub</p>
            </div>
        </div>
    </div>

    <div class="absolute top-0 left-1/2 transform -translate-x-1/2 bg-purple-900 text-white px-3 py-1 text-[10px] rounded-b-lg shadow-lg z-50 font-bold opacity-90 border border-t-0 border-green-400" id="connection-status">
        <i class="fas fa-circle-notch fa-spin mr-1 text-yellow-400"></i> Connecting to Cloud...
    </div>

    <input type="file" id="avatar-upload" class="hidden" accept="image/*" onchange="handleAvatarFile(this)">
    <input type="file" id="restore-upload" class="hidden" accept=".json" onchange="handleRestore(this)">

    <div class="flex flex-1 overflow-hidden relative">
        <aside class="sidebar w-64 flex-shrink-0 flex flex-col justify-between h-full z-20 transition-all duration-300 transform -translate-x-full md:translate-x-0 absolute md:relative" id="main-sidebar">
        
        <div class="p-6 text-white">
            <h1 class="text-2xl font-bold tracking-wider text-green-400">PersonalSpace</h1>
            <p class="text-xs text-white/60 uppercase tracking-wider mt-1">Team Project Hub</p>
        </div>

        <div class="px-4 mb-4">
                <label class="text-[10px] text-green-400/80 uppercase font-bold block mb-1">Signed In As:</label>
                <div id="active-user-display" class="w-full bg-purple-900/50 border border-purple-500/30 rounded px-3 py-2 text-sm text-white font-medium flex justify-between items-center">
                    <span id="current-user-name">Admin</span>
                    <button onclick="logout()" class="text-red-400 hover:text-red-300" title="Logout"><i class="fas fa-sign-out-alt"></i></button>
                </div>
                <p class="text-[10px] text-white/50 mt-1 italic" id="view-mode-hint">Loading...</p>
            </div>

            <nav class="flex-1 px-4 space-y-2">
                <button onclick="switchView('dashboard')" id="nav-dashboard" class="nav-item w-full flex items-center gap-3 text-white px-4 py-3 rounded-r-lg transition hover:bg-white/10 active">
                    <i class="fas fa-home w-5"></i> Dashboard
                </button>
                <button onclick="switchView('kanban')" id="nav-kanban" class="nav-item w-full flex items-center gap-3 text-white px-4 py-3 rounded-r-lg transition hover:bg-white/10">
                    <i class="fas fa-tasks w-5"></i> Task Tracker
                </button>
            </nav>

            <div class="p-4 border-t border-purple-500/30">
                <h3 class="text-xs font-bold text-green-400 uppercase mb-3 flex justify-between items-center">
                    Team Members 
                    <span id="member-count" class="bg-purple-800 px-2 rounded-full text-[10px] text-white">0</span>
                </h3>
                
                <div id="admin-tools-members" class="admin-only flex gap-2 mb-3">
                    <input type="text" id="new-member-name" placeholder="Name..." 
                        class="w-full bg-white/10 border border-white/20 rounded px-2 py-1 text-sm text-white placeholder-white/50 focus:outline-none focus:bg-white/20 focus:border-green-400">
                    <button onclick="addMember()" class="bg-green-600 hover:bg-green-500 text-black font-bold px-2 rounded text-sm transition">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
                
                <p class="text-[9px] text-white/40 italic mb-2">Click avatar to upload photo</p>
                <ul id="team-list" class="space-y-2 max-h-40 overflow-y-auto pr-1">
                    <li class="text-white/50 text-xs italic">Loading team...</li>
                </ul>
            </div>

            <div class="p-4 flex flex-col gap-3 border-t border-purple-500/30">
                <div class="flex justify-between items-center">
                    <button onclick="changeMyPassword()" class="text-[10px] text-amber-400 hover:text-amber-200 transition flex items-center gap-2">
                        <i class="fas fa-lock"></i> Update My Password
                    </button>
                    <button onclick="toggleTheme()" class="text-green-400 hover:text-white transition text-xs" title="Toggle Theme"><i class="fas fa-moon" id="theme-icon"></i></button>
                </div>
                
                <div id="admin-tools-data" class="admin-only flex flex-col gap-2">
                    <button onclick="changeAdminPassword()" class="text-left text-[10px] text-amber-400 hover:text-amber-200 transition flex items-center gap-2 mb-1">
                        <i class="fas fa-key"></i> Update Admin Password
                    </button>

                    <div class="grid grid-cols-2 gap-2">
                        <button onclick="backupData()" class="bg-purple-500/20 hover:bg-purple-500/40 text-purple-200 text-[10px] py-1 rounded transition flex items-center justify-center gap-1 border border-purple-500/30">
                            <i class="fas fa-download"></i> Backup
                        </button>
                        <button onclick="triggerRestore()" class="bg-green-500/20 hover:bg-green-500/40 text-green-200 text-[10px] py-1 rounded transition flex items-center justify-center gap-1 border border-green-500/30">
                            <i class="fas fa-upload"></i> Restore
                        </button>
                    </div>

                    <button onclick="clearAllData()" class="text-left text-[10px] text-red-300 hover:text-red-100 transition flex items-center gap-2 mt-1">
                        <i class="fas fa-trash-alt"></i> Nuke Cloud Data
                    </button>
                </div>
                
                <div class="text-white/30 text-[10px] text-center mt-2 pt-2 border-t border-white/5">
                    &copy; 2025 PersonalSpace
                </div>
            </div>
        </aside>

        <main class="flex-1 relative h-full overflow-hidden flex flex-col bg-white/5 backdrop-blur-sm">
            
            <button onclick="document.getElementById('main-sidebar').classList.toggle('-translate-x-full')" class="md:hidden absolute top-4 left-4 z-50 text-white bg-purple-600 p-2 rounded-lg shadow-lg">
                <i class="fas fa-bars"></i>
            </button>

            <div id="view-dashboard" class="flex-1 overflow-hidden p-4 md:p-6 fade-in h-full flex flex-col">
                
                <header class="mb-4 text-white shrink-0">
                    <div class="flex justify-between items-center">
                        <div>
                            <h1 class="text-3xl font-bold tracking-tight text-green-400" id="clock">00:00</h1>
                            <p class="text-sm opacity-90 mt-1 font-bold" id="date">Loading date...</p>
                        </div>
                        
                        <div class="flex items-center gap-4">
                            <div class="text-right">
                                <p class="text-lg font-bold text-white leading-tight" id="greeting">Connecting...</p>
                                <span id="dashboard-owner-badge" class="bg-green-500 text-black px-2 py-0.5 rounded-full text-[10px] font-bold uppercase tracking-wider hidden shadow-lg border border-white/20">Secret Lair</span>
                            </div>
                            <div id="header-avatar" class="w-14 h-14 rounded-full bg-purple-900 border-2 border-green-400 shadow-lg flex items-center justify-center overflow-hidden shrink-0 cursor-pointer avatar-container relative" onclick="triggerAvatarUpload('Admin')">
                                <i class="fas fa-user text-white/50 text-2xl"></i>
                                <div class="avatar-overlay absolute inset-0 bg-black/50 rounded-full flex items-center justify-center opacity-0 transition">
                                    <i class="fas fa-camera text-xs text-white"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </header>

                <div class="flex flex-col gap-4 flex-1 min-h-0">
                    
                    <div class="grid grid-cols-1 lg:grid-cols-10 gap-4 flex-1 min-h-0">
                        
                        <div class="lg:col-span-3 flex flex-col gap-4 h-full min-h-0">
                            
                            <div class="glass-panel rounded-2xl p-4 h-1/3 flex flex-col min-h-[200px]">
                                <h2 class="text-sm font-bold mb-2 flex items-center gap-2 text-purple-700 dark:text-purple-300">
                                    <i class="fas fa-sticky-note"></i> Quick Notes
                                </h2>
                                <textarea id="notepad" 
                                    class="flex-1 w-full bg-purple-50 dark:bg-slate-900/50 border-none rounded-lg p-3 resize-none focus:ring-2 focus:ring-green-400 outline-none transition text-slate-700 dark:text-slate-200 text-sm"
                                    placeholder="Type your notes here (Private to you)..."
                                    onchange="saveNotes(this.value)"></textarea>
                                <div class="text-[10px] text-right mt-1 text-slate-400" id="notes-status">Saved</div>
                            </div>

                            <div id="admin-channel-panel" class="glass-panel rounded-2xl p-4 h-1/4 flex flex-col min-h-[150px] border-t-4 border-amber-500">
                                <h2 class="text-sm font-bold mb-2 flex items-center gap-2 text-amber-600 dark:text-amber-400">
                                    <i class="fas fa-user-shield"></i> <span id="admin-channel-title">Secure Admin Channel</span>
                                </h2>
                                <div id="admin-message-viewer" class="hidden flex-1 overflow-y-auto space-y-2 mb-2 pr-1">
                                    </div>
                                <div id="member-message-sender" class="flex flex-col gap-2 flex-1">
                                    <div id="admin-reply-display" class="hidden mb-2 p-2 bg-blue-50 dark:bg-blue-900/30 rounded border border-blue-200 dark:border-blue-800 text-[10px] italic">
                                        <b class="text-blue-600 block mb-1">ADMIN RESPONSE:</b>
                                        <span id="reply-text">...</span>
                                    </div>
                                    <textarea id="admin-msg-input" 
                                        class="flex-1 w-full bg-amber-50 dark:bg-slate-900/50 border border-amber-200 dark:border-amber-900/50 rounded-lg p-2 resize-none focus:ring-2 focus:ring-amber-400 outline-none transition text-slate-700 dark:text-slate-200 text-xs"
                                        placeholder="Send private note to Admin..."></textarea>
                                    <button onclick="sendAdminMessage()" class="w-full bg-amber-500 hover:bg-amber-600 text-white font-bold py-1.5 rounded-lg text-[10px] transition transform active:scale-95 shadow-md">
                                        SEND TO ADMIN
                                    </button>
                                </div>
                            </div>

                            <div class="glass-panel rounded-2xl p-4 flex-1 flex flex-col min-h-0">
                                <h2 class="text-sm font-bold mb-3 flex items-center gap-2 text-green-600 dark:text-green-400 shrink-0">
                                    <i class="fas fa-check-circle"></i> Quick Tasks
                                </h2>
                                
                                <div class="flex flex-col gap-2 mb-3 bg-purple-50 dark:bg-purple-900/20 p-2 rounded-xl border border-purple-100 dark:border-purple-800 shrink-0">
                                    <input type="text" id="quick-task-input" placeholder="New task..." 
                                        class="w-full bg-white dark:bg-slate-700/50 border border-purple-200 dark:border-purple-600 rounded-lg px-3 py-1.5 text-sm focus:ring-2 focus:ring-green-500 outline-none dark:text-white">
                                    
                                    <div class="flex flex-wrap gap-2">
                                        <input type="date" id="quick-task-date" class="flex-1 bg-white dark:bg-slate-700/50 border border-purple-200 dark:border-purple-600 rounded-lg px-2 py-1.5 text-[10px] font-bold text-slate-600 dark:text-slate-300 focus:ring-2 focus:ring-green-500 outline-none cursor-pointer">

                                        <select id="quick-task-assignee" class="flex-1 bg-white dark:bg-slate-700/50 border border-purple-200 dark:border-purple-600 rounded-lg px-2 py-1.5 text-[10px] font-bold text-slate-600 dark:text-slate-300 focus:ring-2 focus:ring-green-500 outline-none cursor-pointer">
                                            <option value="">Unassigned</option>
                                        </select>
                                        
                                        <select id="quick-task-status" class="w-24 bg-white dark:bg-slate-700/50 border border-purple-200 dark:border-purple-600 rounded-lg px-2 py-1.5 text-[10px] font-bold text-slate-600 dark:text-slate-300 focus:ring-2 focus:ring-green-500 outline-none cursor-pointer">
                                            <option value="todo">To Do</option>
                                            <option value="inprogress">Doing</option>
                                            <option value="done">Done</option>
                                        </select>
                                        
                                        <button onclick="addQuickTask()" class="bg-jokerGreen hover:bg-green-400 text-black font-bold rounded-lg px-3 transition transform active:scale-95 shadow-lg shadow-green-500/30 text-xs">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                    </div>
                                </div>
                                
                                <ul id="quick-task-list" class="flex-1 overflow-y-auto space-y-2 pr-1 min-h-0"></ul>
                            </div>
                            </div>

                        <div class="lg:col-span-7 glass-panel rounded-2xl p-4 flex flex-col h-full shrink-0 min-h-[250px]">
                            <div class="flex justify-between items-center mb-2 shrink-0">
                                <h2 class="text-sm font-bold flex items-center gap-2 text-purple-700 dark:text-purple-400">
                                    <i class="fas fa-calendar-alt"></i> Private Schedule
                                </h2>
                                <div class="flex gap-2 text-xs text-slate-600 dark:text-slate-300">
                                    <button onclick="changeMonth(-1)" class="hover:text-green-500 w-6 h-6 flex items-center justify-center rounded-full hover:bg-slate-100 dark:hover:bg-slate-700"><i class="fas fa-chevron-left"></i></button>
                                    <span id="calendar-month-year" class="font-bold w-24 text-center flex items-center justify-center">...</span>
                                    <button onclick="changeMonth(1)" class="hover:text-green-500 w-6 h-6 flex items-center justify-center rounded-full hover:bg-slate-100 dark:hover:bg-slate-700"><i class="fas fa-chevron-right"></i></button>
                                </div>
                            </div>

                            <div class="grid grid-cols-7 text-center text-[10px] font-bold text-slate-500 dark:text-slate-400 uppercase mb-0 border-b border-purple-200 dark:border-purple-900 bg-purple-50 dark:bg-purple-900/20 py-1 rounded-t-lg shrink-0">
                                <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
                            </div>

                            <div id="calendar-body" class="calendar-grid flex-1 overflow-y-auto">
                            </div>
                            
                            <div class="mt-1 text-center text-[10px] text-slate-400 italic shrink-0">Hover events to update urgency or resolve.</div>
                        </div>

                    </div>
                </div>
            </div>

            <div id="view-kanban" class="flex-1 overflow-hidden p-4 md:p-6 fade-in hidden flex-col h-full">
                
                <div class="flex flex-col md:flex-row justify-between items-center mb-6 shrink-0 text-white gap-4">
                    <div class="flex-1">
                        <h2 class="text-2xl font-bold flex items-center gap-2 text-green-400 tracking-wide">
                            Task Tracker 
                            <span id="tracker-badge" class="text-xs bg-white/20 px-2 py-0.5 rounded text-white/80 font-normal font-sans">Status View</span>
                        </h2>
                        <p class="text-sm opacity-80" id="tracker-subtitle">Manage project progress</p>
                    </div>

                    <div class="bg-black/40 p-1 rounded-lg flex text-xs font-bold items-center gap-2 border border-purple-500/50">
                        <button onclick="switchKanbanView('status')" id="btn-view-status" class="view-btn active px-3 py-1.5 rounded text-white">Status</button>
                        <button onclick="switchKanbanView('week')" id="btn-view-week" class="view-btn px-3 py-1.5 rounded text-white text-opacity-70 hover:text-opacity-100">Week View</button>
                    </div>

                    <div id="kanban-filter-container" class="flex items-center gap-2 bg-black/40 p-1 rounded-lg border border-purple-500/50">
                            <div class="relative flex items-center">
                                <i class="fas fa-calendar-alt text-green-400/70 text-xs absolute left-2 pointer-events-none"></i>
                                <input type="text" id="date-range-picker" placeholder="Date / Filter..." 
                                    class="bg-white/10 border-none text-white text-xs rounded px-2 py-1 pl-6 outline-none w-48 placeholder-white/50 cursor-pointer">
                            </div>
                            <button onclick="clearFilters()" class="text-xs text-white/50 hover:text-white px-2" title="Clear Filter"><i class="fas fa-times"></i></button>
                    </div>

                    <div class="flex gap-2">
                        <button onclick="exportSummaryReport()" class="bg-amber-600 hover:bg-amber-700 text-white px-4 py-2 rounded-lg transition flex items-center gap-2 text-sm border border-white/10 font-bold">
                            <i class="fas fa-file-export"></i> Detailed Export & Flush
                        </button>
                        <button onclick="openTaskModal()" class="bg-green-500 hover:bg-green-600 text-black font-bold px-4 py-2 rounded-lg shadow-lg transition flex items-center gap-2 text-sm">
                            <i class="fas fa-plus"></i> New Task
                        </button>
                    </div>
                </div>

                <div id="kanban-status-view" class="flex-1 overflow-x-auto overflow-y-hidden pb-2 h-full">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 h-full min-w-[800px] md:min-w-0">
                        
                        <div class="glass-panel rounded-xl flex flex-col h-full border-t-4 border-slate-400">
                            <div class="p-3 border-b border-slate-200 dark:border-slate-700 flex justify-between items-center bg-white/50 dark:bg-slate-800/50">
                                <h3 class="font-bold text-slate-700 dark:text-slate-200">To Do</h3>
                                <span id="count-todo" class="bg-slate-200 dark:bg-slate-700 text-xs px-2 py-1 rounded-full">0</span>
                            </div>
                            <div class="column-body p-3 flex-1 overflow-y-auto space-y-3" ondrop="drop(event, 'todo', 'status')" ondragover="allowDrop(event)"></div>
                        </div>

                        <div class="glass-panel rounded-xl flex flex-col h-full border-t-4 border-purple-600">
                            <div class="p-3 border-b border-slate-200 dark:border-slate-700 flex justify-between items-center bg-white/50 dark:bg-slate-800/50">
                                <h3 class="font-bold text-purple-700 dark:text-purple-400">In Progress</h3>
                                <span id="count-inprogress" class="bg-purple-100 dark:bg-purple-900/50 text-purple-600 dark:text-purple-300 text-xs px-2 py-1 rounded-full">0</span>
                            </div>
                            <div class="column-body p-3 flex-1 overflow-y-auto space-y-3" ondrop="drop(event, 'inprogress', 'status')" ondragover="allowDrop(event)"></div>
                        </div>

                        <div class="glass-panel rounded-xl flex flex-col h-full border-t-4 border-green-500">
                            <div class="p-3 border-b border-slate-200 dark:border-slate-700 flex justify-between items-center bg-white/50 dark:bg-slate-800/50">
                                <h3 class="font-bold text-green-600 dark:text-green-400">Executed</h3>
                                <span id="count-done" class="bg-green-100 dark:bg-green-900/50 text-green-700 dark:text-green-300 text-xs px-2 py-1 rounded-full">0</span>
                            </div>
                            <div class="column-body p-3 flex-1 overflow-y-auto space-y-3" ondrop="drop(event, 'done', 'status')" ondragover="allowDrop(event)"></div>
                        </div>

                    </div>
                </div>

                <div id="kanban-week-view" class="flex-1 overflow-x-auto overflow-y-hidden pb-2 h-full hidden">
                    <div class="flex items-center gap-4 mb-4 text-white">
                        <button onclick="changeWeek(-1)" class="bg-white/10 hover:bg-white/20 px-3 py-1 rounded text-sm transition font-bold"><i class="fas fa-chevron-left mr-2"></i> Prev Week</button>
                        <span id="week-view-date-range" class="text-sm font-bold text-green-400 tracking-wider uppercase">Loading...</span>
                        <button onclick="changeWeek(1)" class="bg-white/10 hover:bg-white/20 px-3 py-1 rounded text-sm transition font-bold">Next Week <i class="fas fa-chevron-right ml-2"></i></button>
                    </div>
                    <div id="week-columns-container" class="grid grid-cols-7 gap-3 h-full min-w-[1200px]"></div>
                </div>

            </div>
        </main>
    </div>

    <div id="task-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm hidden flex items-center justify-center z-50 p-4">
        <div class="bg-white dark:bg-slate-800 rounded-2xl w-full max-w-md p-6 shadow-2xl border-2 border-purple-500">
            <h2 class="text-xl font-bold mb-4 dark:text-white text-purple-800 tracking-wide" id="modal-title">Task Details</h2>
            <input type="hidden" id="task-id">
            
            <div class="mb-3">
                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Title</label>
                <input type="text" id="task-title" class="w-full bg-slate-100 dark:bg-slate-700 border-none rounded-lg p-3 focus:ring-2 focus:ring-purple-500 outline-none dark:text-white">
            </div>

            <div class="grid grid-cols-2 gap-3 mb-3">
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Assign To</label>
                    <select id="task-assignee" class="w-full bg-slate-100 dark:bg-slate-700 border-none rounded-lg p-3 focus:ring-2 focus:ring-purple-500 outline-none dark:text-white">
                        <option value="">Unassigned</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Scheduled Date</label>
                    <input type="date" id="task-date" class="w-full bg-slate-100 dark:bg-slate-700 border-none rounded-lg p-3 focus:ring-2 focus:ring-purple-500 outline-none dark:text-white text-sm">
                </div>
            </div>
            
            <div class="mb-3">
                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Urgency Level</label>
                <div class="flex gap-3 text-xl flag-rating" id="priority-selector">
                    <input type="hidden" id="task-priority" value="1">
                    <i class="fas fa-flag flag-btn" data-val="1" onclick="setPriority(1)"></i>
                    <i class="fas fa-flag flag-btn" data-val="2" onclick="setPriority(2)"></i>
                    <i class="fas fa-flag flag-btn" data-val="3" onclick="setPriority(3)"></i>
                    <i class="fas fa-flag flag-btn" data-val="4" onclick="setPriority(4)"></i>
                    <i class="fas fa-flag flag-btn" data-val="5" onclick="setPriority(5)"></i>
                </div>
                <p class="text-[10px] text-slate-400 mt-1" id="priority-text">Low Urgency</p>
            </div>
            
            <div class="mb-6">
                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Description</label>
                <textarea id="task-desc" rows="3" class="w-full bg-slate-100 dark:bg-slate-700 border-none rounded-lg p-3 focus:ring-2 focus:ring-purple-500 outline-none dark:text-white"></textarea>
            </div>

            <div class="flex justify-between">
                <button type="button" onclick="deleteCurrentTask()" id="btn-delete" class="text-red-500 hover:text-red-700 text-sm hidden">Delete Task</button>
                <div class="flex gap-2 ml-auto">
                    <button onclick="closeModal('task-modal')" class="px-4 py-2 text-slate-500 dark:text-slate-400">Cancel</button>
                    <button onclick="saveTask()" class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-2 rounded-lg font-medium">Save</button>
                </div>
            </div>
        </div>
    </div>

    <div id="calendar-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm hidden flex items-center justify-center z-50 p-4">
        <div class="bg-white dark:bg-slate-800 rounded-2xl w-full max-w-sm p-6 shadow-2xl border border-purple-500">
            <h2 class="text-lg font-bold mb-1 dark:text-white text-purple-700 tracking-wider" id="cal-date-title">Date</h2>
            <p class="text-xs text-slate-500 mb-4">Scheduled Events & Critical Tasks</p>
            
            <input type="hidden" id="cal-date-val">
            
            <div id="day-events-list" class="mb-4 space-y-2 max-h-40 overflow-y-auto min-h-[50px] bg-slate-50 dark:bg-slate-700/50 rounded-lg p-2"></div>

            <div class="flex flex-col gap-2">
                
                <div class="flex gap-2 p-2 bg-slate-50 dark:bg-slate-700/30 rounded border border-slate-100 dark:border-slate-700">
                    <div class="flex-1">
                        <label class="text-[9px] font-bold text-slate-400 uppercase block mb-1">From Date</label>
                        <input type="date" id="evt-start-date" class="w-full bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded p-1 text-xs dark:text-white">
                    </div>
                    <div class="flex-1">
                        <label class="text-[9px] font-bold text-slate-400 uppercase block mb-1">To Date</label>
                        <input type="date" id="evt-end-date" class="w-full bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded p-1 text-xs dark:text-white">
                    </div>
                </div>

                <div class="flex gap-2 items-center mb-1">
                    <span class="text-[10px] font-bold text-slate-400 uppercase">Urgency:</span>
                    <button type="button" onclick="setCalUrgency('low')" id="btn-urgency-low" class="flex-1 text-[10px] py-1 rounded border border-green-500 text-green-600 bg-green-50 hover:bg-green-100 font-bold transition">Low</button>
                    <button type="button" onclick="setCalUrgency('medium')" id="btn-urgency-medium" class="flex-1 text-[10px] py-1 rounded border border-purple-200 text-purple-400 hover:bg-purple-50 font-bold transition">Med</button>
                    <button type="button" onclick="setCalUrgency('high')" id="btn-urgency-high" class="flex-1 text-[10px] py-1 rounded border border-red-200 text-red-400 hover:bg-red-50 font-bold transition">High</button>
                    <input type="hidden" id="new-event-urgency" value="low">
                </div>

                <div class="flex gap-2">
                    <div class="flex-1">
                        <label class="text-[10px] font-bold text-slate-400 uppercase">Start Time</label>
                        <input type="time" id="new-event-start" class="w-full bg-slate-100 dark:bg-slate-700 border-none rounded-lg p-2 text-sm focus:ring-2 focus:ring-green-500 outline-none dark:text-white">
                    </div>
                    <div class="flex-1">
                        <label class="text-[10px] font-bold text-slate-400 uppercase">End Time</label>
                        <input type="time" id="new-event-end" class="w-full bg-slate-100 dark:bg-slate-700 border-none rounded-lg p-2 text-sm focus:ring-2 focus:ring-green-500 outline-none dark:text-white">
                    </div>
                </div>
                
                <div class="flex gap-2">
                    <input type="text" id="new-event-input" placeholder="Event details..." class="flex-1 bg-slate-100 dark:bg-slate-700 border-none rounded-lg p-2 text-sm focus:ring-2 focus:ring-green-500 outline-none dark:text-white">
                    
                    <button id="btn-cancel-edit" onclick="cancelEditMode()" class="hidden bg-slate-200 hover:bg-slate-300 text-slate-600 font-bold px-3 py-2 rounded-lg transition">
                        <i class="fas fa-times"></i>
                    </button>

                    <button id="btn-add-event" onclick="addEvent()" class="bg-green-500 hover:bg-green-600 text-black font-bold px-3 py-2 rounded-lg transition">
                        <i id="btn-add-icon" class="fas fa-plus"></i>
                    </button>
                </div>
            </div>
            
            <div class="mt-4 text-right">
                <button onclick="closeModal('calendar-modal')" class="text-sm text-slate-500 hover:text-slate-700 dark:hover:text-slate-300">Close</button>
            </div>
        </div>
    </div>

    <script>
        // --- FIREBASE CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyCvfwF-_by5hoUIVoEowKwbzzKF3YkJWy0",
            authDomain: "personalspacehub-3a44d.firebaseapp.com",
            projectId: "personalspacehub-3a44d",
            storageBucket: "personalspacehub-3a44d.firebasestorage.app",
            messagingSenderId: "605942768680",
            appId: "1:605942768680:web:74702b5d902dd462f1811d",
            measurementId: "G-E1YDD7Y7MX",
            databaseURL: "https://personalspacehub-3a44d-default-rtdb.firebaseio.com/"
        };

        // Initialize Cloud Connection
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // --- GLOBAL STATE ---
        const store = {
            theme: localStorage.getItem('nexus_theme') || 'light',
            currentUser: null,
            users: [],
            kanbanTasks: [],
            avatars: {}, 
            focus: '',
            notes: '',
            adminMessages: {}, // { "User": { msg: "...", reply: "..." } }
            events: {}, 
            passwords: {},
            calendarMonth: new Date().getMonth(),
            calendarYear: new Date().getFullYear(),
            kanbanMode: 'status',
            weekViewStart: new Date()
        };
        
        let draggedItem = null;
        let uploadingUser = null;
        let editingEventIdx = null; 

        // --- CORE FUNCTIONS ---
        window.switchUser = switchUser;
        window.switchView = switchView;
        window.switchKanbanView = switchKanbanView;
        window.addMember = addMember;
        window.removeMember = removeMember;
        window.toggleTheme = toggleTheme;
        window.saveFocus = saveFocus;
        window.saveNotes = saveNotes;
        window.addQuickTask = addQuickTask;
        window.deleteQuickTask = deleteQuickTask;
        window.updateTaskStatus = updateTaskStatus;
        window.updateTaskPriority = updateTaskPriority;
        window.updateTaskDate = updateTaskDate; 
        window.toggleTaskPause = toggleTaskPause;
        window.openTaskModal = openTaskModal;
        window.closeModal = closeModal;
        window.saveTask = saveTask;
        window.deleteCurrentTask = deleteCurrentTask;
        window.clearAllData = clearAllData;
        window.backupData = backupData;
        window.triggerRestore = triggerRestore;
        window.handleRestore = handleRestore;
        window.setPriority = setPriority;
        window.clearFilters = clearFilters;
        window.changeWeek = changeWeek;
        
        window.triggerAvatarUpload = triggerAvatarUpload;
        window.handleAvatarFile = handleAvatarFile;

        window.changeMonth = changeMonth;
        window.openCalendarModal = openCalendarModal;
        window.addEvent = addEvent;
        window.deleteEvent = deleteEvent;
        window.resolveEvent = resolveEvent; 
        window.setCalUrgency = setCalUrgency; 
        window.updateEventUrgency = updateEventUrgency;
        window.initEditEvent = initEditEvent;
        window.cancelEditMode = cancelEditMode;

        // AUTH
        window.handleLogin = handleLogin;
        window.logout = logout;
        window.resetMemberPassword = resetMemberPassword;
        window.togglePasswordVisibility = togglePasswordVisibility; 
        window.changeAdminPassword = changeAdminPassword;
        window.changeMyPassword = changeMyPassword;

        // ADMIN CHANNEL FUNCTIONS
        window.sendAdminMessage = sendAdminMessage;
        window.clearAdminMessage = clearAdminMessage;
        window.replyToMember = replyToMember;
        window.resolveAdminMessage = resolveAdminMessage; // Logic updated

        // Drag & Drop
        window.dragStart = (e, id) => { draggedItem = id; e.target.classList.add('dragging'); };
        window.dragEnd = (e) => { e.target.classList.remove('dragging'); document.querySelectorAll('.column-body').forEach(c => c.classList.remove('drag-over')); };
        window.allowDrop = (e) => { e.preventDefault(); e.target.closest('.column-body')?.classList.add('drag-over'); };
        
        window.drop = (e, val, type) => {
            e.preventDefault();
            const col = e.target.closest('.column-body');
            col?.classList.remove('drag-over');
            if(draggedItem) { 
                if(type === 'status') updateTaskStatus(draggedItem, val); 
                if(type === 'date') updateTaskDate(draggedItem, val);
                draggedItem = null; 
            }
        };

        // EXPORT SUMMARY & FLUSH EXECUTED
        window.exportSummaryReport = () => {
            if(store.kanbanTasks.length === 0) return alert("No tasks available to report.");
            
            const todo = store.kanbanTasks.filter(t => t.status === 'todo');
            const ongoing = store.kanbanTasks.filter(t => t.status === 'inprogress');
            const executed = store.kanbanTasks.filter(t => t.status === 'done');

            let content = "PERSONAL SPACE - DETAILED PROJECT STATUS REPORT\n";
            content += `Generated On: ${new Date().toLocaleString()}\n`;
            content += "========================================================\n\n";

            const getTaskDetails = (t) => {
                const inProgTime = t.log && t.log.inprogress ? formatTime(t.log.inprogress) : "0m 0s";
                return `- ${t.title}\n  Assignee: ${t.assignee || 'Unassigned'}\n  Time Spent In-Progress: ${inProgTime}\n  Scheduled: ${t.assignedDate || 'Not set'}`;
            };

            content += "[STATUS: TO DO]\n";
            content += todo.map(t => getTaskDetails(t)).join('\n\n') || "No tasks.";
            
            content += "\n\n[STATUS: ONGOING (IN PROGRESS)]\n";
            content += ongoing.map(t => getTaskDetails(t)).join('\n\n') || "No tasks.";

            content += "\n\n[STATUS: EXECUTED (COMPLETED)]\n";
            content += executed.map(t => getTaskDetails(t)).join('\n\n') || "No tasks.";

            content += "\n\n========================================================\n";
            content += "End of Report. Completed tasks will be removed from cloud.";

            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Project_Execution_Report_${new Date().toISOString().slice(0,10)}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);

            if(confirm("Report exported. Flush (Delete) the Executed column from cloud now?")) {
                store.kanbanTasks = store.kanbanTasks.filter(t => t.status !== 'done');
                pushToCloud();
                renderKanbanBoard();
            }
        };

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', () => {
            loadTheme();
            updateClock();
            setInterval(updateClock, 1000);
            
            const today = new Date();
            const day = today.getDay(); 
            const diff = today.getDate() - day; 
            store.weekViewStart = new Date(today.setDate(diff));
            store.weekViewStart.setHours(0,0,0,0);

            document.getElementById('quick-task-input').addEventListener('keypress', (e) => {
                if(e.key === 'Enter') addQuickTask();
            });

            const statusDiv = document.getElementById('connection-status');
            
            db.ref('projectData').on('value', (snapshot) => {
                statusDiv.innerHTML = '<i class="fas fa-wifi mr-1 text-green-400"></i> Cloud Connected';
                statusDiv.classList.replace('bg-purple-900', 'bg-black');
                
                const data = snapshot.val();
                if(data) {
                    store.users = data.users || [];
                    store.kanbanTasks = data.kanbanTasks || [];
                    store.avatars = data.avatars || {};
                    store.passwords = data.passwords || { "Admin": "1234" };
                    store.adminMessages = data.adminMessages || {};
                    
                    const userKey = (store.currentUser || "Admin").replace(/[^a-zA-Z0-9]/g, '_');
                    
                    if(data.userData && data.userData[userKey]) {
                        store.notes = data.userData[userKey].notes || '';
                        store.focus = data.userData[userKey].focus || '';
                        store.events = data.userData[userKey].events || {};
                    } else {
                        store.notes = '';
                        store.events = {};
                    }

                    renderTeamList();
                    renderKanbanBoard(); 
                    renderCalendar();
                    updateDashboardUI();
                    updateUIForUser();
                    updateLoginDropdown();
                    
                    const savedUser = localStorage.getItem('ps_session_user');
                    if (savedUser && !store.currentUser) {
                        switchUser(savedUser === "Admin" ? "" : savedUser);
                        document.getElementById('login-overlay').classList.add('hidden');
                    }
                }
            });

            setInterval(updateKanbanTimers, 1000);

            flatpickr("#date-range-picker", {
                mode: "range", dateFormat: "Y-m-d", theme: "dark",
                onChange: (selectedDates) => {
                    if (store.kanbanMode === 'week' && selectedDates.length > 0) jumpToWeek(selectedDates[0]);
                    else if (selectedDates.length === 2 || selectedDates.length === 0) renderKanbanBoard();
                }
            });
        });

        // --- AUTH & USER LOGIC ---
        function togglePasswordVisibility() {
            const passInput = document.getElementById('login-password');
            const icon = document.getElementById('eye-icon');
            if (passInput.type === "password") {
                passInput.type = "text";
                icon.classList.replace('fa-eye', 'fa-eye-slash');
            } else {
                passInput.type = "password";
                icon.classList.replace('fa-eye-slash', 'fa-eye');
            }
        }

        function handleLogin() {
            const user = document.getElementById('login-username').value;
            const pass = document.getElementById('login-password').value;
            const correctPass = store.passwords[user] || "1234";

            if (pass === correctPass) {
                document.getElementById('login-overlay').classList.add('opacity-0');
                setTimeout(() => document.getElementById('login-overlay').classList.add('hidden'), 500);
                switchUser(user === "Admin" ? "" : user);
                localStorage.setItem('ps_session_user', user);
            } else {
                document.getElementById('login-error').classList.remove('hidden');
            }
        }

        function logout() {
            localStorage.removeItem('ps_session_user');
            location.reload();
        }

        function changeMyPassword() {
            const name = store.currentUser || "Admin";
            const newPass = prompt(`Enter new password for ${name}:`);
            if (newPass && newPass.trim().length > 0) {
                store.passwords[name] = newPass.trim();
                db.ref('projectData/passwords').update(store.passwords)
                    .then(() => alert("Password updated successfully!"))
                    .catch(err => alert("Error updating password."));
            }
        }

        function resetMemberPassword(username) {
            if (confirm(`Reset ${username}'s password to default (1234)?`)) {
                store.passwords[username] = "1234";
                db.ref('projectData/passwords').update(store.passwords);
                alert(`${username}'s password has been reset.`);
            }
        }

        function changeAdminPassword() {
            const currentPass = prompt("Enter NEW Admin password:");
            if (currentPass?.trim()) {
                store.passwords["Admin"] = currentPass.trim();
                db.ref('projectData/passwords').update(store.passwords);
            }
        }

        function updateLoginDropdown() {
            const select = document.getElementById('login-username');
            const currentVal = select.value;
            select.innerHTML = '<option value="Admin">★ Admin</option>';
            store.users.forEach(u => {
                const opt = new Option(u, u);
                opt.className = "text-slate-800";
                select.add(opt);
            });
            select.value = currentVal;
        }

        // --- DATA PUSH ---
        function pushToCloud() {
            db.ref('projectData').update({
                users: store.users,
                kanbanTasks: store.kanbanTasks,
                avatars: store.avatars,
                passwords: store.passwords,
                adminMessages: store.adminMessages 
            });
            saveUserDataToCloud();
        }
        
        function saveUserDataToCloud() {
            const userKey = (store.currentUser || "Admin").replace(/[^a-zA-Z0-9]/g, '_');
            db.ref('projectData/userData/' + userKey).update({
                notes: store.notes,
                focus: store.focus,
                events: store.events 
            });
        }

        // --- DASHBOARD UI UPDATES ---
        function switchUser(userName) {
            store.currentUser = userName || null;
            document.getElementById('current-user-name').textContent = userName || "Admin";
            db.ref('projectData').once('value').then(snap => {
               const data = snap.val();
               if(data) {
                    const userKey = (store.currentUser || "Admin").replace(/[^a-zA-Z0-9]/g, '_');
                    if(data.userData && data.userData[userKey]) {
                        store.notes = data.userData[userKey].notes || '';
                        store.events = data.userData[userKey].events || {};
                    } else {
                        store.notes = ''; store.events = {};
                    }
                    updateDashboardUI();
                    updateUIForUser();
                    renderCalendar();
                    renderKanbanBoard();
               }
            });
        }

        function updateUIForUser() {
            const badge = document.getElementById('dashboard-owner-badge');
            const greeting = document.getElementById('greeting');
            const hint = document.getElementById('view-mode-hint');
            const avatarContainer = document.getElementById('header-avatar');
            const adminTools = document.querySelectorAll('.admin-only');

            const name = store.currentUser || "Admin";
            badge.textContent = `${name}'s Workspace`;
            badge.classList.remove('hidden');
            greeting.textContent = `Hello, ${name}.`;
            hint.textContent = store.currentUser ? "Private View" : "Admin View";

            if (!store.currentUser) adminTools.forEach(el => el.classList.remove('hidden-tool'));
            else adminTools.forEach(el => el.classList.add('hidden-tool'));

            if (store.avatars[name]) {
                avatarContainer.innerHTML = `<img src="${store.avatars[name]}" class="w-full h-full object-cover">`;
            } else {
                const iconClass = store.currentUser ? "fa-user" : "fa-user-shield";
                avatarContainer.innerHTML = `<i class="fas ${iconClass} text-white/50 text-2xl"></i>`;
            }
            avatarContainer.innerHTML += `<div class="avatar-overlay absolute inset-0 bg-black/50 rounded-full flex items-center justify-center opacity-0 transition"><i class="fas fa-camera text-xs text-white"></i></div>`;
            avatarContainer.onclick = () => triggerAvatarUpload(name);

            // Handle Admin Secure Channel Visibility
            const viewer = document.getElementById('admin-message-viewer');
            const sender = document.getElementById('member-message-sender');
            const title = document.getElementById('admin-channel-title');
            const replyBox = document.getElementById('admin-reply-display');

            if (!store.currentUser) {
                viewer.classList.remove('hidden');
                sender.classList.add('hidden');
                title.textContent = "Admin Mailbox";
                renderAdminMailbox();
            } else {
                viewer.classList.add('hidden');
                sender.classList.remove('hidden');
                title.textContent = "Message to Admin";
                
                const data = store.adminMessages[store.currentUser] || {};
                document.getElementById('admin-msg-input').value = data.msg || '';
                
                if (data.reply) {
                    replyBox.classList.remove('hidden');
                    document.getElementById('reply-text').textContent = data.reply;
                } else {
                    replyBox.classList.add('hidden');
                }
            }
        }

        function renderAdminMailbox() {
            const viewer = document.getElementById('admin-message-viewer');
            viewer.innerHTML = '';
            let hasMessages = false;

            for (const sender in store.adminMessages) {
                const data = store.adminMessages[sender];
                if (data && data.msg) {
                    hasMessages = true;
                    const msgDiv = document.createElement('div');
                    msgDiv.className = "bg-white dark:bg-slate-800 p-2 rounded-lg border border-amber-200 dark:border-amber-900 shadow-sm relative group";
                    msgDiv.innerHTML = `
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-[10px] font-black text-amber-600 uppercase tracking-tighter">${sender}</span>
                            <div class="flex gap-2 opacity-0 group-hover:opacity-100 transition">
                                <button onclick="resolveAdminMessage('${sender}')" class="text-green-500 hover:text-green-700" title="Resolve & Remove"><i class="fas fa-check-circle text-[9px]"></i></button>
                                <button onclick="replyToMember('${sender}')" class="text-blue-500 hover:text-blue-700" title="Reply"><i class="fas fa-reply text-[9px]"></i></button>
                                <button onclick="clearAdminMessage('${sender}')" class="text-red-400 hover:text-red-600" title="Clear All"><i class="fas fa-trash-alt text-[9px]"></i></button>
                            </div>
                        </div>
                        <p class="text-xs text-slate-600 dark:text-slate-300 italic mb-1">"${data.msg}"</p>
                        ${data.reply ? `<div class="mt-1 pt-1 border-t border-slate-100 dark:border-slate-700 text-[9px] text-blue-500 font-bold">REPLIED: "${data.reply}"</div>` : ''}
                    `;
                    viewer.appendChild(msgDiv);
                }
            }
            if (!hasMessages) viewer.innerHTML = `<p class="text-[10px] text-slate-400 italic text-center mt-4">No messages from team.</p>`;
        }

        // Logic Change: This now deletes the message immediately upon "Resolution"
        function resolveAdminMessage(sender) {
            if (confirm(`Resolve and remove message from ${sender}?`)) {
                delete store.adminMessages[sender];
                pushToCloud();
            }
        }

        function sendAdminMessage() {
            const val = document.getElementById('admin-msg-input').value.trim();
            if (!store.currentUser) return;
            const existingData = store.adminMessages[store.currentUser] || {};
            store.adminMessages[store.currentUser] = { ...existingData, msg: val };
            pushToCloud();
            alert("Message sent to Admin secure cloud.");
        }

        function replyToMember(sender) {
            const existing = store.adminMessages[sender] || {};
            const reply = prompt(`Reply to ${sender}:`, existing.reply || "");
            if (reply !== null) {
                store.adminMessages[sender] = { ...existing, reply: reply.trim() };
                pushToCloud();
            }
        }

        function clearAdminMessage(sender) {
            if (confirm(`Clear all data for ${sender}?`)) {
                delete store.adminMessages[sender];
                pushToCloud();
            }
        }

        function updateDashboardUI() {
            document.getElementById('notepad').value = store.notes;
            renderQuickTasks(); 
        }

        function triggerAvatarUpload(username) {
            uploadingUser = username;
            document.getElementById('avatar-upload').click();
        }

        function handleAvatarFile(input) {
            if (input.files && input.files[0] && uploadingUser) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    if(e.target.result.length > 700000) return alert("Image too large (>500KB).");
                    store.avatars[uploadingUser] = e.target.result;
                    pushToCloud();
                }
                reader.readAsDataURL(input.files[0]);
            }
            input.value = '';
        }

        function saveNotes(val) {
            store.notes = val;
            saveUserDataToCloud();
            document.getElementById('notes-status').textContent = 'Saved';
        }

        function saveFocus(val) { store.focus = val; saveUserDataToCloud(); }

        // CALENDAR LOGIC
        function changeMonth(delta) {
            store.calendarMonth += delta;
            if(store.calendarMonth > 11) { store.calendarMonth = 0; store.calendarYear++; }
            if(store.calendarMonth < 0) { store.calendarMonth = 11; store.calendarYear--; }
            renderCalendar();
        }

        function parseEventData(evt) {
            if (typeof evt === 'string') {
                try { return JSON.parse(evt); } 
                catch (e) { return { time: '', text: evt, urgency: 'low' }; }
            }
            return evt;
        }

        function renderCalendar() {
            const months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
            document.getElementById('calendar-month-year').textContent = `${months[store.calendarMonth]} ${store.calendarYear}`;
            const firstDay = new Date(store.calendarYear, store.calendarMonth, 1).getDay();
            const daysInMonth = new Date(store.calendarYear, store.calendarMonth + 1, 0).getDate();
            const grid = document.getElementById('calendar-body');
            grid.innerHTML = '';
            for(let i=0; i<firstDay; i++) grid.innerHTML += `<div class="bg-slate-50/50 dark:bg-slate-800/50 border-r border-b border-slate-200 dark:border-slate-700"></div>`;
            for(let d=1; d<=daysInMonth; d++) {
                const dateKey = `${store.calendarYear}-${String(store.calendarMonth+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                const el = document.createElement('div');
                el.className = `calendar-day ${new Date().getDate() === d && new Date().getMonth() === store.calendarMonth ? 'today' : ''}`;
                el.innerHTML = `<div class="calendar-day-number">${d}</div>`;
                const events = store.events[dateKey] || [];
                events.forEach((evt, idx) => {
                    const data = parseEventData(evt);
                    const eDiv = document.createElement('div');
                    eDiv.className = `cal-event-item cal-urgency-${data.urgency || 'low'}`;
                    eDiv.innerHTML = `${data.time ? `<span class="cal-time">${data.time}</span>` : ''}<span>${data.text}</span>`;
                    el.appendChild(eDiv);
                });
                const criticalTasks = store.kanbanTasks.filter(t => t.assignedDate === dateKey && t.priority >= 4 && t.status !== 'done' && (!store.currentUser || t.assignee === store.currentUser));
                criticalTasks.forEach(task => {
                    const tDiv = document.createElement('div');
                    tDiv.className = `cal-event-item cal-task-critical`;
                    const label = store.currentUser ? "TASK" : `TASK (${task.assignee || '?'})`;
                    tDiv.innerHTML = `<span class="cal-time text-orange-500"><i class="fas fa-bolt"></i> ${label}</span><span>${task.title}</span>`;
                    tDiv.onclick = (e) => { e.stopPropagation(); openTaskModal(task.id); };
                    el.appendChild(tDiv);
                });
                el.onclick = () => openCalendarModal(dateKey);
                grid.appendChild(el);
            }
        }

        function openCalendarModal(dateStr) {
            const modal = document.getElementById('calendar-modal');
            modal.classList.remove('hidden');
            document.getElementById('cal-date-title').textContent = new Date(dateStr).toDateString();
            document.getElementById('cal-date-val').value = dateStr;
            document.getElementById('evt-start-date').value = dateStr;
            document.getElementById('evt-end-date').value = dateStr;
            cancelEditMode();
            renderDayEvents(dateStr);
        }

        function renderDayEvents(dateStr) {
            const list = document.getElementById('day-events-list');
            list.innerHTML = '';
            const events = store.events[dateStr] || [];
            events.forEach((evt, idx) => {
                const data = parseEventData(evt);
                const item = document.createElement('div');
                item.className = `flex justify-between items-center bg-white dark:bg-slate-600 p-2 rounded text-xs border-l-4 border-purple-500 shadow-sm mb-2`;
                item.innerHTML = `<div class="flex-1"><b>${data.time || ''}</b> ${data.text}</div><div class="flex gap-2 ml-2"><button onclick="initEditEvent('${dateStr}', ${idx})" class="text-amber-500"><i class="fas fa-edit"></i></button><button onclick="deleteEvent('${dateStr}', ${idx})" class="text-red-400"><i class="fas fa-trash"></i></button></div>`;
                list.appendChild(item);
            });
            const tasks = store.kanbanTasks.filter(t => t.assignedDate === dateStr && t.priority >= 4);
            tasks.forEach(task => {
                const item = document.createElement('div');
                item.className = `flex justify-between items-center bg-orange-50 dark:bg-orange-900/30 p-2 rounded text-xs border-l-4 border-orange-500 shadow-sm mb-2`;
                const label = store.currentUser ? `[${task.status.toUpperCase()}]` : `[${task.status.toUpperCase()}] (${task.assignee || '?'})`;
                item.innerHTML = `<div class="flex-1"><i class="fas fa-bolt mr-1"></i> ${label} ${task.title}</div><button onclick="openTaskModal('${task.id}')" class="text-orange-500 ml-2"><i class="fas fa-external-link-alt"></i></button>`;
                list.appendChild(item);
            });
            if(events.length === 0 && tasks.length === 0) list.innerHTML = '<p class="text-xs text-center p-2 text-slate-400">No scheduled items today.</p>';
        }

        function addEvent() {
            const val = document.getElementById('new-event-input').value.trim();
            if (!val) return;
            const startDayStr = document.getElementById('evt-start-date').value;
            const endDayStr = document.getElementById('evt-end-date').value;
            if(!startDayStr || !endDayStr) return alert("Please select start and end dates.");
            const start = document.getElementById('new-event-start').value;
            const end = document.getElementById('new-event-end').value;
            const urgency = document.getElementById('new-event-urgency').value;
            const timeStr = start ? (end ? `${start} - ${end}` : start) : "";
            const eventPayload = JSON.stringify({ text: val, time: timeStr, urgency: urgency });
            if (editingEventIdx !== null) {
                const dateKey = document.getElementById('cal-date-val').value;
                store.events[dateKey][editingEventIdx] = eventPayload;
            } else {
                let curr = new Date(startDayStr);
                const stop = new Date(endDayStr);
                while(curr <= stop) {
                    const dateKey = curr.toISOString().split('T')[0];
                    if (!store.events[dateKey]) store.events[dateKey] = [];
                    store.events[dateKey].push(eventPayload);
                    curr.setDate(curr.getDate() + 1);
                }
            }
            saveUserDataToCloud();
            cancelEditMode();
            renderDayEvents(document.getElementById('cal-date-val').value);
            renderCalendar();
        }

        function deleteEvent(date, idx) {
            store.events[date].splice(idx, 1);
            saveUserDataToCloud();
            renderDayEvents(date);
            renderCalendar();
        }

        function resolveEvent(d, i) { deleteEvent(d, i); }
        function setCalUrgency(l) { 
            document.getElementById('new-event-urgency').value = l; 
            ['low', 'medium', 'high'].forEach(u => {
                const btn = document.getElementById(`btn-urgency-${u}`);
                if(btn) { btn.classList.replace('bg-green-100', 'bg-green-50'); btn.style.borderWidth = '1px'; }
            });
            const btn = document.getElementById(`btn-urgency-${l}`);
            if(btn) btn.style.borderWidth = '2px';
        }

        function updateEventUrgency(d, i, u) { 
            const data = parseEventData(store.events[d][i]); 
            data.urgency = u; store.events[d][i] = JSON.stringify(data); 
            saveUserDataToCloud(); renderCalendar();
        }

        function initEditEvent(dateStr, idx) {
            editingEventIdx = idx;
            const data = parseEventData(store.events[dateStr][idx]);
            document.getElementById('new-event-input').value = data.text;
            document.getElementById('new-event-urgency').value = data.urgency || 'low';
            setCalUrgency(data.urgency || 'low');
            if (data.time && data.time.includes(' - ')) {
                const parts = data.time.split(' - ');
                document.getElementById('new-event-start').value = parts[0];
                document.getElementById('new-event-end').value = parts[1];
            } else {
                document.getElementById('new-event-start').value = data.time || '';
                document.getElementById('new-event-end').value = '';
            }
            document.getElementById('btn-cancel-edit').classList.remove('hidden');
            document.getElementById('btn-add-icon').className = 'fas fa-check';
            document.getElementById('btn-add-event').classList.replace('bg-green-500', 'bg-blue-500');
        }

        function cancelEditMode() { 
            editingEventIdx = null;
            document.getElementById('new-event-input').value = ''; 
            document.getElementById('new-event-start').value = ''; 
            document.getElementById('new-event-end').value = ''; 
            document.getElementById('btn-cancel-edit').classList.add('hidden');
            document.getElementById('btn-add-icon').className = 'fas fa-plus';
            document.getElementById('btn-add-event').classList.replace('bg-blue-500', 'bg-green-500');
        }

        // KANBAN & TASKS
        function addQuickTask() {
            const val = document.getElementById('quick-task-input').value.trim();
            if(val) {
                store.kanbanTasks.push({ id: Date.now().toString(), title: val, status: document.getElementById('quick-task-status').value, assignee: document.getElementById('quick-task-assignee').value || store.currentUser || "Unassigned", assignedDate: document.getElementById('quick-task-date').value || "", priority: 1, lastMoved: Date.now(), log: { inprogress: 0 }, isPaused: false });
                pushToCloud();
                document.getElementById('quick-task-input').value = '';
                document.getElementById('quick-task-date').value = '';
            }
        }

        function updateTaskStatus(id, newStatus) {
            const t = store.kanbanTasks.find(x => x.id === id);
            if(!t || t.status === newStatus) return;
            const now = Date.now();
            if (t.status === 'inprogress' && !t.isPaused) t.log.inprogress = (t.log.inprogress || 0) + Math.floor((now - t.lastMoved) / 1000);
            t.status = newStatus; t.lastMoved = now; t.isPaused = false;
            pushToCloud();
        }

        function toggleTaskPause(id) {
            const t = store.kanbanTasks.find(x => x.id === id);
            if (!t || t.status !== 'inprogress') return;
            const now = Date.now();
            if (t.isPaused) { t.isPaused = false; t.lastMoved = now; }
            else { t.log.inprogress = (t.log.inprogress || 0) + Math.floor((now - t.lastMoved) / 1000); t.isPaused = true; }
            pushToCloud();
        }

        function updateTaskDate(id, d) { const t = store.kanbanTasks.find(x => x.id === id); t.assignedDate = d; pushToCloud(); }
        function updateTaskPriority(id, p) { const t = store.kanbanTasks.find(x => x.id === id); t.priority = parseInt(p); pushToCloud(); }
        function deleteQuickTask(id) { if(confirm('Delete?')) { store.kanbanTasks = store.kanbanTasks.filter(x => x.id !== id); pushToCloud(); } }

        function saveTask() {
            const id = document.getElementById('task-id').value;
            const data = { title: document.getElementById('task-title').value, description: document.getElementById('task-desc').value, assignee: document.getElementById('task-assignee').value, priority: parseInt(document.getElementById('task-priority').value), assignedDate: document.getElementById('task-date').value };
            if(id) Object.assign(store.kanbanTasks.find(x => x.id === id), data);
            else store.kanbanTasks.push({ id: Date.now().toString(), ...data, status: 'todo', lastMoved: Date.now(), log: { inprogress: 0 } });
            pushToCloud(); closeModal('task-modal');
        }

        function deleteCurrentTask() { deleteQuickTask(document.getElementById('task-id').value); closeModal('task-modal'); }

        // RENDER HELPERS
        function renderTeamList() {
            const list = document.getElementById('team-list');
            document.getElementById('member-count').textContent = store.users.length;
            list.innerHTML = '';
            document.getElementById('task-assignee').innerHTML = '<option value="">Unassigned</option>';
            document.getElementById('quick-task-assignee').innerHTML = '<option value="">Assign to...</option>';
            store.users.forEach((u, i) => {
                const li = document.createElement('li');
                li.className = 'flex justify-between items-center text-sm text-white/80 bg-white/5 px-2 py-1 rounded hover:bg-white/10 group';
                const avatar = store.avatars[u] ? `<div class="w-5 h-5 rounded-full bg-cover" style="background-image:url('${store.avatars[u]}')"></div>` : `<div class="w-5 h-5 rounded-full bg-purple-500 text-center text-[10px]">${u[0]}</div>`;
                const resetBtn = !store.currentUser ? `<button onclick="resetMemberPassword('${u}')" class="text-amber-400 hover:text-white ml-auto mr-2 opacity-0 group-hover:opacity-100" title="Reset Password to default"><i class="fas fa-undo-alt"></i></button>` : '';
                const removeBtn = !store.currentUser ? `<button onclick="removeMember(${i})" class="text-red-400 hover:text-white opacity-0 group-hover:opacity-100"><i class="fas fa-times"></i></button>` : '';
                li.innerHTML = `<div class="flex items-center gap-2 cursor-pointer avatar-container relative" onclick="triggerAvatarUpload('${u}')">${avatar} <span>${u}</span></div>${resetBtn} ${removeBtn}`;
                list.appendChild(li);
                document.getElementById('task-assignee').add(new Option(u, u));
                document.getElementById('quick-task-assignee').add(new Option(u, u));
            });
        }

        function createCardHTML(t) {
            const inProgTime = t.log ? t.log.inprogress || 0 : 0;
            let timerStr = formatTime(inProgTime);
            if(t.status === 'inprogress' && !t.isPaused) timerStr = formatTime(inProgTime + Math.floor((Date.now() - t.lastMoved)/1000));
            return `<div class="border-l-4 ${t.status === 'done' ? 'border-green-500 opacity-60' : t.status === 'inprogress' ? 'border-purple-500' : 'border-slate-300'} pl-2"><div class="flex justify-between items-start"><h4 class="font-bold text-sm truncate">${t.title}</h4><button onclick="openTaskModal('${t.id}')" class="text-slate-300 hover:text-purple-500"><i class="fas fa-pen text-xs"></i></button></div><div class="flex justify-between items-end mt-2"><span class="text-[10px] bg-purple-100 dark:bg-purple-900 px-2 rounded-full">${t.assignee || 'Unassigned'}</span><div class="text-[10px] ${t.status === 'inprogress' ? 'text-purple-500 font-bold' : 'text-slate-400'}"><i class="fas fa-stopwatch mr-1"></i>${timerStr}</div></div></div>`;
        }

        function renderKanbanBoard() {
            // Visibility Toggle
            const statusView = document.getElementById('kanban-status-view');
            const weekView = document.getElementById('kanban-week-view');
            const badge = document.getElementById('tracker-badge');
            const subtitle = document.getElementById('tracker-subtitle');

            if (store.kanbanMode === 'status') {
                statusView.classList.remove('hidden');
                weekView.classList.add('hidden');
                badge.textContent = "Status View";
                subtitle.textContent = "Manage project progress";

                ['todo', 'inprogress', 'done'].forEach(s => {
                    const container = document.querySelector(`[ondrop="drop(event, '${s}', 'status')"]`);
                    if(!container) return;
                    container.innerHTML = '';
                    const tasks = store.kanbanTasks.filter(t => t.status === s && (!store.currentUser || t.assignee === store.currentUser));
                    const countBadge = document.getElementById(`count-${s}`);
                    if(countBadge) countBadge.textContent = tasks.length;
                    tasks.forEach(t => {
                        const el = document.createElement('div');
                        el.className = 'task-card bg-white dark:bg-slate-800 p-3 rounded-lg shadow-sm border border-slate-200 dark:border-slate-700 hover:shadow-md transition group relative';
                        el.draggable = true; el.ondragstart = (e) => window.dragStart(e, t.id);
                        el.innerHTML = createCardHTML(t);
                        container.appendChild(el);
                    });
                });
            } else {
                statusView.classList.add('hidden');
                weekView.classList.remove('hidden');
                badge.textContent = "Week View";
                subtitle.textContent = "Scheduled task timeline";
                renderWeekView();
            }
            renderQuickTasks();
        }

        function renderWeekView() {
            const container = document.getElementById('week-columns-container');
            const rangeDisplay = document.getElementById('week-view-date-range');
            container.innerHTML = '';
            
            const start = new Date(store.weekViewStart);
            const end = new Date(start);
            end.setDate(start.getDate() + 6);
            rangeDisplay.textContent = `${start.toLocaleDateString()} - ${end.toLocaleDateString()}`;

            const days = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];

            for (let i = 0; i < 7; i++) {
                const currentDay = new Date(start);
                currentDay.setDate(start.getDate() + i);
                const dateKey = currentDay.toISOString().split('T')[0];
                const isToday = new Date().toISOString().split('T')[0] === dateKey;

                const col = document.createElement('div');
                col.className = `glass-panel rounded-xl flex flex-col h-full border-t-4 ${isToday ? 'border-jokerGreen' : 'border-purple-600/30'}`;
                
                col.innerHTML = `
                    <div class="p-3 border-b border-slate-200 dark:border-slate-700 bg-white/50 dark:bg-slate-800/50">
                        <h3 class="font-bold text-xs ${isToday ? 'text-jokerGreen' : 'text-slate-500'}">${days[currentDay.getDay()]}</h3>
                        <p class="text-[10px] opacity-60">${currentDay.toLocaleDateString(undefined, {month:'short', day:'numeric'})}</p>
                    </div>
                    <div class="column-body p-2 flex-1 overflow-y-auto space-y-3" ondrop="drop(event, '${dateKey}', 'date')" ondragover="allowDrop(event)"></div>
                `;

                const body = col.querySelector('.column-body');
                const tasks = store.kanbanTasks.filter(t => t.assignedDate === dateKey && (!store.currentUser || t.assignee === store.currentUser));
                
                tasks.forEach(t => {
                    const el = document.createElement('div');
                    el.className = 'task-card bg-white dark:bg-slate-800 p-2 rounded-lg shadow-sm border border-slate-200 dark:border-slate-700 hover:shadow-md transition text-xs';
                    el.draggable = true; el.ondragstart = (e) => window.dragStart(e, t.id);
                    el.innerHTML = `
                        <div class="flex justify-between items-start gap-1">
                            <span class="font-bold truncate">${t.title}</span>
                            <span class="text-[8px] px-1 rounded ${t.status === 'done' ? 'bg-green-500/20 text-green-500' : 'bg-purple-500/20 text-purple-400'}">${t.status[0].toUpperCase()}</span>
                        </div>
                        <div class="flex justify-between mt-2 opacity-60">
                             <span>${t.assignee || 'Any'}</span>
                             <span>${formatTime(t.log.inprogress)}</span>
                        </div>
                    `;
                    body.appendChild(el);
                });

                container.appendChild(col);
            }
        }

        function renderQuickTasks() {
            const list = document.getElementById('quick-task-list'); 
            if(!list) return;
            list.innerHTML = '';
            store.kanbanTasks.filter(t => t.status !== 'done' && (!store.currentUser || t.assignee === store.currentUser))
            .forEach(t => {
                const li = document.createElement('li');
                li.className = 'flex flex-col p-3 bg-white dark:bg-slate-800 rounded-xl border border-slate-100 dark:border-slate-700 shadow-sm transition hover:border-purple-300';
                const statusColors = { 'todo': 'bg-slate-100 text-slate-600 dark:bg-slate-700 dark:text-slate-400', 'inprogress': 'bg-purple-100 text-purple-600 dark:bg-purple-900/40 dark:text-purple-300' };
                li.innerHTML = `<div class="flex items-center justify-between mb-2"><span class="truncate font-bold text-slate-700 dark:text-slate-200">${t.title}</span><div class="flex gap-2 shrink-0 ml-2"><button onclick="updateTaskStatus('${t.id}', 'done')" class="w-6 h-6 flex items-center justify-center rounded-full bg-green-100 text-green-600 hover:bg-green-600 hover:text-white transition" title="Complete"><i class="fas fa-check text-[10px]"></i></button><button onclick="deleteQuickTask('${t.id}')" class="w-6 h-6 flex items-center justify-center rounded-full bg-slate-100 text-slate-400 hover:bg-red-500 hover:text-white transition" title="Delete"><i class="fas fa-trash text-[10px]"></i></button></div></div><div class="flex wrap items-center justify-between gap-y-2"><div class="flex items-center gap-2"><span class="text-[9px] px-2 py-0.5 rounded-full font-bold uppercase tracking-wider ${statusColors[t.status]}">${t.status === 'inprogress' ? 'Doing' : 'To Do'}</span><span class="text-[9px] text-slate-400 flex items-center gap-1 font-medium"><i class="fas fa-calendar-alt"></i> ${t.assignedDate || 'No Date'}</span></div><div class="flex items-center gap-1 text-[9px] font-bold text-purple-600 dark:text-purple-300 bg-purple-50 dark:bg-purple-900/40 px-2 py-0.5 rounded-full border border-purple-100 dark:border-purple-800/50"><i class="fas fa-user-circle"></i> ${t.assignee || 'Unassigned'}</div></div>`;
                list.appendChild(li);
            });
        }

        // UTILS
        function formatTime(s) { const h = Math.floor(s/3600), m = Math.floor((s%3600)/60); return h>0 ? `${h}h ${m}m` : `${m}m ${s%60}s`; }
        function updateClock() { const n = new Date(); document.getElementById('clock').textContent = n.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', hourCycle:'h23'}); document.getElementById('date').textContent = n.toLocaleDateString(undefined, {weekday:'long', month:'long', day:'numeric'}); }
        function updateKanbanTimers() { if(store.kanbanMode === 'status') renderKanbanBoard(); }
        function loadTheme() { document.body.classList.toggle('dark', store.theme === 'dark'); document.getElementById('theme-icon').className = store.theme === 'dark' ? 'fas fa-sun' : 'fas fa-moon'; document.body.style.background = store.theme === 'dark' ? 'linear-gradient(135deg, #10002b, #004b23)' : 'linear-gradient(135deg, #9d4edd, #70e000)'; }
        function toggleTheme() { store.theme = store.theme === 'light' ? 'dark' : 'light'; localStorage.setItem('nexus_theme', store.theme); loadTheme(); }
        function switchView(v) { ['dashboard', 'kanban'].forEach(x => { const view = document.getElementById(`view-${x}`); const nav = document.getElementById(`nav-${x}`); if(view) view.classList.add('hidden'); if(nav) nav.classList.remove('active'); }); const targetView = document.getElementById(`view-${v}`); const targetNav = document.getElementById(`nav-${v}`); if(targetView) targetView.classList.remove('hidden'); if(targetNav) targetNav.classList.add('active'); if(v === 'kanban') renderKanbanBoard(); }
        function openTaskModal(id) { document.getElementById('task-modal').classList.remove('hidden'); const t = store.kanbanTasks.find(x => x.id === id) || {title:'', description:'', assignee:'', priority:1, assignedDate:''}; document.getElementById('task-id').value = id || ''; document.getElementById('task-title').value = t.title; document.getElementById('task-desc').value = t.description; document.getElementById('task-assignee').value = t.assignee || (store.currentUser || ''); document.getElementById('task-date').value = t.assignedDate || ''; setPriority(t.priority); document.getElementById('btn-delete').classList.toggle('hidden', !id); }
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
        function setPriority(v) { document.getElementById('task-priority').value = v; document.querySelectorAll('.flag-btn').forEach((f, i) => f.classList.toggle('active', i < v)); }
        function addMember() { const n = document.getElementById('new-member-name').value.trim(); if(n && !store.users.includes(n)) { store.users.push(n); pushToCloud(); document.getElementById('new-member-name').value=''; } }
        function removeMember(i) { if(confirm('Remove?')) { store.users.splice(i, 1); pushToCloud(); } }
        function clearFilters() { document.getElementById('date-range-picker')._flatpickr.clear(); renderKanbanBoard(); }
        
        function switchKanbanView(m) { 
            store.kanbanMode = m; 
            document.querySelectorAll('.view-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`btn-view-${m}`).classList.add('active');
            renderKanbanBoard(); 
        }

        function changeWeek(d) { store.weekViewStart.setDate(store.weekViewStart.getDate() + (d*7)); renderKanbanBoard(); }
        function jumpToWeek(d) { store.weekViewStart = d; renderKanbanBoard(); }
        function clearAllData() { if(confirm('Nuke everything?')) { db.ref('projectData').remove(); location.reload(); } }
        function backupData() { const blob = new Blob([JSON.stringify(store)], {type:'application/json'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download='backup.json'; a.click(); }
        function triggerRestore() { alert('Restore disabled in cloud mode.'); }
        function handleRestore() {}
    </script>
</body>
</html>